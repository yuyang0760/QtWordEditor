# QtWordEditor 功能实现记录

---

## 2026-02-20

### 18:10:00 - 控制台乱码问题二次修复完成

**问题描述**：
- 第一次修复后，控制台中文仍然存在乱码问题
- qDebug() 在 Windows 上的编码处理仍然有问题

**修复内容**：

1. **修改 Logger.cpp** (`d:\vscodeproject\QtWordEditor\src\core\utils\Logger.cpp`)
   - 完全重写了日志输出方法，不再使用 qDebug()/qInfo() 等
   - 改用 `std::cout` 和 `std::cerr` 直接输出
   - 使用 `QString::toStdString()` 转换为标准字符串
   - 修改了 `debug(const char*)` 方法，使用 `QString::fromUtf8()` 而非 `fromLatin1()`

2. **修改 main.cpp** (`d:\vscodeproject\QtWordEditor\src\app\main.cpp`)
   - 同时设置 `SetConsoleOutputCP(CP_UTF8)` 和 `SetConsoleCP(CP_UTF8)`
   - 确保输入和输出都使用 UTF-8 编码

**编译验证**：
- 使用 MinGW + Ninja 工具链
- CMake 配置成功
- 编译成功，无错误
- 可执行文件 `QtWordEditor.exe` 成功生成

**预期收益**：
- 控制台输出中文完全正常，不再乱码
- 使用标准 C++ 流输出，编码处理更稳定
- 跨平台兼容性更好

---

### 18:00:00 - 控制台乱码问题修复完成

**问题描述**：
- Windows 控制台输出中文时出现乱码
- 例如：`[DEBUG] "  æ\u0097 é\u0080\u0089å\u008Cºï¼\u008Cå·¥å\u0085·æ \u008Fæ\u0098¾ç¤ºä¸\u0080è\u0087´æ ·å¼\u008F"

**修复内容**：

1. **修改 main.cpp** (`d:\vscodeproject\QtWordEditor\src\app\main.cpp`)
   - 添加了 `#include <windows.h>` 头文件（仅限 Windows）
   - 在 main() 函数开头添加了 `SetConsoleOutputCP(CP_UTF8)`
   - 设置 Windows 控制台编码为 UTF-8，解决中文乱码问题

2. **修改 Logger.cpp** (`d:\vscodeproject\QtWordEditor\src\core\utils\Logger.cpp`)
   - 所有日志方法（debug、info、warning、error）都添加了 `.noquote()`
   - 避免输出内容被额外的引号包围
   - 使输出更清晰易读

**编译验证**：
- 使用 MinGW + Ninja 工具链
- CMake 配置成功
- 编译成功，无错误
- 可执行文件 `QtWordEditor.exe` 成功生成

**预期收益**：
- 控制台输出中文不再乱码
- 日志输出更加清晰易读
- 调试信息可以正常显示中文内容

---

### 17:30:00 - 段前和段后间距常量设置完成

**修改内容**：

1. **修改 Constants.h** (`d:\vscodeproject\QtWordEditor\include\core\utils\Constants.h`)
   - 添加了 "段落样式相关常量" 节
   - 新增 `DEFAULT_SPACE_BEFORE` 常量，值为 6.0
   - 新增 `DEFAULT_SPACE_AFTER` 常量，值为 6.0

2. **修改 ParagraphStyle.cpp** (`d:\vscodeproject\QtWordEditor\src\core\document\ParagraphStyle.cpp`)
   - 添加了 `#include "core/utils/Constants.h"`
   - 修改 `ParagraphStyleData` 构造函数，使用常量作为默认值
   - 修改 `clearProperty()` 方法，清除属性时恢复为常量默认值

3. **修改 DocumentScene.cpp** (`d:\vscodeproject\QtWordEditor\src\graphics\scene\DocumentScene.cpp`)
   - 添加了 `#include "core/document/ParagraphStyle.h"`
   - 修改 `rebuildFromDocument()` 方法中的位置计算逻辑
   - 修改 `updateBlockPositions()` 方法中的位置计算逻辑
   - **新功能**：在计算块位置时考虑段前和段后间距
     - 段前间距：只在第一个块之后的块应用
     - 段后间距：在每个块的高度之后应用
     - 这样段落之间会有合适的间距

**编译验证**：
- 使用 MinGW + Ninja 工具链
- CMake 配置成功
- 编译成功，无错误
- 可执行文件 `QtWordEditor.exe` 成功生成

**预期收益**：
- 统一管理默认段前和段后间距
- 段落之间有合适的间距，提高可读性
- 修改默认间距只需修改常量值，无需多处修改代码
- 布局更美观，符合常规文字处理软件的行为

---

### 17:00:00 - 段落重叠问题修复完成

**问题描述**：
- 当一段文本自动换行后，下面的段落没有相应往下移动
- 段落之间出现位置重叠现象
- 原因：DocumentScene 中使用固定高度(30px)排列文本块，未考虑文本块实际高度的变化

**修复内容**：

1. **修改 DocumentScene.h** (`d:\vscodeproject\QtWordEditor\include\graphics\scene\DocumentScene.h`)
   - 添加了新方法 `updateBlockPositions()` 的声明
   - 该方法用于重新计算所有文本块的位置

2. **修改 DocumentScene.cpp** (`d:\vscodeproject\QtWordEditor\src\graphics\scene\DocumentScene.cpp`)
   - **修改 rebuildFromDocument() 方法**：
     - 先收集所有文本块项，再统一计算位置
     - 不再使用固定的 30px 高度
     - 根据每个文本块的实际 boundingRect().height() 来计算位置
     - 下一个块从当前块的底部开始排列

   - **新增 updateBlockPositions() 方法**：
     - 遍历文档中的所有节和页面
     - 收集每个页面的文本块项
     - 根据每个块的实际高度重新计算位置
     - 确保段落之间正确排列，不重叠

   - **修改 updateSingleTextItem() 方法**：
     - 在更新单个块后调用 updateBlockPositions()
     - 确保当一个块高度变化时，后续的块都能正确调整位置

   - **修改 updateAllTextItems() 方法**：
     - 在更新所有块后调用 updateBlockPositions()
     - 确保所有块更新后重新计算位置

3. **修复 TextBlockItem.cpp 中的语法错误** (`d:\vscodeproject\QtWordEditor\src\graphics\items\TextBlockItem.cpp`)
   - 修复了 for 循环缺少闭合 '}' 的问题
   - 添加了缺失的 `</span>` 标签闭合

**编译验证**：
- 使用 MinGW + Ninja 工具链
- CMake 配置成功
- 编译成功，无错误
- 可执行文件 `QtWordEditor.exe` 成功生成

**预期收益**：
- 解决段落重叠问题：段落现在会根据前一段的实际高度正确排列
- 提高布局的动态性：文本块高度变化时，后续块自动调整位置
- 提升用户体验：避免视觉上的段落重叠
- 代码可维护性提升：新增的 updateBlockPositions() 方法集中处理位置计算

---

   - 在 `ParagraphBlock.cpp` 中实现了该方法
   - 该方法统一处理位置和长度的边界检查和归一化
   - 返回值：true=参数有效，false=参数无效

2. **简化 setStyle() 方法**
   - 使用 `validatePositionAndLength()` 替换了重复的边界检查代码
   - 替换了所有 `qDebug()` 调用为 `LOG_DEBUG` 宏
   - 使用 `QString::arg()` 格式化调试信息
   - 保持了原有的所有功能不变

3. **简化 remove() 方法**
   - 使用 `validatePositionAndLength()` 替换了重复的边界检查代码
   - 移除了注释掉的 `QDebug()` 调用
   - 保持了原有的所有功能不变

4. **添加 Logger 头文件引用**
   - 在 `ParagraphBlock.cpp` 中添加了 `#include "core/utils/Logger.h"`

**编译验证**：
- 使用 MinGW + Ninja 工具链
- CMake 配置成功
- 编译成功，无错误
- 可执行文件 `QtWordEditor.exe` 成功生成

**预期收益**：
- 减少代码重复：消除了 setStyle() 和 remove() 方法中相同的边界检查逻辑
- 统一验证逻辑：所有方法使用相同的参数验证规则
- 提高可维护性：未来修改验证规则只需修改一处
- 性能优化：调试输出在 Release 模式下完全消除
- 代码可读性提升：使用统一的日志系统

---

### 15:30:00 - 第三阶段：日志系统优化完成

**优化内容**：
1. **创建统一的 Logger 类**
   - `Logger.h` (`d:\vscodeproject\QtWordEditor\include\core\utils\Logger.h`)
     - 定义了 LogLevel 枚举（Debug, Info, Warning, Error）
     - 提供了静态方法：debug(), info(), warning(), error()
     - 提供了便捷宏：LOG_DEBUG, LOG_INFO, LOG_WARNING, LOG_ERROR
     - 支持启用/禁用调试输出
   - `Logger.cpp` (`d:\vscodeproject\QtWordEditor\src\core\utils\Logger.cpp`)
     - 实现了所有 Logger 类的功能
     - 调试输出仅在 QT_DEBUG 模式下编译
     - 日志输出带有前缀标识（[DEBUG], [INFO], [WARNING], [ERROR]）

2. **替换 MainWindow.cpp 中的 qDebug() 调用**
   - 共替换了 16 处 qDebug() 调用
   - 使用 LOG_DEBUG 宏替代
   - 所有调试信息现在都通过统一的日志系统输出
   - 便于未来的日志管理和性能优化

3. **优化特性**
   - 调试输出在 Release 模式下自动禁用（通过 QT_DEBUG 宏）
   - 提供了 Logger::setDebugEnabled() 方法可以在运行时控制
   - 统一的日志格式，便于阅读和分析
   - 不影响现有功能，完全向后兼容

**编译验证**：
- 使用 MinGW + Ninja 工具链
- CMake 配置成功
- 编译成功，无错误
- 可执行文件 `QtWordEditor.exe` 成功生成

**预期收益**：
- 统一日志管理：所有调试输出都通过 Logger 类
- 性能优化：Release 模式下完全消除调试输出开销
- 可维护性提升：未来可以轻松扩展日志功能（如写入文件、网络发送等）
- 代码质量提升：消除了散落的 qDebug() 调用

---

### 15:00:00 - MainWindow 阶段 2 优化完成

**优化内容**：
1. **添加头文件和方法声明** (`MainWindow.h`)
   - 添加了 `#include <functional>` 用于使用 std::function
   - 新增了 3 个 private 辅助方法声明
   - 将不需要信号槽机制的方法从 `private slots` 移到 `private` 区域

2. **实现辅助方法** (`MainWindow.cpp`)
   - `toggleStyleAttribute()` - 统一处理粗体/斜体/下划线按钮点击
   - `applyFontProperty()` - 统一应用字体属性
   - `onStyleChanged()` - 统一样式变化事件处理

3. **替换 Lambda 按钮连接**
   - `boldChanged` - 从 ~35 行简化为 6 行
   - `italicChanged` - 从 ~30 行简化为 6 行
   - `underlineChanged` - 从 ~30 行简化为 6 行

4. **替换样式管理器信号连接**
   - `characterStyleChanged` - 简化为 1 行
   - `paragraphStyleChanged` - 简化为 1 行
   - `stylesChanged` - 简化为 1 行

5. **修复编译问题**
   - 将 `toggleStyleAttribute()` 和 `applyFontProperty()` 从 `private slots` 移到 `private` 区域
   - 解决了 Qt moc 编译器对复杂类型的处理问题
   - 修复了 `applyFontProperty()` 中的方法调用错误

**编译验证**：
- 使用 MinGW + Ninja 工具链
- CMake 配置成功
- 编译成功，无错误
- 可执行文件 `QtWordEditor.exe` 成功生成

**预期收益**：
- 代码行数减少：MainWindow.cpp 减少约 120 行重复代码
- 可维护性提升：新增样式属性只需调用统一方法
- 代码可读性提升：消除了三个几乎相同的 Lambda 处理器
- 统一接口：所有样式变化都通过 `onStyleChanged()` 处理

---

### 14:30:00 - FormatController 阶段 1 优化完成

**优化内容**：
1. **添加头文件和方法声明** (`FormatController.h`)
   - 添加了 `#include <functional>` 用于使用 std::function
   - 添加了 `ParagraphBlock` 前向声明
   - 新增了 6 个 private 辅助方法声明

2. **实现辅助方法** (`FormatController.cpp`)
   - `collectSelectionStyles()` - 收集选区内所有 Span 的样式
   - `checkSelectionAll()` - 检查选区内所有样式是否满足某条件
   - `applySingleProperty()` - 应用单个字符样式属性
   - `getParagraphBlock()` - 获取指定块的 ParagraphBlock
   - `validateSelection()` - 验证选区有效性
   - `applySingleParagraphProperty()` - 应用单个段落样式属性

3. **简化 isSelectionAllXxx() 方法**
   - `isSelectionAllBold()` - 从 ~50 行简化为 5 行
   - `isSelectionAllItalic()` - 从 ~50 行简化为 5 行
   - `isSelectionAllUnderline()` - 从 ~50 行简化为 5 行

4. **简化字符样式设置方法**
   - `setFont()`、`setFontFamily()`、`setFontSize()`
   - `setBold()`、`setItalic()`、`setUnderline()`
   - `setTextColor()`、`setBackgroundColor()`
   - 全部使用 `applySingleProperty()` 统一实现

5. **重构 getSelectionStyleConsistency()**
   - 复用 `collectSelectionStyles()` 收集样式
   - 减少代码重复约 60 行

6. **简化段落样式设置方法**
   - `setAlignment()`、`setLeftIndent()`、`setRightIndent()`
   - `setFirstLineIndent()`、`setLineHeight()`
   - `setSpaceBefore()`、`setSpaceAfter()`
   - 全部使用 `applySingleParagraphProperty()` 统一实现

**编译验证**：
- 使用 MinGW + Ninja 工具链
- CMake 配置成功
- 编译成功，无错误

**预期收益**：
- 代码行数减少：FormatController.cpp 从 ~760 行减少到约 270 行（减少 64%）
- 可维护性提升：新增样式属性只需少量代码
- 性能提升：减少重复计算

---

