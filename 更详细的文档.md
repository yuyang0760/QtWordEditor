---
title: "å¯å¦ç»™å‡ºæ›´ä¸ºè¯¦ç»†çš„æ–‡æ¡£,éå¸¸è¯¦ç»†çš„é‚£ç§"
date: "2026-02-17T05:39:52.858Z"
url: "https://chat.deepseek.com/a/chat/s/163318b2-4c2a-4576-b731-f937e05e0afb"
platform: "deepseek"
message_count: 2
---

# å¯å¦ç»™å‡ºæ›´ä¸ºè¯¦ç»†çš„æ–‡æ¡£,éå¸¸è¯¦ç»†çš„é‚£ç§ (2 æ¶ˆæ¯)

ğŸ”— **åŸå§‹é“¾æ¥**: [https://chat.deepseek.com/a/chat/s/163318b2-4c2a-4576-b731-f937e05e0afb](https://chat.deepseek.com/a/chat/s/163318b2-4c2a-4576-b731-f937e05e0afb)
ğŸ“… **å¯¼å‡ºæ—¶é—´**: 2026-02-17T05:39:52.858Z

> **ç»Ÿè®¡**
> - **æ¶ˆæ¯**: 2 (1 ç”¨æˆ·, 1 åŠ©æ‰‹)
> - **å­—æ•°**: ~12,968 (~59 åˆ†é’Ÿé˜…è¯»)
> - **ä»£ç å—**: 12
> - **è¡¨æ ¼**: 86


---

## ğŸ‘¤ ç”¨æˆ·
*#1 | è½®æ¬¡ 1*

> å¯å¦ç»™å‡ºæ›´ä¸ºè¯¦ç»†çš„æ–‡æ¡£,éå¸¸è¯¦ç»†çš„é‚£ç§

---

## ğŸ¤– deepseek
*#2*

<details>
<summary>ğŸ’­ æ€è€ƒè¿‡ç¨‹</summary>

> æˆ‘ä»¬è¢«è¦æ±‚æä¾›â€œæ›´ä¸ºè¯¦ç»†çš„æ–‡æ¡£,éå¸¸è¯¦ç»†çš„é‚£ç§â€ã€‚ä¹‹å‰æˆ‘ä»¬å·²ç»æä¾›äº†æ¨¡å—åˆ’åˆ†å’Œæ ¸å¿ƒç±»è®¾è®¡ã€‚ç°åœ¨éœ€è¦è¿›ä¸€æ­¥ç»†åŒ–ï¼ŒåŒ…æ‹¬æ¯ä¸ªç±»çš„æ‰€æœ‰æ–¹æ³•ã€å±æ€§è¯¦ç»†è¯´æ˜ã€ç±»çš„èŒè´£ã€ä½¿ç”¨åœºæ™¯ã€åä½œå…³ç³»ã€æ³¨æ„äº‹é¡¹ç­‰ã€‚å¯ä»¥æŒ‰æ¨¡å—ç»™å‡ºæ¯ä¸ªç±»çš„è¯¦ç»†APIæ–‡æ¡£ï¼Œç±»ä¼¼äºæŠ€æœ¯è®¾è®¡æ–‡æ¡£æˆ–APIå‚è€ƒã€‚æˆ‘ä»¬è¿˜å¯ä»¥åŠ å…¥ç±»å›¾ã€åºåˆ—å›¾ç­‰ã€‚ ç”±äºå†…å®¹åºå¤§ï¼Œæˆ‘ä»¬ä¸å¯èƒ½ä¸€æ¬¡æ€§å†™å‡ºæ¯ä¸ªç±»çš„æ‰€æœ‰æ–¹æ³•ï¼Œä½†å¯ä»¥ç»™å‡ºä»£è¡¨æ€§ç±»çš„è¯¦ç»†æè¿°ï¼Œå¹¶ç»™å‡ºæ–‡æ¡£çš„æ¨¡æ¿å’Œæ–¹å‘ã€‚ä½†ç”¨æˆ·è¦æ±‚â€œéå¸¸è¯¦ç»†â€ï¼Œå¯èƒ½éœ€è¦å®Œæ•´çš„ç±»æè¿°ã€‚è€ƒè™‘åˆ°ç¯‡å¹…ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¹‹å‰çš„åŸºç¡€ä¸Šï¼Œå¯¹æ¯ä¸ªå­æ¨¡å—çš„æ¯ä¸ªæ ¸å¿ƒç±»ï¼Œè¯¦ç»†æè¿°å…¶å±æ€§ã€æ–¹æ³•ï¼ˆåŒ…æ‹¬å‚æ•°ã€è¿”å›å€¼ã€åŠŸèƒ½ï¼‰ã€è®¾è®¡æ„å›¾ã€ä½¿ç”¨æ³¨æ„äº‹é¡¹ç­‰ã€‚åŒæ—¶è¡¥å……ä¸€äº›æµç¨‹å›¾ã€äº¤äº’å›¾ã€‚ æˆ‘ä»¬å¯ä»¥åˆ†æ¨¡å—è¿›è¡Œè¯¦ç»†æè¿°ï¼Œæ¯ä¸ªç±»ç»™å‡ºï¼š - ç±»å - ç»§æ‰¿å…³ç³» - èŒè´£ - å±æ€§ï¼ˆåç§°ã€ç±»å‹ã€æè¿°ï¼‰ - æ–¹æ³•ï¼ˆåç§°ã€å‚æ•°ã€è¿”å›å€¼ã€æè¿°ã€å¯èƒ½çš„å¼‚å¸¸/æ³¨æ„äº‹é¡¹ï¼‰ - ä¿¡å·/æ§½ï¼ˆå¦‚æœæœ‰ï¼‰ - è®¾è®¡è¦ç‚¹ - ä½¿ç”¨ç¤ºä¾‹ï¼ˆä»£ç ç‰‡æ®µï¼‰ æ­¤å¤–ï¼Œå¯¹äºå…³é”®æµç¨‹ï¼ˆå¦‚å¸ƒå±€ã€ç¼–è¾‘æ“ä½œï¼‰ï¼Œå¯ä»¥ç»™å‡ºåºåˆ—å›¾ã€‚ ç”±äºè¿™æ˜¯æ–‡æœ¬å¯¹è¯ï¼Œæˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªç»“æ„åŒ–çš„è¯¦ç»†æ–‡æ¡£ï¼Œä»¥markdownæ ¼å¼è¾“å‡ºã€‚æ³¨æ„ä¸èƒ½å¤ªå†—é•¿ï¼Œä½†å¿…é¡»æ»¡è¶³â€œéå¸¸è¯¦ç»†â€çš„è¦æ±‚ã€‚ æˆ‘ä»¬å¯ä»¥å°†æ ¸å¿ƒç±»ï¼ˆDocument, ParagraphBlock, Span, LayoutEngine, Cursor, Selection, DocumentScene, DocumentView, TextBlockItem, CursorItem, SelectionItem, BlockItemFactory, MainWindowç­‰ï¼‰é€ä¸€è¯¦ç»†æè¿°ã€‚å…¶ä»–æ¬¡è¦ç±»ç®€è¦æè¿°ã€‚ å¦å¤–ï¼Œå¯ä»¥è¡¥å……ä¸€äº›è®¾è®¡æ¨¡å¼çš„åº”ç”¨è¯´æ˜ï¼ˆå¦‚å‘½ä»¤æ¨¡å¼ã€å·¥å‚æ¨¡å¼ã€è§‚å¯Ÿè€…æ¨¡å¼ç­‰ï¼‰ã€‚ æˆ‘ä»¬å¼€å§‹æ„å»ºè¿™ä¸ªéå¸¸è¯¦ç»†çš„æ–‡æ¡£ã€‚

</details>

å·²æ€è€ƒï¼ˆç”¨æ—¶ 7 ç§’ï¼‰

# Qt Word æ–‡å­—å¤„ç†å™¨è¯¦ç»†è®¾è®¡æ–‡æ¡£ï¼ˆV2.0ï¼‰

## ç›®å½•

-   1\. app æ¨¡å—
    
-   2\. core æ¨¡å—
    
    -   2.1 document å­æ¨¡å—
        
    -   2.2 commands å­æ¨¡å—
        
    -   2.3 layout å­æ¨¡å—
        
    -   2.4 styles å­æ¨¡å—
        
    -   2.5 utils å­æ¨¡å—
        
-   3\. editcontrol æ¨¡å—
    
    -   3.1 cursor å­æ¨¡å—
        
    -   3.2 selection å­æ¨¡å—
        
    -   3.3 handlers å­æ¨¡å—
        
    -   3.4 formatting å­æ¨¡å—
        
-   4\. graphics æ¨¡å—
    
    -   4.1 scene å­æ¨¡å—
        
    -   4.2 view å­æ¨¡å—
        
    -   4.3 items å­æ¨¡å—
        
    -   4.4 factory å­æ¨¡å—
        
-   5\. io æ¨¡å—
    
    -   5.1 serializers å­æ¨¡å—
        
    -   5.2 exporters å­æ¨¡å—
        
    -   5.3 importers å­æ¨¡å—
        
-   6\. ui æ¨¡å—
    
    -   6.1 mainwindow å­æ¨¡å—
        
    -   6.2 ribbon å­æ¨¡å—
        
    -   6.3 dialogs å­æ¨¡å—
        
    -   6.4 widgets å­æ¨¡å—
        
-   7\. èµ„æºä¸é…ç½®
    
-   8\. æµ‹è¯•ä¸æ’ä»¶
    
-   9\. æ ¸å¿ƒæµç¨‹è®¾è®¡
    
-   10\. é™„å½•ï¼šç±»å›¾ä¸åºåˆ—å›¾
    

---

## 1\. app æ¨¡å—

### `Application` ç±»

**ç»§æ‰¿å…³ç³»**  
`QApplication`

**èŒè´£**

-   ä½œä¸ºåº”ç”¨ç¨‹åºçš„å•ä¸€å…¥å£ç‚¹ï¼Œè´Ÿè´£åˆå§‹åŒ– Qt åº”ç”¨ç¨‹åºç¯å¢ƒã€‚
    
-   ç®¡ç†å…¨å±€è®¾ç½®ï¼ˆæœ€è¿‘æ‰“å¼€æ–‡ä»¶ã€çª—å£å‡ ä½•ã€ä¸»é¢˜ç­‰ï¼‰ã€‚
    
-   æä¾›å…¨å±€å¼‚å¸¸å¤„ç†ï¼ˆä¸ main å‡½æ•°é…åˆï¼‰ã€‚
    
-   è®¾ç½®åº”ç”¨ç¨‹åºå…ƒä¿¡æ¯ï¼ˆç»„ç»‡åç§°ã€åº”ç”¨åç§°ã€ç‰ˆæœ¬ï¼‰ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_settings` | `QScopedPointer<QSettings>` | å…¨å±€è®¾ç½®å¯¹è±¡ï¼Œç”¨äºè¯»å†™é…ç½®ã€‚ |
| `m_recentFiles` | `QStringList` | æœ€è¿‘æ‰“å¼€çš„æ–‡ä»¶åˆ—è¡¨ã€‚ |
| `m_maxRecentFiles` | `int` | æœ€è¿‘æ–‡ä»¶æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ 10ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `Application` | \- | `int& argc, char** argv` | æ„é€ å‡½æ•°ï¼Œè°ƒç”¨åŸºç±»æ„é€ å‡½æ•°ï¼Œè®¾ç½®åº”ç”¨ç¨‹åºä¿¡æ¯ã€‚ |
| `~Application` | \- | \- | ææ„å‡½æ•°ï¼Œè°ƒç”¨ `saveSettings()`ã€‚ |
| `bool init()` | `bool` | \- | æ‰§è¡Œåˆå§‹åŒ–ï¼šåŠ è½½è®¾ç½®ã€åˆå§‹åŒ–èµ„æºç­‰ã€‚è¿”å› false è¡¨ç¤ºåˆå§‹åŒ–å¤±è´¥ã€‚ |
| `void loadSettings()` | `void` | \- | ä» QSettings åŠ è½½è®¾ç½®ï¼Œå¦‚çª—å£ä½ç½®ã€æœ€è¿‘æ–‡ä»¶åˆ—è¡¨ã€‚ |
| `void saveSettings()` | `void` | \- | ä¿å­˜å½“å‰è®¾ç½®åˆ° QSettingsã€‚ |
| `void addRecentFile(const QString& filePath)` | `void` | `const QString&` | æ·»åŠ æ–‡ä»¶åˆ°æœ€è¿‘æ–‡ä»¶åˆ—è¡¨ï¼ˆå»é‡ã€é™åˆ¶æ•°é‡ï¼‰ã€‚ |
| `QStringList recentFiles() const` | `QStringList` | \- | è·å–æœ€è¿‘æ–‡ä»¶åˆ—è¡¨ã€‚ |
| `void clearRecentFiles()` | `void` | \- | æ¸…ç©ºæœ€è¿‘æ–‡ä»¶åˆ—è¡¨ã€‚ |

**ä¿¡å·/æ§½**  
æ— ã€‚

**è®¾è®¡è¦ç‚¹**

-   ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼ˆå¯é€šè¿‡ `qApp` å…¨å±€æŒ‡é’ˆè®¿é—®ï¼‰ã€‚
    
-   è®¾ç½®æ–‡ä»¶æ ¼å¼ç”± Qt æ ¹æ®å¹³å°å†³å®šï¼ˆWindows æ³¨å†Œè¡¨ï¼ŒmacOS plistï¼ŒLinux INIï¼‰ã€‚
    
-   å¼‚å¸¸å¤„ç†åœ¨ main å‡½æ•°ä¸­è¿›è¡Œï¼Œ`Application` ä¸ç›´æ¥å¤„ç†ã€‚
    

**ä½¿ç”¨ç¤ºä¾‹**

```

int main(int argc, char* argv[]) {
    QWord::Application app(argc, argv);
    if (!app.init()) {
        QMessageBox::critical(nullptr, "Error", "Failed to initialize application");
        return -1;
    }
    // ... åˆ›å»ºä¸»çª—å£ç­‰
    return app.exec();
}

```

---

## 2\. core æ¨¡å—

### 2.1 document å­æ¨¡å—

#### `Document` ç±»

**ç»§æ‰¿å…³ç³»**  
`QObject`

**èŒè´£**

-   æ–‡æ¡£çš„æ ¹å®¹å™¨ï¼ŒåŒ…å«å¤šä¸ªèŠ‚ï¼ˆSectionï¼‰ã€‚
    
-   ç®¡ç†æ–‡æ¡£å…ƒæ•°æ®ï¼ˆæ ‡é¢˜ã€ä½œè€…ã€åˆ›å»ºæ—¶é—´ç­‰ï¼‰ã€‚
    
-   æŒæœ‰æ’¤é”€æ ˆï¼ˆQUndoStackï¼‰ï¼Œæä¾›æ’¤é”€/é‡åšåŠŸèƒ½ã€‚
    
-   å‘å‡ºæ–‡æ¡£å˜åŒ–ä¿¡å·ï¼Œä¾›è§†å›¾å±‚æ›´æ–°ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_documentId` | `int` | æ–‡æ¡£ IDï¼ˆå¯é€‰ï¼Œå¯ç”¨äºæ•°æ®åº“å­˜å‚¨ï¼‰ã€‚ |
| `m_title` | `QString` | æ–‡æ¡£æ ‡é¢˜ã€‚ |
| `m_author` | `QString` | ä½œè€…ã€‚ |
| `m_created` | `QDateTime` | åˆ›å»ºæ—¶é—´ã€‚ |
| `m_modified` | `QDateTime` | æœ€åä¿®æ”¹æ—¶é—´ã€‚ |
| `m_sections` | `QList<Section*>` | èŠ‚åˆ—è¡¨ï¼ˆ`Document` æ‹¥æœ‰æ‰€æœ‰æƒï¼‰ã€‚ |
| `m_undoStack` | `QUndoStack*` | æ’¤é”€æ ˆï¼Œç”± `Document` åˆ›å»ºå¹¶ç®¡ç†ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `Document` | \- | `QObject* parent = nullptr` | æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–å…ƒæ•°æ®ï¼ˆåˆ›å»ºæ—¶é—´ä¸ºå½“å‰æ—¶é—´ï¼‰ï¼Œåˆ›å»ºæ’¤é”€æ ˆã€‚ |
| `~Document` | \- | \- | ææ„å‡½æ•°ï¼Œåˆ é™¤æ‰€æœ‰èŠ‚å’Œæ’¤é”€æ ˆã€‚ |
| `int documentId() const` | `int` | \- | è·å–æ–‡æ¡£ IDã€‚ |
| `void setDocumentId(int id)` | `void` | `int` | è®¾ç½®æ–‡æ¡£ IDã€‚ |
| `QString title() const` | `QString` | \- | è·å–æ ‡é¢˜ã€‚ |
| `void setTitle(const QString& title)` | `void` | `const QString&` | è®¾ç½®æ ‡é¢˜ï¼Œè‹¥å˜åŒ–å‘å‡º `documentChanged()` ä¿¡å·ã€‚ |
| `QString author() const` | `QString` | \- | è·å–ä½œè€…ã€‚ |
| `void setAuthor(const QString& author)` | `void` | `const QString&` | è®¾ç½®ä½œè€…ï¼Œè‹¥å˜åŒ–å‘å‡º `documentChanged()` ä¿¡å·ã€‚ |
| `QDateTime created() const` | `QDateTime` | \- | è·å–åˆ›å»ºæ—¶é—´ã€‚ |
| `QDateTime modified() const` | `QDateTime` | \- | è·å–æœ€åä¿®æ”¹æ—¶é—´ã€‚ |
| `void setModified()` | `void` | \- | è®¾ç½®ä¿®æ”¹æ—¶é—´ä¸ºå½“å‰æ—¶é—´ï¼Œå‘å‡º `documentChanged()`ã€‚ |
| `int sectionCount() const` | `int` | \- | è¿”å›èŠ‚çš„æ•°é‡ã€‚ |
| `Section* section(int index) const` | `Section*` | `int` | è·å–æŒ‡å®šç´¢å¼•çš„èŠ‚ï¼ˆç´¢å¼•ä» 0 å¼€å§‹ï¼‰ã€‚ |
| `void addSection(Section* section)` | `void` | `Section*` | æ·»åŠ èŠ‚ï¼ˆæ–‡æ¡£è·å¾—æ‰€æœ‰æƒï¼‰ã€‚ |
| `void insertSection(int index, Section* section)` | `void` | `int, Section*` | åœ¨æŒ‡å®šä½ç½®æ’å…¥èŠ‚ã€‚ |
| `void removeSection(int index)` | `void` | `int` | ç§»é™¤å¹¶åˆ é™¤æŒ‡å®šç´¢å¼•çš„èŠ‚ã€‚ |
| `int blockCount() const` | `int` | \- | è¿”å›æ–‡æ¡£ä¸­æ‰€æœ‰å—çš„æ€»æ•°ï¼ˆéå†å„èŠ‚ç´¯åŠ ï¼‰ã€‚ |
| `Block* block(int globalIndex) const` | `Block*` | `int` | æŒ‰å…¨å±€ç´¢å¼•è·å–å—ï¼ˆä» 0 å¼€å§‹è®¡æ•°ï¼‰ã€‚ |
| `QUndoStack* undoStack() const` | `QUndoStack*` | \- | è·å–æ’¤é”€æ ˆæŒ‡é’ˆã€‚ |
| `QString plainText() const` | `QString` | \- | è¿”å›æ–‡æ¡£çš„çº¯æ–‡æœ¬å†…å®¹ï¼ˆç”¨äºå¯¼å‡ºï¼‰ã€‚ |
| `void clear()` | `void` | \- | æ¸…ç©ºæ‰€æœ‰èŠ‚ï¼Œé‡ç½®å…ƒæ•°æ®ï¼ˆé™¤ ID å¤–ï¼‰ã€‚ |

**ä¿¡å·**

| åç§° | å‚æ•° | æè¿° |
| --- | --- | --- |
| `documentChanged()` | \- | æ–‡æ¡£å†…å®¹æˆ–å…ƒæ•°æ®å‘ç”Ÿå˜åŒ–æ—¶å‘å‡ºï¼ˆç”¨äºæ›´æ–°æ ‡é¢˜çš„ \* æ ‡è®°ï¼‰ã€‚ |
| `blockAdded(int index)` | `int` | åœ¨å…¨å±€ç´¢å¼•å¤„æ·»åŠ äº†æ–°å—æ—¶å‘å‡ºã€‚ |
| `blockRemoved(int index)` | `int` | åœ¨å…¨å±€ç´¢å¼•å¤„ç§»é™¤äº†å—æ—¶å‘å‡ºã€‚ |
| `layoutChanged()` | \- | å¸ƒå±€å‘ç”Ÿå˜åŒ–æ—¶å‘å‡ºï¼ˆå¦‚æ’å…¥/åˆ é™¤å—åï¼Œéœ€è¦é‡æ–°å¸ƒå±€ï¼‰ã€‚ |

**è®¾è®¡è¦ç‚¹**

-   æ‰€æœ‰å¯¹æ–‡æ¡£çš„ä¿®æ”¹åº”é€šè¿‡å‘½ä»¤ï¼ˆQUndoCommandï¼‰è¿›è¡Œï¼Œä»¥ç¡®ä¿æ’¤é”€/é‡åšã€‚
    
-   ä¿¡å·åº”ç»†ç²’åº¦ï¼Œä»¥ä¾¿è§†å›¾åªæ›´æ–°å¿…è¦çš„éƒ¨åˆ†ã€‚
    
-   èŠ‚çš„ç”Ÿå‘½å‘¨æœŸç”± Document ç®¡ç†ï¼ˆä½¿ç”¨ `QObject` çˆ¶å­å…³ç³»æˆ–æ‰‹åŠ¨ deleteï¼‰ã€‚
    

**ä½¿ç”¨ç¤ºä¾‹**

```

Document* doc = new Document();
doc->setTitle("My Document");
Section* sec = new Section();
doc->addSection(sec);
ParagraphBlock* block = new ParagraphBlock("Hello");
sec->addBlock(block);
// æ’å…¥æ–‡æœ¬å‘½ä»¤...

```

---

#### `Section` ç±»

**ç»§æ‰¿å…³ç³»**  
`QObject`ï¼ˆå¯é€‰ï¼‰

**èŒè´£**

-   è¡¨ç¤ºæ–‡æ¡£çš„ä¸€ä¸ªé€»è¾‘èŠ‚ï¼ˆå¦‚ç« èŠ‚ï¼‰ã€‚
    
-   åŒ…å«è¯¥èŠ‚çš„æ‰€æœ‰å—ï¼ˆBlockï¼‰å’Œå¸ƒå±€ç”Ÿæˆçš„é¡µé¢ï¼ˆPageï¼‰ã€‚
    
-   æä¾›èŠ‚çº§åˆ«çš„é¡µçœ‰/é¡µè„šæ”¯æŒã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_sectionNumber` | `int` | èŠ‚ç¼–å·ï¼ˆä» 0 å¼€å§‹ï¼‰ã€‚ |
| `m_header` | `QString` | é¡µçœ‰å†…å®¹ï¼ˆå¯åŒ…å«ç®€å•æ ¼å¼ï¼‰ã€‚ |
| `m_footer` | `QString` | é¡µè„šå†…å®¹ã€‚ |
| `m_blocks` | `QList<Block*>` | å—åˆ—è¡¨ï¼ˆSection æ‹¥æœ‰æ‰€æœ‰æƒï¼‰ã€‚ |
| `m_pages` | `QList<Page*>` | å¸ƒå±€åç”Ÿæˆçš„é¡µé¢åˆ—è¡¨ï¼ˆè¿è¡Œæ—¶ï¼Œä¸æŒä¹…åŒ–ï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `Section` | \- | `QObject* parent = nullptr` | æ„é€ å‡½æ•°ã€‚ |
| `~Section` | \- | \- | ææ„å‡½æ•°ï¼Œåˆ é™¤æ‰€æœ‰å—å’Œé¡µé¢ã€‚ |
| `int sectionNumber() const` | `int` | \- | è·å–èŠ‚ç¼–å·ã€‚ |
| `void setSectionNumber(int num)` | `void` | `int` | è®¾ç½®èŠ‚ç¼–å·ã€‚ |
| `QString header() const` | `QString` | \- | è·å–é¡µçœ‰ã€‚ |
| `void setHeader(const QString& header)` | `void` | `const QString&` | è®¾ç½®é¡µçœ‰ã€‚ |
| `QString footer() const` | `QString` | \- | è·å–é¡µè„šã€‚ |
| `void setFooter(const QString& footer)` | `void` | `const QString&` | è®¾ç½®é¡µè„šã€‚ |
| `int blockCount() const` | `int` | \- | è¿”å›å—æ•°é‡ã€‚ |
| `Block* block(int index) const` | `Block*` | `int` | è·å–æŒ‡å®šç´¢å¼•çš„å—ã€‚ |
| `void addBlock(Block* block)` | `void` | `Block*` | æ·»åŠ å—åˆ°æœ«å°¾ã€‚ |
| `void insertBlock(int index, Block* block)` | `void` | `int, Block*` | æ’å…¥å—ã€‚ |
| `void removeBlock(int index)` | `void` | `int` | ç§»é™¤å¹¶åˆ é™¤å—ã€‚ |
| `void clearBlocks()` | `void` | \- | åˆ é™¤æ‰€æœ‰å—ã€‚ |
| `int pageCount() const` | `int` | \- | è¿”å›é¡µé¢æ•°é‡ã€‚ |
| `Page* page(int index) const` | `Page*` | `int` | è·å–é¡µé¢ã€‚ |
| `void addPage(Page* page)` | `void` | `Page*` | æ·»åŠ é¡µé¢ï¼ˆç”±å¸ƒå±€å¼•æ“è°ƒç”¨ï¼‰ã€‚ |
| `void clearPages()` | `void` | \- | æ¸…ç©ºé¡µé¢ï¼ˆå¸ƒå±€å‰è°ƒç”¨ï¼‰ã€‚ |

**è®¾è®¡è¦ç‚¹**

-   é¡µé¢ä¸æŒä¹…åŒ–ï¼Œæ¯æ¬¡æ‰“å¼€æ–‡æ¡£æˆ–ä¿®æ”¹å†…å®¹åé‡æ–°å¸ƒå±€ç”Ÿæˆã€‚
    
-   é¡µçœ‰/é¡µè„šå¯åœ¨æ‰“å°/å¯¼å‡ºæ—¶ä½¿ç”¨ã€‚
    

---

#### `Block` æŠ½è±¡åŸºç±»

**ç»§æ‰¿å…³ç³»**  
`QObject`ï¼ˆå¯é€‰ï¼Œä¾¿äºä¿¡å·ï¼‰

**èŒè´£**

-   æ‰€æœ‰å†…å®¹å—çš„åŸºç±»ã€‚
    
-   å®šä¹‰å—çš„åŸºæœ¬å±æ€§ï¼šIDã€è¾¹ç•ŒçŸ©å½¢ã€é«˜åº¦ã€åœ¨æ–‡æ¡£ä¸­çš„å…¨å±€ä½ç½®ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_blockId` | `int` | å— IDï¼ˆå¯é€‰ï¼‰ã€‚ |
| `m_boundingRect` | `QRectF` | å¸ƒå±€åå—åœ¨é¡µé¢ä¸Šçš„è¾¹ç•ŒçŸ©å½¢ï¼ˆç›¸å¯¹äºé¡µé¢åŸç‚¹ï¼‰ã€‚ |
| `m_positionInDocument` | `int` | å—åœ¨æ–‡æ¡£ä¸­çš„å…¨å±€ç´¢å¼•ï¼ˆç”¨äºå¿«é€Ÿå®šä½ï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `Block` | \- | `QObject* parent = nullptr` | æ„é€ å‡½æ•°ã€‚ |
| `virtual ~Block` | \- | \- | è™šææ„ã€‚ |
| `int blockId() const` | `int` | \- | è·å–å— IDã€‚ |
| `void setBlockId(int id)` | `void` | `int` | è®¾ç½®å— IDã€‚ |
| `QRectF boundingRect() const` | `QRectF` | \- | è·å–è¾¹ç•ŒçŸ©å½¢ã€‚ |
| `void setBoundingRect(const QRectF& rect)` | `void` | `const QRectF&` | è®¾ç½®è¾¹ç•ŒçŸ©å½¢ï¼ˆå¸ƒå±€å¼•æ“è°ƒç”¨ï¼‰ã€‚ |
| `qreal height() const` | `qreal` | \- | è·å–é«˜åº¦ï¼ˆå³ `boundingRect().height()`ï¼‰ã€‚ |
| `void setHeight(qreal height)` | `void` | `qreal` | è®¾ç½®é«˜åº¦ï¼ˆé€šå¸¸è®¾ç½®è¾¹ç•ŒçŸ©å½¢é«˜åº¦ï¼‰ã€‚ |
| `int positionInDocument() const` | `int` | \- | è·å–å…¨å±€ç´¢å¼•ã€‚ |
| `void setPositionInDocument(int pos)` | `void` | `int` | è®¾ç½®å…¨å±€ç´¢å¼•ã€‚ |
| `virtual int length() const = 0` | `int` | \- | è¿”å›å—çš„é•¿åº¦ï¼ˆå¯¹äºæ–‡æœ¬å—ä¸ºå­—ç¬¦æ•°+1ï¼Ÿé€šå¸¸å­—ç¬¦æ•°ï¼‰ã€‚ |
| `virtual bool isEmpty() const = 0` | `bool` | \- | åˆ¤æ–­å—æ˜¯å¦ä¸ºç©ºã€‚ |

**æ´¾ç”Ÿç±»**

-   `ParagraphBlock`
    
-   `ImageBlock`
    
-   `TableBlock`
    

---

#### `ParagraphBlock` ç±»

**ç»§æ‰¿å…³ç³»**  
`Block`

**èŒè´£**

-   è¡¨ç¤ºä¸€ä¸ªæ–‡æœ¬æ®µè½ï¼ŒåŒ…å«å¤šä¸ª Spanã€‚
    
-   æŒæœ‰æ®µè½æ ·å¼ï¼Œæä¾›æ–‡æœ¬ç¼–è¾‘æ¥å£ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_spans` | `QList<Span>` | æ–‡æœ¬ç‰‡æ®µåˆ—è¡¨ï¼Œæ¯ä¸ªç‰‡æ®µæœ‰ç‹¬ç«‹æ ·å¼ã€‚ |
| `m_paragraphStyle` | `ParagraphStyle` | æ®µè½æ ·å¼ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `ParagraphBlock` | \- | `QObject* parent = nullptr` | é»˜è®¤æ„é€ ã€‚ |
| `ParagraphBlock` | \- | `const QString& text, QObject* parent = nullptr` | ç”¨æŒ‡å®šæ–‡æœ¬åˆå§‹åŒ–ï¼Œä½¿ç”¨é»˜è®¤æ ·å¼åˆ›å»ºä¸€ä¸ª Spanã€‚ |
| `ParagraphBlock` | \- | `const ParagraphBlock& other` | æ‹·è´æ„é€ ï¼ˆæ·±æ‹·è´ spansï¼‰ã€‚ |
| `~ParagraphBlock` | \- | \- | ææ„ã€‚ |
| `ParagraphBlock& operator=(const ParagraphBlock& other)` | `ParagraphBlock&` | \- | èµ‹å€¼è¿ç®—ç¬¦ã€‚ |
| `int length() const override` | `int` | \- | è¿”å›æ€»å­—ç¬¦æ•°ï¼ˆæ‰€æœ‰ span é•¿åº¦ä¹‹å’Œï¼‰ã€‚ |
| `bool isEmpty() const override` | `bool` | \- | è¿”å› `m_spans.isEmpty()` æˆ–æ‰€æœ‰ span æ–‡æœ¬ä¸ºç©ºã€‚ |
| `int spanCount() const` | `int` | \- | è¿”å› span æ•°é‡ã€‚ |
| `Span span(int index) const` | `Span` | `int` | è·å–æŒ‡å®šç´¢å¼•çš„ spanã€‚ |
| `void addSpan(const Span& span)` | `void` | `const Span&` | æ·»åŠ  span åˆ°æœ«å°¾ã€‚ |
| `void insertSpan(int index, const Span& span)` | `void` | `int, const Span&` | æ’å…¥ spanã€‚ |
| `void removeSpan(int index)` | `void` | `int` | ç§»é™¤ spanã€‚ |
| `void clearSpans()` | `void` | \- | æ¸…ç©ºæ‰€æœ‰ spanã€‚ |
| `QString text() const` | `QString` | \- | æ‹¼æ¥æ‰€æœ‰ span æ–‡æœ¬è¿”å›ã€‚ |
| `void setText(const QString& text)` | `void` | `const QString&` | ç”¨å•ä¸ª span è®¾ç½®æ–‡æœ¬ï¼ˆæ¸…ç©ºåŸæœ‰ spansï¼Œä½¿ç”¨é»˜è®¤æ ·å¼ï¼‰ã€‚ |
| `ParagraphStyle paragraphStyle() const` | `ParagraphStyle` | \- | è·å–æ®µè½æ ·å¼ã€‚ |
| `void setParagraphStyle(const ParagraphStyle& style)` | `void` | `const ParagraphStyle&` | è®¾ç½®æ®µè½æ ·å¼ã€‚ |
| `void insert(int position, const QString& text, const CharacterStyle& style)` | `void` | `int, const QString&, const CharacterStyle&` | åœ¨æŒ‡å®šä½ç½®æ’å…¥æ–‡æœ¬ï¼Œè‡ªåŠ¨å¤„ç† span æ‹†åˆ†/åˆå¹¶ã€‚ |
| `void remove(int position, int length)` | `void` | `int, int` | åˆ é™¤æŒ‡å®šèŒƒå›´çš„æ–‡æœ¬ï¼Œè‡ªåŠ¨å¤„ç† spanã€‚ |
| `void replace(int position, int length, const QString& text, const CharacterStyle& style)` | `void` | `int, int, const QString&, const CharacterStyle&` | æ›¿æ¢æ–‡æœ¬ã€‚ |
| `QString mid(int position, int length) const` | `QString` | `int, int` | è¿”å›å­ä¸²ï¼ˆçº¯æ–‡æœ¬ï¼‰ã€‚ |
| `QList<Span> subSpans(int position, int length) const` | `QList<Span>` | `int, int` | è¿”å›æŒ‡å®šèŒƒå›´çš„ span åˆ—è¡¨ï¼ˆç”¨äºå¤åˆ¶å¸¦æ ·å¼çš„æ–‡æœ¬ï¼‰ã€‚ |

**è®¾è®¡è¦ç‚¹**

-   æ’å…¥å’Œåˆ é™¤æ“ä½œéœ€ç»´æŠ¤ span çš„è¿ç»­æ€§ï¼Œé¿å…è¿‡å¤šçš„ç»†å° spanã€‚
    
-   å½“æ’å…¥ä½ç½®ä½äº span ä¸­é—´ä¸”æ ·å¼ä¸å½“å‰ span ç›¸åŒï¼Œåˆ™ç›´æ¥åˆå¹¶ï¼›å¦åˆ™æ‹†åˆ†å¹¶æ’å…¥æ–° spanã€‚
    
-   åˆ é™¤æ—¶ï¼Œå¦‚æœè·¨ spanï¼Œéœ€è¦åˆ é™¤éƒ¨åˆ† span æˆ–æˆªæ–­ã€‚
    

**å®ç°ç¤ºä¾‹**

```

void ParagraphBlock::insert(int position, const QString& text, const CharacterStyle& style) {
    if (position < 0 || position > length())
        return;
    if (text.isEmpty())
        return;

    int currentPos = 0;
    for (int i = 0; i < m_spans.size(); ++i) {
        int spanLen = m_spans[i].length();
        if (currentPos + spanLen >= position) {
            int insertPos = position - currentPos;
            if (m_spans[i].style() == style) {
                // æ ·å¼ç›¸åŒï¼Œç›´æ¥æ’å…¥åˆ°è¯¥ span
                m_spans[i].insert(insertPos, text);
            } else {
                // æ ·å¼ä¸åŒï¼Œæ‹†åˆ†å¹¶æ’å…¥æ–° span
                Span rightPart = m_spans[i].split(insertPos);
                m_spans.insert(i + 1, Span(text, style));
                m_spans.insert(i + 2, rightPart);
            }
            return;
        }
        currentPos += spanLen;
    }
    // å¦‚æœ position ç­‰äºæ€»é•¿åº¦ï¼Œè¿½åŠ æ–° span
    if (position == length()) {
        m_spans.append(Span(text, style));
    }
}

```

---

#### `Span` ç±»

**èŒè´£**

-   è¡¨ç¤ºä¸€æ®µå…·æœ‰ç›¸åŒå­—ç¬¦æ ·å¼çš„æ–‡æœ¬ç‰‡æ®µã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_text` | `QString` | æ–‡æœ¬å†…å®¹ã€‚ |
| `m_style` | `CharacterStyle` | å­—ç¬¦æ ·å¼ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `Span` | \- | \- | é»˜è®¤æ„é€ ï¼Œç©ºæ–‡æœ¬ï¼Œé»˜è®¤æ ·å¼ã€‚ |
| `Span` | \- | `const QString& text` | æŒ‡å®šæ–‡æœ¬ï¼Œä½¿ç”¨é»˜è®¤æ ·å¼ã€‚ |
| `Span` | \- | `const QString& text, const CharacterStyle& style` | æŒ‡å®šæ–‡æœ¬å’Œæ ·å¼ã€‚ |
| `Span` | \- | `const Span& other` | æ‹·è´æ„é€ ã€‚ |
| `~Span` | \- | \- | ææ„ã€‚ |
| `Span& operator=(const Span& other)` | `Span&` | \- | èµ‹å€¼è¿ç®—ç¬¦ã€‚ |
| `bool operator==(const Span& other) const` | `bool` | \- | æ¯”è¾ƒæ–‡æœ¬å’Œæ ·å¼æ˜¯å¦ç›¸ç­‰ã€‚ |
| `bool operator!=(const Span& other) const` | `bool` | \- | ä¸ç­‰ã€‚ |
| `QString text() const` | `QString` | \- | è·å–æ–‡æœ¬ã€‚ |
| `void setText(const QString& text)` | `void` | `const QString&` | è®¾ç½®æ–‡æœ¬ã€‚ |
| `CharacterStyle style() const` | `CharacterStyle` | \- | è·å–æ ·å¼ã€‚ |
| `void setStyle(const CharacterStyle& style)` | `void` | `const CharacterStyle&` | è®¾ç½®æ ·å¼ã€‚ |
| `int length() const` | `int` | \- | è¿”å›æ–‡æœ¬é•¿åº¦ã€‚ |
| `bool isEmpty() const` | `bool` | \- | è¿”å›æ–‡æœ¬æ˜¯å¦ä¸ºç©ºã€‚ |
| `Span split(int position)` | `Span` | `int` | åœ¨ position å¤„åˆ†å‰²ï¼Œè¿”å›ååŠéƒ¨åˆ†çš„æ–° spanï¼Œå½“å‰å¯¹è±¡å˜ä¸ºå‰åŠéƒ¨åˆ†ã€‚ |
| `void append(const QString& text)` | `void` | `const QString&` | è¿½åŠ æ–‡æœ¬ã€‚ |
| `void insert(int position, const QString& text)` | `void` | `int, const QString&` | æ’å…¥æ–‡æœ¬ã€‚ |
| `void remove(int position, int length)` | `void` | `int, int` | åˆ é™¤æ–‡æœ¬ã€‚ |
| `QString mid(int position, int length) const` | `QString` | `int, int` | è·å–å­ä¸²ã€‚ |

**è®¾è®¡è¦ç‚¹**

-   split æ–¹æ³•ç”¨äºæ’å…¥æ—¶éœ€ä¿æŒæ ·å¼ä¸€è‡´ã€‚
    
-   æ‰€æœ‰ä¿®æ”¹æ–‡æœ¬çš„æ–¹æ³•å‡ä¸æ¶‰åŠæ ·å¼å˜åŒ–ã€‚
    

---

#### `CharacterStyle` ç±»

**èŒè´£**

-   å°è£…å­—ç¬¦çº§åˆ«çš„æ ·å¼å±æ€§ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_font` | `QFont` | å­—ä½“ï¼ˆåŒ…æ‹¬ family, pointSize, bold, italic, underline ç­‰ï¼‰ã€‚ |
| `m_textColor` | `QColor` | æ–‡å­—é¢œè‰²ã€‚ |
| `m_backgroundColor` | `QColor` | èƒŒæ™¯é¢œè‰²ã€‚ |
| `m_letterSpacing` | `qreal` | å­—é—´è·ï¼ˆåƒç´ æˆ–ç‚¹ï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `CharacterStyle` | \- | \- | é»˜è®¤æ„é€ ï¼Œå­—ä½“ä½¿ç”¨é»˜è®¤ï¼Œé¢œè‰²é»‘è‰²ï¼ŒèƒŒæ™¯é€æ˜ï¼Œé—´è· 0ã€‚ |
| `CharacterStyle` | \- | `const CharacterStyle& other` | æ‹·è´æ„é€ ã€‚ |
| `~CharacterStyle` | \- | \- | ææ„ã€‚ |
| `CharacterStyle& operator=(const CharacterStyle& other)` | `CharacterStyle&` | \- | èµ‹å€¼ã€‚ |
| `bool operator==(const CharacterStyle& other) const` | `bool` | \- | æ¯”è¾ƒæ‰€æœ‰å±æ€§ã€‚ |
| `bool operator!=(const CharacterStyle& other) const` | `bool` | \- | ä¸ç­‰ã€‚ |
| `QFont font() const` | `QFont` | \- | è·å–å­—ä½“ã€‚ |
| `void setFont(const QFont& font)` | `void` | `const QFont&` | è®¾ç½®å­—ä½“ã€‚ |
| `int fontSize() const` | `int` | \- | è·å–å­—å·ï¼ˆç‚¹ï¼‰ã€‚ |
| `void setFontSize(int size)` | `void` | `int` | è®¾ç½®å­—å·ã€‚ |
| `bool isBold() const` | `bool` | \- | æ˜¯å¦ç²—ä½“ã€‚ |
| `void setBold(bool bold)` | `void` | `bool` | è®¾ç½®ç²—ä½“ã€‚ |
| `bool isItalic() const` | `bool` | \- | æ˜¯å¦æ–œä½“ã€‚ |
| `void setItalic(bool italic)` | `void` | `bool` | è®¾ç½®æ–œä½“ã€‚ |
| `bool isUnderline() const` | `bool` | \- | æ˜¯å¦ä¸‹åˆ’çº¿ã€‚ |
| `void setUnderline(bool underline)` | `void` | `bool` | è®¾ç½®ä¸‹åˆ’çº¿ã€‚ |
| `QColor textColor() const` | `QColor` | \- | è·å–æ–‡å­—é¢œè‰²ã€‚ |
| `void setTextColor(const QColor& color)` | `void` | `const QColor&` | è®¾ç½®æ–‡å­—é¢œè‰²ã€‚ |
| `QColor backgroundColor() const` | `QColor` | \- | è·å–èƒŒæ™¯é¢œè‰²ã€‚ |
| `void setBackgroundColor(const QColor& color)` | `void` | `const QColor&` | è®¾ç½®èƒŒæ™¯é¢œè‰²ã€‚ |
| `QString fontFamily() const` | `QString` | \- | è·å–å­—ä½“å®¶æ—ã€‚ |
| `void setFontFamily(const QString& family)` | `void` | `const QString&` | è®¾ç½®å­—ä½“å®¶æ—ã€‚ |
| `qreal letterSpacing() const` | `qreal` | \- | è·å–å­—é—´è·ã€‚ |
| `void setLetterSpacing(qreal spacing)` | `void` | `qreal` | è®¾ç½®å­—é—´è·ã€‚ |

**è®¾è®¡è¦ç‚¹**

-   QFont å·²ç»å°è£…äº†ç²—ä½“ã€æ–œä½“ç­‰ï¼Œå› æ­¤å¯ç›´æ¥ä½¿ç”¨ QFont çš„æ¥å£ã€‚
    
-   ä½¿ç”¨éšå¼å…±äº«ï¼ˆQFontã€QColor æœ¬èº«æ˜¯éšå¼å…±äº«çš„ï¼‰ä»¥æé«˜å¤åˆ¶æ•ˆç‡ã€‚
    

---

#### `ParagraphStyle` ç±»

**èŒè´£**

-   å°è£…æ®µè½çº§åˆ«çš„æ ·å¼å±æ€§ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_alignment` | `ParagraphAlignment` | å¯¹é½æ–¹å¼ï¼ˆæšä¸¾ï¼‰ã€‚ |
| `m_lineHeight` | `int` | è¡Œé«˜ï¼ˆç™¾åˆ†æ¯”ï¼Œå¦‚ 150 è¡¨ç¤º 150%ï¼‰ã€‚ |
| `m_firstLineIndent` | `qreal` | é¦–è¡Œç¼©è¿›ï¼ˆç‚¹æˆ–åƒç´ ï¼‰ã€‚ |
| `m_leftIndent` | `qreal` | å·¦ç¼©è¿›ã€‚ |
| `m_rightIndent` | `qreal` | å³ç¼©è¿›ã€‚ |
| `m_spaceBefore` | `qreal` | æ®µå‰é—´è·ã€‚ |
| `m_spaceAfter` | `qreal` | æ®µåé—´è·ã€‚ |

**æšä¸¾ `ParagraphAlignment`**

```

enum ParagraphAlignment {
    AlignLeft,
    AlignCenter,
    AlignRight,
    AlignJustify
};

```

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `ParagraphStyle` | \- | \- | é»˜è®¤æ„é€ ï¼šå·¦å¯¹é½ï¼Œè¡Œé«˜ 100%ï¼Œç¼©è¿› 0ï¼Œé—´è· 0ã€‚ |
| `ParagraphStyle` | \- | `const ParagraphStyle& other` | æ‹·è´æ„é€ ã€‚ |
| `~ParagraphStyle` | \- | \- | ææ„ã€‚ |
| `ParagraphStyle& operator=(const ParagraphStyle& other)` | `ParagraphStyle&` | \- | èµ‹å€¼ã€‚ |
| `bool operator==(const ParagraphStyle& other) const` | `bool` | \- | æ¯”è¾ƒæ‰€æœ‰å±æ€§ã€‚ |
| `bool operator!=(const ParagraphStyle& other) const` | `bool` | \- | ä¸ç­‰ã€‚ |
| `ParagraphAlignment alignment() const` | `ParagraphAlignment` | \- | è·å–å¯¹é½æ–¹å¼ã€‚ |
| `void setAlignment(ParagraphAlignment align)` | `void` | `ParagraphAlignment` | è®¾ç½®å¯¹é½æ–¹å¼ã€‚ |
| `int lineHeight() const` | `int` | \- | è·å–è¡Œé«˜ç™¾åˆ†æ¯”ã€‚ |
| `void setLineHeight(int percentage)` | `void` | `int` | è®¾ç½®è¡Œé«˜ç™¾åˆ†æ¯”ã€‚ |
| `qreal firstLineIndent() const` | `qreal` | \- | è·å–é¦–è¡Œç¼©è¿›ã€‚ |
| `void setFirstLineIndent(qreal indent)` | `void` | `qreal` | è®¾ç½®é¦–è¡Œç¼©è¿›ã€‚ |
| `qreal leftIndent() const` | `qreal` | \- | è·å–å·¦ç¼©è¿›ã€‚ |
| `void setLeftIndent(qreal indent)` | `void` | `qreal` | è®¾ç½®å·¦ç¼©è¿›ã€‚ |
| `qreal rightIndent() const` | `qreal` | \- | è·å–å³ç¼©è¿›ã€‚ |
| `void setRightIndent(qreal indent)` | `void` | `qreal` | è®¾ç½®å³ç¼©è¿›ã€‚ |
| `qreal spaceBefore() const` | `qreal` | \- | è·å–æ®µå‰é—´è·ã€‚ |
| `void setSpaceBefore(qreal space)` | `void` | `qreal` | è®¾ç½®æ®µå‰é—´è·ã€‚ |
| `qreal spaceAfter() const` | `qreal` | \- | è·å–æ®µåé—´è·ã€‚ |
| `void setSpaceAfter(qreal space)` | `void` | `qreal` | è®¾ç½®æ®µåé—´è·ã€‚ |

---

#### `ImageBlock` ç±»

**ç»§æ‰¿å…³ç³»**  
`Block`

**èŒè´£**

-   è¡¨ç¤ºä¸€ä¸ªå›¾ç‰‡å—ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_image` | `QImage` | å›¾ç‰‡æ•°æ®ã€‚ |
| `m_size` | `QSizeF` | æ˜¾ç¤ºå°ºå¯¸ï¼ˆå¯ä»¥ç¼©æ”¾ï¼‰ã€‚ |
| `m_caption` | `QString` | å›¾ç‰‡æ ‡é¢˜ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `ImageBlock` | \- | `QObject* parent = nullptr` | æ„é€ ã€‚ |
| `ImageBlock` | \- | `const QImage& image, QObject* parent = nullptr` | ç”¨å›¾ç‰‡åˆå§‹åŒ–ã€‚ |
| `int length() const override` | `int` | \- | è¿”å› 1ï¼ˆä½œä¸ºä¸€ä¸ªæ•´ä½“å¯¹è±¡ï¼‰ã€‚ |
| `bool isEmpty() const override` | `bool` | \- | è¿”å›å›¾ç‰‡æ˜¯å¦ä¸º nullã€‚ |
| `QImage image() const` | `QImage` | \- | è·å–å›¾ç‰‡ã€‚ |
| `void setImage(const QImage& image)` | `void` | `const QImage&` | è®¾ç½®å›¾ç‰‡ã€‚ |
| `QSizeF size() const` | `QSizeF` | \- | è·å–æ˜¾ç¤ºå°ºå¯¸ã€‚ |
| `void setSize(const QSizeF& size)` | `void` | `const QSizeF&` | è®¾ç½®æ˜¾ç¤ºå°ºå¯¸ã€‚ |
| `QString caption() const` | `QString` | \- | è·å–æ ‡é¢˜ã€‚ |
| `void setCaption(const QString& caption)` | `void` | `const QString&` | è®¾ç½®æ ‡é¢˜ã€‚ |

---

#### `TableBlock` ç±»ï¼ˆæ¦‚è¦ï¼‰

**ç»§æ‰¿å…³ç³»**  
`Block`

**èŒè´£**

-   è¡¨ç¤ºä¸€ä¸ªè¡¨æ ¼å—ã€‚
    

**å†…éƒ¨ç±» Cell**

```

struct Cell {
    Block* content;       // å¯ä»¥æ˜¯ ParagraphBlock, ImageBlock ç­‰
    int rowSpan;
    int colSpan;
    // è¾¹æ¡†æ ·å¼ç­‰
};

```

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_rows` | `int` | è¡Œæ•°ã€‚ |
| `m_columns` | `int` | åˆ—æ•°ã€‚ |
| `m_cells` | `QVector<QVector<Cell*>>` | å•å…ƒæ ¼çŸ©é˜µã€‚ |
| `m_rowHeights` | `QVector<qreal>` | è¡Œé«˜ï¼ˆå¯è‡ªé€‚åº”ï¼‰ã€‚ |
| `m_colWidths` | `QVector<qreal>` | åˆ—å®½ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `TableBlock` | \- | `int rows, int cols, QObject* parent = nullptr` | æ„é€ æŒ‡å®šè¡Œåˆ—çš„ç©ºè¡¨æ ¼ã€‚ |
| `~TableBlock` | \- | \- | ææ„ï¼Œåˆ é™¤æ‰€æœ‰å•å…ƒæ ¼å†…å®¹ã€‚ |
| `int rows() const` | `int` | \- | è·å–è¡Œæ•°ã€‚ |
| `int columns() const` | `int` | \- | è·å–åˆ—æ•°ã€‚ |
| `Block* cell(int row, int col) const` | `Block*` | `int, int` | è·å–å•å…ƒæ ¼å†…å®¹ï¼ˆæ³¨æ„åˆå¹¶å•å…ƒæ ¼ï¼‰ã€‚ |
| `void setCell(int row, int col, Block* content)` | `void` | `int, int, Block*` | è®¾ç½®å•å…ƒæ ¼å†…å®¹ï¼ˆè¡¨æ ¼è·å¾—æ‰€æœ‰æƒï¼‰ã€‚ |
| `void mergeCells(int row, int col, int rowSpan, int colSpan)` | `void` | `int, int, int, int` | åˆå¹¶å•å…ƒæ ¼ã€‚ |
| `qreal rowHeight(int row) const` | `qreal` | `int` | è·å–è¡Œé«˜ã€‚ |
| `void setRowHeight(int row, qreal height)` | `void` | `int, qreal` | è®¾ç½®è¡Œé«˜ã€‚ |
| `qreal columnWidth(int col) const` | `qreal` | `int` | è·å–åˆ—å®½ã€‚ |
| `void setColumnWidth(int col, qreal width)` | `void` | `int, qreal` | è®¾ç½®åˆ—å®½ã€‚ |
| `int length() const override` | `int` | \- | è¿”å› 1ã€‚ |
| `bool isEmpty() const override` | `bool` | \- | è¿”å› falseï¼ˆè¡¨æ ¼æ€»æœ‰å†…å®¹ï¼‰ã€‚ |

**è®¾è®¡è¦ç‚¹**

-   è¡¨æ ¼å¸ƒå±€å¤æ‚ï¼Œå¯èƒ½éœ€è¦ä¸“é—¨çš„å¸ƒå±€å¼•æ“å¤„ç†ã€‚
    
-   å•å…ƒæ ¼å†…å®¹å¯ä»¥æ˜¯ä»»ä½•å—ç±»å‹ï¼Œå› æ­¤éœ€è¦é€’å½’å¤„ç†ã€‚
    

---

#### `Page` ç±»

**èŒè´£**

-   è¡¨ç¤ºä¸€ä¸ªç‰©ç†é¡µé¢ï¼Œç”±å¸ƒå±€å¼•æ“ç”Ÿæˆï¼Œç”¨äºè§†å›¾æ˜¾ç¤ºã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_pageNumber` | `int` | é¡µç ã€‚ |
| `m_pageRect` | `QRectF` | é¡µé¢çŸ©å½¢ï¼ˆå¦‚ A4 å°ºå¯¸ï¼‰ã€‚ |
| `m_contentRect` | `QRectF` | å†…å®¹åŒºåŸŸï¼ˆé¡µé¢çŸ©å½¢å‡å»è¾¹è·ï¼‰ã€‚ |
| `m_blocks` | `QList<Block*>` | è¯¥é¡µä¸Šçš„å—åˆ—è¡¨ï¼ˆå¼•ç”¨ï¼Œä¸æ‹¥æœ‰æ‰€æœ‰æƒï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `Page` | \- | \- | æ„é€ ã€‚ |
| `~Page` | \- | \- | ææ„ã€‚ |
| `int pageNumber() const` | `int` | \- | è·å–é¡µç ã€‚ |
| `void setPageNumber(int num)` | `void` | `int` | è®¾ç½®é¡µç ã€‚ |
| `QRectF pageRect() const` | `QRectF` | \- | è·å–é¡µé¢çŸ©å½¢ã€‚ |
| `void setPageRect(const QRectF& rect)` | `void` | `const QRectF&` | è®¾ç½®é¡µé¢çŸ©å½¢ã€‚ |
| `QRectF contentRect() const` | `QRectF` | \- | è·å–å†…å®¹åŒºåŸŸã€‚ |
| `void setContentRect(const QRectF& rect)` | `void` | `const QRectF&` | è®¾ç½®å†…å®¹åŒºåŸŸã€‚ |
| `int blockCount() const` | `int` | \- | è¿”å›é¡µä¸Šå—æ•°é‡ã€‚ |
| `Block* block(int index) const` | `Block*` | `int` | è·å–å—ã€‚ |
| `void addBlock(Block* block)` | `void` | `Block*` | æ·»åŠ å—ï¼ˆç”±å¸ƒå±€å¼•æ“è°ƒç”¨ï¼‰ã€‚ |
| `void clearBlocks()` | `void` | \- | æ¸…ç©ºå—åˆ—è¡¨ã€‚ |
| `bool isEmpty() const` | `bool` | \- | åˆ¤æ–­å—åˆ—è¡¨æ˜¯å¦ä¸ºç©ºã€‚ |

**è®¾è®¡è¦ç‚¹**

-   Page å¯¹è±¡ä¸æŒä¹…åŒ–ï¼Œæ¯æ¬¡å¸ƒå±€æ—¶é‡æ–°åˆ›å»ºã€‚
    
-   å—åœ¨é¡µé¢ä¸Šçš„ä½ç½®é€šè¿‡ Block çš„ `boundingRect()` è®¾ç½®ï¼ˆç›¸å¯¹äºé¡µé¢åŸç‚¹ï¼‰ã€‚
    

---

### 2.2 commands å­æ¨¡å—

#### `EditCommand` æŠ½è±¡åŸºç±»

**ç»§æ‰¿å…³ç³»**  
`QUndoCommand`

**èŒè´£**

-   æ‰€æœ‰ç¼–è¾‘å‘½ä»¤çš„åŸºç±»ï¼ŒæŒæœ‰æ–‡æ¡£æŒ‡é’ˆï¼Œæä¾›ä¾¿æ·æ–¹æ³•ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_document` | `Document*` | æ“ä½œçš„æ–‡æ¡£ï¼ˆä¸æ‹¥æœ‰æ‰€æœ‰æƒï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `EditCommand` | \- | `Document* doc, QUndoCommand* parent = nullptr` | æ„é€ å‡½æ•°ï¼Œè®¾ç½®æ–‡æ¡£æŒ‡é’ˆã€‚ |
| `virtual ~EditCommand` | \- | \- | è™šææ„ã€‚ |
| `virtual void undo() = 0` | `void` | \- | æ’¤é”€æ“ä½œã€‚ |
| `virtual void redo() = 0` | `void` | \- | é‡åšæ“ä½œã€‚ |

---

#### `InsertTextCommand` ç±»

**ç»§æ‰¿å…³ç³»**  
`EditCommand`

**èŒè´£**

-   åœ¨æŒ‡å®šå—çš„æŒ‡å®šä½ç½®æ’å…¥æ–‡æœ¬ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_blockIndex` | `int` | å—åœ¨æ–‡æ¡£ä¸­çš„å…¨å±€ç´¢å¼•ã€‚ |
| `m_position` | `int` | å—å†…æ’å…¥ä½ç½®ã€‚ |
| `m_text` | `QString` | æ’å…¥çš„æ–‡æœ¬ã€‚ |
| `m_style` | `CharacterStyle` | ä½¿ç”¨çš„å­—ç¬¦æ ·å¼ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `InsertTextCommand` | \- | `Document* doc, int block, int pos, const QString& text, const CharacterStyle& style, QUndoCommand* parent = nullptr` | æ„é€ ã€‚ |
| `void undo() override` | `void` | \- | åˆ é™¤æ’å…¥çš„æ–‡æœ¬ã€‚ |
| `void redo() override` | `void` | \- | æ’å…¥æ–‡æœ¬ã€‚ |

**å®ç°è¦ç‚¹**

-   `redo()` ä¸­è·å–å¯¹åº”çš„ `ParagraphBlock`ï¼Œè°ƒç”¨å…¶ `insert()` æ–¹æ³•ã€‚
    
-   `undo()` ä¸­è°ƒç”¨ `remove(pos, text.length())`ã€‚
    

**æ³¨æ„äº‹é¡¹**

-   éœ€è¦ç¡®ä¿å—ç´¢å¼•æœ‰æ•ˆï¼Œä¸”å—æ˜¯ ParagraphBlock ç±»å‹ã€‚
    

---

#### `RemoveTextCommand` ç±»

**ç»§æ‰¿å…³ç³»**  
`EditCommand`

**èŒè´£**

-   åˆ é™¤æŒ‡å®šå—çš„æŒ‡å®šèŒƒå›´å†…çš„æ–‡æœ¬ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_blockIndex` | `int` | å—ç´¢å¼•ã€‚ |
| `m_position` | `int` | èµ·å§‹ä½ç½®ã€‚ |
| `m_length` | `int` | åˆ é™¤é•¿åº¦ã€‚ |
| `m_removedSpans` | `QList<Span>` | è¢«åˆ é™¤çš„ span åˆ—è¡¨ï¼ˆç”¨äºæ’¤é”€ï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `RemoveTextCommand` | \- | `Document* doc, int block, int pos, int len, QUndoCommand* parent = nullptr` | æ„é€ ã€‚ |
| `void undo() override` | `void` | \- | é‡æ–°æ’å…¥è¢«åˆ é™¤çš„ spansã€‚ |
| `void redo() override` | `void` | \- | åˆ é™¤æ–‡æœ¬ï¼Œå¹¶ä¿å­˜è¢«åˆ é™¤çš„ spansã€‚ |

**å®ç°è¦ç‚¹**

-   `redo()` ä¸­å…ˆè°ƒç”¨å—çš„ `subSpans(pos, len)` ä¿å­˜ spansï¼Œç„¶åè°ƒç”¨ `remove(pos, len)`ã€‚
    
-   `undo()` ä¸­éœ€è¦å°†ä¿å­˜çš„ spans é‡æ–°æ’å…¥åˆ°åŸä½ç½®ï¼Œå¯èƒ½éœ€è¦å¤„ç†åˆå¹¶ã€‚
    

**æ³¨æ„äº‹é¡¹**

-   éœ€è¦ä¿å­˜å®Œæ•´çš„ span åˆ—è¡¨ä»¥æ¢å¤æ ·å¼ã€‚
    

---

#### `InsertBlockCommand` ç±»

**ç»§æ‰¿å…³ç³»**  
`EditCommand`

**èŒè´£**

-   åœ¨æ–‡æ¡£ä¸­æ’å…¥æ–°å—ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_index` | `int` | æ’å…¥ä½ç½®ï¼ˆ-1 è¡¨ç¤ºè¿½åŠ ï¼‰ã€‚ |
| `m_block` | `Block*` | è¦æ’å…¥çš„å—ï¼ˆå‘½ä»¤æ‹¥æœ‰æ‰€æœ‰æƒï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `InsertBlockCommand` | \- | `Document* doc, int index, Block* block, QUndoCommand* parent = nullptr` | æ„é€ ï¼Œå‘½ä»¤æ¥ç®¡ block æ‰€æœ‰æƒã€‚ |
| `~InsertBlockCommand` | \- | \- | ææ„ï¼Œè‹¥å—æœªè¢«æ–‡æ¡£ç®¡ç†åˆ™åˆ é™¤ã€‚ |
| `void undo() override` | `void` | \- | ä»æ–‡æ¡£ç§»é™¤å—ï¼Œå¹¶å›æ”¶æ‰€æœ‰æƒã€‚ |
| `void redo() override` | `void` | \- | å°†å—æ’å…¥æ–‡æ¡£ã€‚ |

**å®ç°è¦ç‚¹**

-   `redo()` ä¸­è°ƒç”¨æ–‡æ¡£çš„ `insertBlock` æˆ– `addBlock`ã€‚
    
-   `undo()` ä¸­è°ƒç”¨ `removeBlock`ï¼Œå¹¶å°†å—æŒ‡é’ˆä¿å­˜å› m\_blockï¼ˆä»¥ä¾¿é‡åšï¼‰ã€‚
    

---

#### `RemoveBlockCommand` ç±»

**ç»§æ‰¿å…³ç³»**  
`EditCommand`

**èŒè´£**

-   åˆ é™¤æŒ‡å®šå—ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_index` | `int` | è¦åˆ é™¤çš„å—ç´¢å¼•ã€‚ |
| `m_removedBlock` | `Block*` | è¢«åˆ é™¤çš„å—ï¼ˆç”¨äºæ’¤é”€ï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `RemoveBlockCommand` | \- | `Document* doc, int index, QUndoCommand* parent = nullptr` | æ„é€ ã€‚ |
| `~RemoveBlockCommand` | \- | \- | è‹¥ m\_removedBlock æœªè¢«é‡æ–°æ’å…¥åˆ™åˆ é™¤ã€‚ |
| `void undo() override` | `void` | \- | é‡æ–°æ’å…¥è¢«åˆ é™¤çš„å—ã€‚ |
| `void redo() override` | `void` | \- | åˆ é™¤å—å¹¶ä¿å­˜æŒ‡é’ˆã€‚ |

---

#### `SetCharacterStyleCommand` ç±»

**ç»§æ‰¿å…³ç³»**  
`EditCommand`

**èŒè´£**

-   å¯¹é€‰åŒºå†…çš„æ–‡æœ¬è®¾ç½®å­—ç¬¦æ ·å¼ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_range` | `SelectionRange` | é€‰åŒºèŒƒå›´ï¼ˆå¯èƒ½è·¨å—ï¼‰ã€‚ |
| `m_newStyle` | `CharacterStyle` | æ–°æ ·å¼ã€‚ |
| `m_oldSpansMap` | `QHash<int, QList<Span>>` | æ¯ä¸ªå—å½±å“å—çš„åŸå§‹ span åˆ—è¡¨ï¼ˆç”¨äºæ’¤é”€ï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `SetCharacterStyleCommand` | \- | `Document* doc, const SelectionRange& range, const CharacterStyle& style, QUndoCommand* parent = nullptr` | æ„é€ ã€‚ |
| `void undo() override` | `void` | \- | æ¢å¤æ¯ä¸ªå—çš„åŸå§‹ spansã€‚ |
| `void redo() override` | `void` | \- | å¯¹æ¯ä¸ªå—å½±å“å—çš„é€‰åŒºéƒ¨åˆ†åº”ç”¨æ–°æ ·å¼ï¼ŒåŒæ—¶ä¿å­˜åŸå§‹ spansã€‚ |

**å®ç°è¦ç‚¹**

-   éœ€è¦éå†é€‰åŒºæ¶‰åŠçš„æ¯ä¸ªå—ï¼Œå¯¹å—å†…é€‰ä¸­çš„éƒ¨åˆ†åº”ç”¨æ–°æ ·å¼ã€‚
    
-   åº”ç”¨æ ·å¼å¯èƒ½æ¶‰åŠæ‹†åˆ† span å’Œåˆå¹¶æ ·å¼ç›¸åŒçš„ spanã€‚
    

---

#### `SetParagraphStyleCommand` ç±»

**ç»§æ‰¿å…³ç³»**  
`EditCommand`

**èŒè´£**

-   å¯¹æŒ‡å®šæ®µè½è®¾ç½®æ®µè½æ ·å¼ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_blockIndices` | `QList<int>` | å—å½±å“çš„å—ç´¢å¼•åˆ—è¡¨ã€‚ |
| `m_newStyle` | `ParagraphStyle` | æ–°æ ·å¼ã€‚ |
| `m_oldStyles` | `QList<ParagraphStyle>` | æ¯ä¸ªå—çš„æ—§æ ·å¼ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `SetParagraphStyleCommand` | \- | `Document* doc, const QList<int>& indices, const ParagraphStyle& style, QUndoCommand* parent = nullptr` | æ„é€ ã€‚ |
| `void undo() override` | `void` | \- | æ¢å¤æ¯ä¸ªå—çš„æ—§æ ·å¼ã€‚ |
| `void redo() override` | `void` | \- | å¯¹æ¯ä¸ªå—è®¾ç½®æ–°æ ·å¼ï¼Œå¹¶ä¿å­˜æ—§æ ·å¼ã€‚ |

---

### 2.3 layout å­æ¨¡å—

#### `LayoutEngine` ç±»

**ç»§æ‰¿å…³ç³»**  
`QObject`ï¼ˆå¯é€‰ï¼Œç”¨äºå‘å°„ä¿¡å·ï¼‰

**èŒè´£**

-   è´Ÿè´£å°†æ–‡æ¡£å†…å®¹åˆ†é¡µï¼Œè®¡ç®—æ¯ä¸ªå—çš„ä½ç½®å’Œå¤§å°ã€‚
    
-   æ”¯æŒå…¨é‡å¸ƒå±€å’Œå¢é‡å¸ƒå±€ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_document` | `Document*` | å¾…å¸ƒå±€çš„æ–‡æ¡£ï¼ˆä¸æ‹¥æœ‰æ‰€æœ‰æƒï¼‰ã€‚ |
| `m_pageWidth` | `qreal` | é¡µé¢å®½åº¦ã€‚ |
| `m_pageHeight` | `qreal` | é¡µé¢é«˜åº¦ã€‚ |
| `m_margin` | `qreal` | é¡µè¾¹è·ã€‚ |
| `m_cacheHeights` | `QHash<Block*, qreal>` | å—é«˜åº¦ç¼“å­˜ï¼Œé¿å…é‡å¤æµ‹é‡ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `LayoutEngine` | \- | `Document* doc, QObject* parent = nullptr` | æ„é€ å‡½æ•°ï¼Œå…³è”æ–‡æ¡£ã€‚ |
| `void setPageSize(qreal width, qreal height, qreal margin)` | `void` | `qreal, qreal, qreal` | è®¾ç½®é¡µé¢å°ºå¯¸å’Œè¾¹è·ã€‚ |
| `void layout()` | `void` | \- | æ‰§è¡Œå…¨é‡å¸ƒå±€ï¼Œæ¸…ç©ºæ‰€æœ‰é¡µé¢å¹¶é‡æ–°ç”Ÿæˆã€‚ |
| `void layoutFrom(int blockIndex)` | `void` | `int` | ä»æŒ‡å®šå…¨å±€å—ç´¢å¼•å¼€å§‹å¢é‡å¸ƒå±€ï¼ˆç”¨äºç¼–è¾‘åå¿«é€Ÿæ›´æ–°ï¼‰ã€‚ |
| `qreal calculateBlockHeight(Block* block, qreal maxWidth)` | `qreal` | `Block*, qreal` | è®¡ç®—å—çš„é«˜åº¦ï¼Œä½¿ç”¨ç¼“å­˜ã€‚ |
| `void clearCache()` | `void` | \- | æ¸…ç©ºé«˜åº¦ç¼“å­˜ã€‚ |

**ä¿¡å·**

| åç§° | å‚æ•° | æè¿° |
| --- | --- | --- |
| `layoutFinished()` | \- | å¸ƒå±€å®Œæˆåå‘å‡ºã€‚ |

**å¸ƒå±€ç®—æ³•ï¼ˆä¼ªä»£ç ï¼‰**

```

void LayoutEngine::layout() {
    // æ¸…ç©ºæ‰€æœ‰èŠ‚ä¸­çš„é¡µé¢
    for each section in document:
        section->clearPages();

    qreal contentWidth = m_pageWidth - 2 * m_margin;
    qreal contentHeight = m_pageHeight - 2 * m_margin;

    for each section in document:
        PageBuilder builder(m_pageWidth, m_pageHeight, m_margin);
        for each block in section:
            qreal blockHeight = calculateBlockHeight(block, contentWidth);
            if (!builder.tryAddBlock(block, blockHeight)) {
                // å½“å‰é¡µå·²æ»¡ï¼Œå®Œæˆå½“å‰é¡µ
                Page* page = builder.finishPage();
                section->addPage(page);
                // å°†å½“å‰å—æ”¾å…¥æ–°é¡µ
                builder.reset();
                builder.tryAddBlock(block, blockHeight);
            }
        // èŠ‚ç»“æŸåï¼Œå®Œæˆæœ€åä¸€é¡µ
        if (!builder.isEmpty()) {
            Page* page = builder.finishPage();
            section->addPage(page);
        }
    }
    emit layoutFinished();
}

```

---

#### `PageBuilder` ç±»

**èŒè´£**

-   è¾…åŠ© `LayoutEngine` å°†å—åˆ†é…åˆ°é¡µé¢ï¼Œç®¡ç†å½“å‰é¡µçš„å‰©ä½™ç©ºé—´ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_pageWidth` | `qreal` | é¡µé¢å®½åº¦ã€‚ |
| `m_pageHeight` | `qreal` | é¡µé¢é«˜åº¦ã€‚ |
| `m_margin` | `qreal` | è¾¹è·ã€‚ |
| `m_contentWidth` | `qreal` | å†…å®¹å®½åº¦ã€‚ |
| `m_contentHeight` | `qreal` | å†…å®¹é«˜åº¦ã€‚ |
| `m_currentY` | `qreal` | å½“å‰é¡µå·²ç”¨é«˜åº¦ã€‚ |
| `m_blocks` | `QList<Block*>` | å½“å‰é¡µçš„å—åˆ—è¡¨ã€‚ |
| `m_page` | `Page*` | æ­£åœ¨æ„å»ºçš„é¡µé¢å¯¹è±¡ï¼ˆåœ¨ finishPage æ—¶åˆ›å»ºï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `PageBuilder` | \- | `qreal pageWidth, qreal pageHeight, qreal margin` | æ„é€ å‡½æ•°ã€‚ |
| `bool tryAddBlock(Block* block, qreal blockHeight)` | `bool` | `Block*, qreal` | å°è¯•å°†å—åŠ å…¥å½“å‰é¡µï¼Œå¦‚æœå‰©ä½™ç©ºé—´è¶³å¤Ÿåˆ™æ·»åŠ å¹¶è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚ |
| `Page* finishPage()` | `Page*` | \- | å®Œæˆå½“å‰é¡µï¼Œåˆ›å»º Page å¯¹è±¡å¹¶è®¾ç½®å…¶å—åˆ—è¡¨å’Œä½ç½®ä¿¡æ¯ï¼ˆæ¯ä¸ªå—çš„ boundingRect ç›¸å¯¹äºé¡µé¢åŸç‚¹ï¼‰ã€‚è¿”å›æ–°å»ºçš„ Pageã€‚ |
| `void reset()` | `void` | \- | é‡ç½®ä¸ºæ–°å»ºé¡µçŠ¶æ€ã€‚ |
| `bool isEmpty() const` | `bool` | \- | åˆ¤æ–­å½“å‰é¡µæ˜¯å¦æ— å—ã€‚ |

**å®ç°è¦ç‚¹**

-   `tryAddBlock` ä¸­ä¼šè®¾ç½®å—çš„ `boundingRect` ç›¸å¯¹äºé¡µé¢åŸç‚¹ï¼ˆå·¦ä¸Šè§’ï¼‰ï¼Œå¹¶ç´¯åŠ  `m_currentY`ã€‚
    
-   `finishPage` ä¸­ä¼šåˆ›å»º Pageï¼Œå¹¶è®¾ç½®å…¶ `pageRect` å’Œ `contentRect`ã€‚
    

---

### 2.4 styles å­æ¨¡å—

#### `StyleManager` ç±»

**èŒè´£**

-   ç®¡ç†æ–‡æ¡£ä¸­çš„å‘½åæ ·å¼ï¼ˆç±»ä¼¼äº Word çš„æ ·å¼åº“ï¼‰ã€‚
    
-   æä¾›æ ·å¼çš„æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹å’Œåº”ç”¨ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_characterStyles` | `QHash<QString, CharacterStyle>` | å­—ç¬¦æ ·å¼å­—å…¸ã€‚ |
| `m_paragraphStyles` | `QHash<QString, ParagraphStyle>` | æ®µè½æ ·å¼å­—å…¸ã€‚ |
| `m_document` | `Document*` | å…³è”çš„æ–‡æ¡£ï¼ˆå¯é€‰ï¼Œç”¨äºé€šçŸ¥æ›´æ–°ï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `StyleManager` | \- | `Document* doc = nullptr, QObject* parent = nullptr` | æ„é€ å‡½æ•°ã€‚ |
| `void addCharacterStyle(const QString& name, const CharacterStyle& style)` | `void` | `const QString&, const CharacterStyle&` | æ·»åŠ å­—ç¬¦æ ·å¼ï¼Œè‹¥å·²å­˜åœ¨åˆ™è¦†ç›–ã€‚ |
| `void removeCharacterStyle(const QString& name)` | `void` | `const QString&` | åˆ é™¤å­—ç¬¦æ ·å¼ã€‚ |
| `CharacterStyle characterStyle(const QString& name) const` | `CharacterStyle` | `const QString&` | è·å–å­—ç¬¦æ ·å¼ï¼Œè‹¥ä¸å­˜åœ¨è¿”å›é»˜è®¤æ ·å¼ã€‚ |
| `QStringList characterStyleNames() const` | `QStringList` | \- | è·å–æ‰€æœ‰å­—ç¬¦æ ·å¼åã€‚ |
| `void applyCharacterStyle(Selection* selection, const QString& name)` | `void` | `Selection*, const QString&` | å°†æŒ‡å®šå­—ç¬¦æ ·å¼åº”ç”¨åˆ°é€‰åŒºã€‚å†…éƒ¨ä¼šåˆ›å»º `SetCharacterStyleCommand` å¹¶æ¨å…¥æ’¤é”€æ ˆã€‚ |
| ç±»ä¼¼æ–¹æ³•ç”¨äºæ®µè½æ ·å¼... |  |  |  |

**è®¾è®¡è¦ç‚¹**

-   æ ·å¼å¯åŸºäºå…¶ä»–æ ·å¼ç»§æ‰¿ï¼ˆæš‚æœªå®ç°ï¼‰ã€‚
    
-   æ ·å¼å˜åŒ–æ—¶ï¼Œåº”æ›´æ–°æ‰€æœ‰åº”ç”¨è¯¥æ ·å¼çš„æ–‡æœ¬åŒºåŸŸï¼ˆå¯é€šè¿‡éå†æ–‡æ¡£å®ç°ï¼Œä½†å¯èƒ½æ€§èƒ½å¼€é”€å¤§ï¼‰ã€‚
    

---

### 2.5 utils å­æ¨¡å—

#### `FontUtils` ç±»ï¼ˆé™æ€ï¼‰

**èŒè´£**

-   æä¾›å­—ä½“ç›¸å…³çš„å·¥å…·æ–¹æ³•ã€‚
    

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `qreal ptToPx(qreal pt)` | `qreal` | `qreal` | ç‚¹è½¬æ¢ä¸ºåƒç´ ï¼ˆåŸºäº 96 DPIï¼‰ã€‚ |
| `qreal pxToPt(qreal px)` | `qreal` | `qreal` | åƒç´ è½¬æ¢ä¸ºç‚¹ã€‚ |
| `QFont defaultFont()` | `QFont` | \- | è¿”å›é»˜è®¤å­—ä½“ï¼ˆå¦‚ Arial 12ptï¼‰ã€‚ |
| `QStringList standardFontFamilies()` | `QStringList` | \- | è¿”å›ç³»ç»Ÿå¸¸ç”¨å­—ä½“åˆ—è¡¨ã€‚ |
| `qreal textWidth(const QString& text, const QFont& font)` | `qreal` | `const QString&, const QFont&` | è®¡ç®—æ–‡æœ¬å®½åº¦ï¼ˆä½¿ç”¨ QFontMetricsï¼‰ã€‚ |

#### `Constants.h` å¤´æ–‡ä»¶

å®šä¹‰å…¨å±€å¸¸é‡ï¼š

```

namespace Constants {
    const qreal PAGE_WIDTH = 595.0;   // A4 å®½åº¦ï¼ˆç‚¹ï¼‰
    const qreal PAGE_HEIGHT = 842.0;  // A4 é«˜åº¦
    const qreal PAGE_MARGIN = 72.0;   // 1 è‹±å¯¸è¾¹è·
    const int DEFAULT_FONT_SIZE = 12;
    const qreal ZOOM_MIN = 0.5;
    const qreal ZOOM_MAX = 3.0;
    const qreal ZOOM_STEP = 0.1;
    const int CURSOR_BLINK_INTERVAL = 500; // æ¯«ç§’
    const qreal CURSOR_WIDTH = 2.0;
    const QColor SELECTION_COLOR = QColor(173, 216, 230, 120); // æµ…è“è‰²åŠé€æ˜
}

```

---

## 3\. editcontrol æ¨¡å—

### 3.1 cursor å­æ¨¡å—

#### `CursorPosition` ç»“æ„ä½“

```

struct CursorPosition {
    int blockIndex;  // å…¨å±€å—ç´¢å¼•
    int offset;      // å—å†…åç§»ï¼ˆ0 ~ å—é•¿åº¦ï¼‰
    bool operator==(const CursorPosition& other) const;
    bool operator!=(const CursorPosition& other) const;
    bool isValid(const Document* doc) const; // æ£€æŸ¥æ˜¯å¦æœ‰æ•ˆ
};

```

#### `Cursor` ç±»

**ç»§æ‰¿å…³ç³»**  
`QObject`

**èŒè´£**

-   ç®¡ç†å…‰æ ‡ä½ç½®ï¼Œæä¾›ç§»åŠ¨å’Œç¼–è¾‘æ“ä½œï¼ˆå®é™…è°ƒç”¨å‘½ä»¤ï¼‰ã€‚
    
-   å‘å‡ºä½ç½®å˜åŒ–ä¿¡å·ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_position` | `CursorPosition` | å½“å‰å…‰æ ‡ä½ç½®ã€‚ |
| `m_document` | `Document*` | å…³è”çš„æ–‡æ¡£ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `Cursor` | \- | `Document* doc, QObject* parent = nullptr` | æ„é€ ï¼Œå…³è”æ–‡æ¡£ã€‚ |
| `CursorPosition position() const` | `CursorPosition` | \- | è·å–ä½ç½®ã€‚ |
| `void setPosition(int block, int offset)` | `void` | `int, int` | è®¾ç½®ä½ç½®ï¼Œè‹¥å˜åŒ–å‘å‡ºä¿¡å·ã€‚ |
| `void setPosition(const CursorPosition& pos)` | `void` | `const CursorPosition&` | åŒä¸Šã€‚ |
| `void moveLeft()` | `void` | \- | å‘å·¦ç§»åŠ¨ä¸€ä¸ªå­—ç¬¦ï¼Œè·¨å—æ—¶ç§»åŠ¨åˆ°ä¸Šä¸€å—æœ«å°¾ã€‚ |
| `void moveRight()` | `void` | \- | å‘å³ç§»åŠ¨ã€‚ |
| `void moveUp()` | `void` | \- | å‘ä¸Šç§»åŠ¨åˆ°ä¸Šä¸€è¡Œçš„ç›¸åŒæ°´å¹³ä½ç½®ï¼ˆéœ€é…åˆå¸ƒå±€å¼•æ“ï¼‰ã€‚ |
| `void moveDown()` | `void` | \- | å‘ä¸‹ç§»åŠ¨ã€‚ |
| `void moveToStartOfBlock()` | `void` | \- | ç§»åŠ¨åˆ°å½“å‰å—å¼€å¤´ã€‚ |
| `void moveToEndOfBlock()` | `void` | \- | ç§»åŠ¨åˆ°å½“å‰å—æœ«å°¾ã€‚ |
| `void moveToStartOfDocument()` | `void` | \- | ç§»åŠ¨åˆ°æ–‡æ¡£å¼€å¤´ã€‚ |
| `void moveToEndOfDocument()` | `void` | \- | ç§»åŠ¨åˆ°æ–‡æ¡£æœ«å°¾ã€‚ |
| `void insertText(const QString& text, const CharacterStyle& style)` | `void` | `const QString&, const CharacterStyle&` | åœ¨å½“å‰å…‰æ ‡å¤„æ’å…¥æ–‡æœ¬ï¼ˆåˆ›å»ºå‘½ä»¤ï¼‰ã€‚ |
| `void deletePreviousChar()` | `void` | \- | åˆ é™¤å…‰æ ‡å‰ä¸€ä¸ªå­—ç¬¦ã€‚ |
| `void deleteNextChar()` | `void` | \- | åˆ é™¤å…‰æ ‡åä¸€ä¸ªå­—ç¬¦ã€‚ |
| `void splitBlock()` | `void` | \- | åœ¨å…‰æ ‡å¤„åˆ†å‰²æ®µè½ï¼ˆæ’å…¥æ–°å—ï¼‰ã€‚ |

**ä¿¡å·**

| åç§° | å‚æ•° | æè¿° |
| --- | --- | --- |
| `positionChanged()` | \- | å…‰æ ‡ä½ç½®å˜åŒ–æ—¶å‘å‡ºã€‚ |

**å®ç°è¦ç‚¹**

-   ç§»åŠ¨æ“ä½œéœ€è€ƒè™‘è¾¹ç•Œæƒ…å†µï¼šæ–‡æ¡£ä¸ºç©ºã€è·¨å—ã€ç©ºå—ç­‰ã€‚
    
-   æ’å…¥/åˆ é™¤æ“ä½œåº”é€šè¿‡å‘½ä»¤å®ç°ï¼Œå¹¶æ›´æ–°å…‰æ ‡ä½ç½®ã€‚
    

---

### 3.2 selection å­æ¨¡å—

#### `SelectionRange` ç»“æ„ä½“

```

struct SelectionRange {
    int startBlock, startOffset;
    int endBlock, endOffset;
    bool isEmpty() const { return startBlock == endBlock && startOffset == endOffset; }
    void normalize(); // ç¡®ä¿ start <= end
    bool contains(const CursorPosition& pos) const; // åˆ¤æ–­æ˜¯å¦åŒ…å«æŸä½ç½®
};

```

#### `Selection` ç±»

**ç»§æ‰¿å…³ç³»**  
`QObject`

**èŒè´£**

-   ç®¡ç†é€‰åŒºï¼ˆæ”¯æŒå¤šæ®µé€‰åŒºï¼‰ã€‚
    
-   å‘å‡ºé€‰åŒºå˜åŒ–ä¿¡å·ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_ranges` | `QList<SelectionRange>` | é€‰åŒºèŒƒå›´åˆ—è¡¨ã€‚ |
| `m_document` | `Document*` | å…³è”çš„æ–‡æ¡£ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `Selection` | \- | `Document* doc, QObject* parent = nullptr` | æ„é€ ã€‚ |
| `QList<SelectionRange> ranges() const` | `QList<SelectionRange>` | \- | è·å–é€‰åŒºèŒƒå›´åˆ—è¡¨ã€‚ |
| `void setRange(const SelectionRange& range)` | `void` | `const SelectionRange&` | è®¾ä¸ºå•æ®µé€‰åŒºã€‚ |
| `void addRange(const SelectionRange& range)` | `void` | `const SelectionRange&` | æ·»åŠ ä¸€æ®µé€‰åŒºï¼ˆéœ€å¤„ç†é‡å å’Œåˆå¹¶ï¼‰ã€‚ |
| `void clear()` | `void` | \- | æ¸…ç©ºé€‰åŒºã€‚ |
| `bool isEmpty() const` | `bool` | \- | åˆ¤æ–­æ˜¯å¦æœ‰ä»»ä½•é€‰åŒºã€‚ |
| `void extend(const CursorPosition& pos)` | `void` | `const CursorPosition&` | å°†å½“å‰é€‰åŒºæ‰©å±•åˆ°æŒ‡å®šä½ç½®ï¼ˆç±»ä¼¼ Shift+ç‚¹å‡»ï¼‰ã€‚ |
| `QString selectedText() const` | `QString` | \- | è·å–é€‰ä¸­çš„çº¯æ–‡æœ¬ã€‚ |
| `QList<Span> selectedSpans() const` | `QList<Span>` | \- | è·å–å¸¦æ ·å¼çš„ span åˆ—è¡¨ï¼ˆè·¨å—æ‹¼æ¥ï¼‰ã€‚ |
| `bool hasSelection() const` | `bool` | \- | åŒ `!isEmpty()`ã€‚ |

**ä¿¡å·**

| åç§° | å‚æ•° | æè¿° |
| --- | --- | --- |
| `selectionChanged()` | \- | é€‰åŒºå˜åŒ–æ—¶å‘å‡ºã€‚ |

**å®ç°è¦ç‚¹**

-   å¤šæ®µé€‰åŒºéœ€è¦æ”¯æŒï¼Œä½†åœ¨ UI ä¸Šå¯èƒ½æš‚åªå®ç°å•æ®µã€‚
    
-   `extend` é€šå¸¸é…åˆé¼ æ ‡æ‹–åŠ¨æˆ– Shift+ç‚¹å‡»ä½¿ç”¨ã€‚
    

---

### 3.3 handlers å­æ¨¡å—

#### `EditEventHandler` ç±»

**ç»§æ‰¿å…³ç³»**  
`QObject`

**èŒè´£**

-   æ¥æ”¶è¾“å…¥äº‹ä»¶ï¼Œæ›´æ–°å…‰æ ‡/é€‰åŒºï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„ç¼–è¾‘å‘½ä»¤ã€‚
    
-   ä¸ç›´æ¥ä¿®æ”¹è§†å›¾ï¼Œåªä¿®æ”¹æ¨¡å‹ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_document` | `Document*` | æ–‡æ¡£ã€‚ |
| `m_cursor` | `Cursor*` | å…‰æ ‡ã€‚ |
| `m_selection` | `Selection*` | é€‰åŒºã€‚ |
| `m_view` | `QGraphicsView*` | è§†å›¾æŒ‡é’ˆï¼ˆç”¨äºåæ ‡è½¬æ¢ï¼Œå¯é€‰ï¼‰ã€‚ |
| `m_isMouseDown` | `bool` | é¼ æ ‡æ˜¯å¦æŒ‰ä¸‹ï¼ˆç”¨äºæ‹–é€‰ï¼‰ã€‚ |
| `m_dragStartPos` | `CursorPosition` | æ‹–é€‰èµ·å§‹å…‰æ ‡ä½ç½®ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `EditEventHandler` | \- | `Document* doc, Cursor* cursor, Selection* selection, QGraphicsView* view = nullptr, QObject* parent = nullptr` | æ„é€ ã€‚ |
| `bool handleKeyPress(QKeyEvent* event)` | `bool` | `QKeyEvent*` | å¤„ç†æŒ‰é”®äº‹ä»¶ï¼Œè¿”å› true è¡¨ç¤ºå·²å¤„ç†ã€‚ |
| `bool handleMousePress(QMouseEvent* event)` | `bool` | `QMouseEvent*` | å¤„ç†é¼ æ ‡æŒ‰ä¸‹ã€‚ |
| `bool handleMouseMove(QMouseEvent* event)` | `bool` | `QMouseEvent*` | å¤„ç†é¼ æ ‡ç§»åŠ¨ï¼ˆç”¨äºæ‹–é€‰ï¼‰ã€‚ |
| `bool handleMouseRelease(QMouseEvent* event)` | `bool` | `QMouseEvent*` | å¤„ç†é¼ æ ‡é‡Šæ”¾ã€‚ |
| `bool handleInputMethod(QInputMethodEvent* event)` | `bool` | `QInputMethodEvent*` | å¤„ç†è¾“å…¥æ³•äº‹ä»¶ã€‚ |

**å®ç°è¦ç‚¹ï¼ˆé”®ç›˜ï¼‰**

-   æ™®é€šå­—ç¬¦ï¼šè°ƒç”¨ `m_cursor->insertText(event->text(), currentStyle)`ã€‚
    
-   Backspaceï¼šè°ƒç”¨ `m_cursor->deletePreviousChar()`ã€‚
    
-   Deleteï¼šè°ƒç”¨ `m_cursor->deleteNextChar()`ã€‚
    
-   Enterï¼šè°ƒç”¨ `m_cursor->splitBlock()`ã€‚
    
-   æ–¹å‘é”®ï¼šè°ƒç”¨å…‰æ ‡ç§»åŠ¨æ–¹æ³•ï¼Œå¹¶æ¸…é™¤é€‰åŒºï¼ˆé™¤é Shift æŒ‰ä¸‹ï¼‰ã€‚
    
-   Ctrl+Aï¼šå…¨é€‰ï¼Œè°ƒç”¨ `selectAll()`ã€‚
    

**å®ç°è¦ç‚¹ï¼ˆé¼ æ ‡ï¼‰**

-   é¼ æ ‡æŒ‰ä¸‹ï¼šæ ¹æ®ç‚¹å‡»ä½ç½®ç¡®å®šå…‰æ ‡ä½ç½®ï¼ˆéœ€é€šè¿‡è§†å›¾åæ ‡è½¬æ¢å’Œå¸ƒå±€ä¿¡æ¯ï¼‰ï¼Œç§»åŠ¨å…‰æ ‡ï¼ˆè‹¥ Shift æŒ‰ä¸‹åˆ™æ‰©å±•é€‰åŒºï¼Œå¦åˆ™è®¾ç½®æ–°å…‰æ ‡å¹¶æ¸…é™¤é€‰åŒºï¼‰ã€‚
    
-   é¼ æ ‡ç§»åŠ¨å¹¶æŒ‰ä¸‹ï¼šæ‰©å±•é€‰åŒºåˆ°å½“å‰ä½ç½®ã€‚
    
-   é¼ æ ‡é‡Šæ”¾ï¼šç»“æŸæ‹–é€‰ã€‚
    

---

### 3.4 formatting å­æ¨¡å—

#### `FormatController` ç±»

**ç»§æ‰¿å…³ç³»**  
`QObject`

**èŒè´£**

-   æä¾›åº”ç”¨å­—ç¬¦æ ·å¼å’Œæ®µè½æ ·å¼çš„ä¾¿æ·æ–¹æ³•ã€‚
    
-   å†…éƒ¨åˆ›å»ºå‘½ä»¤å¹¶æ¨å…¥æ’¤é”€æ ˆã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_document` | `Document*` | æ–‡æ¡£ã€‚ |
| `m_selection` | `Selection*` | é€‰åŒºï¼ˆè‹¥ä¸ºç©ºï¼Œåˆ™åº”ç”¨äºå½“å‰å…‰æ ‡ä½ç½®ï¼‰ã€‚ |
| `m_styleManager` | `StyleManager*` | æ ·å¼ç®¡ç†å™¨ï¼ˆå¯é€‰ï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `FormatController` | \- | `Document* doc, Selection* selection = nullptr, QObject* parent = nullptr` | æ„é€ ã€‚ |
| `void applyCharacterStyle(const CharacterStyle& style)` | `void` | `const CharacterStyle&` | åº”ç”¨å­—ç¬¦æ ·å¼åˆ°é€‰åŒºæˆ–å½“å‰å…‰æ ‡ä½ç½®ã€‚ |
| `void applyParagraphStyle(const ParagraphStyle& style)` | `void` | `const ParagraphStyle&` | åº”ç”¨åˆ°é€‰åŒºè¦†ç›–çš„æ®µè½ã€‚ |
| `void setFont(const QFont& font)` | `void` | `const QFont&` | ä¾¿æ·æ–¹æ³•ï¼šè®¾ç½®å­—ä½“ã€‚ |
| `void setFontSize(int size)` | `void` | `int` | è®¾ç½®å­—å·ã€‚ |
| `void setBold(bool bold)` | `void` | `bool` | è®¾ç½®ç²—ä½“ã€‚ |
| `void setItalic(bool italic)` | `void` | `bool` | è®¾ç½®æ–œä½“ã€‚ |
| `void setUnderline(bool underline)` | `void` | `bool` | è®¾ç½®ä¸‹åˆ’çº¿ã€‚ |
| `void setTextColor(const QColor& color)` | `void` | `const QColor&` | è®¾ç½®æ–‡å­—é¢œè‰²ã€‚ |
| `void setAlignment(ParagraphAlignment align)` | `void` | `ParagraphAlignment` | è®¾ç½®å¯¹é½æ–¹å¼ã€‚ |
| `CharacterStyle currentCharacterStyle() const` | `CharacterStyle` | \- | è·å–å½“å‰å…‰æ ‡ä½ç½®å¤„çš„å­—ç¬¦æ ·å¼ã€‚ |
| `ParagraphStyle currentParagraphStyle() const` | `ParagraphStyle` | \- | è·å–å½“å‰å…‰æ ‡æ‰€åœ¨æ®µè½çš„æ ·å¼ã€‚ |

**å®ç°è¦ç‚¹**

-   å¦‚æœé€‰åŒºéç©ºï¼Œåˆ™åˆ›å»º `SetCharacterStyleCommand` æˆ– `SetParagraphStyleCommand` å¹¶æ¨å…¥æ’¤é”€æ ˆã€‚
    
-   å¦‚æœé€‰åŒºä¸ºç©ºï¼Œåˆ™è®¾ç½®å½“å‰å…‰æ ‡å¤„çš„æ ·å¼ï¼Œå½±å“åç»­è¾“å…¥ï¼ˆå¯é€šè¿‡è®¾ç½®ä¸€ä¸ªâ€œå¾…åº”ç”¨æ ·å¼â€æ ‡è®°ï¼Œç”±è¾“å…¥å‘½ä»¤è¯»å–ï¼‰ã€‚
    

---

## 4\. graphics æ¨¡å—

### 4.1 scene å­æ¨¡å—

#### `DocumentScene` ç±»

**ç»§æ‰¿å…³ç³»**  
`QGraphicsScene`

**èŒè´£**

-   ç®¡ç†æ‰€æœ‰å›¾å½¢é¡¹ï¼Œæ ¹æ®æ–‡æ¡£æ•°æ®æ„å»ºåœºæ™¯ã€‚
    
-   ç»´æŠ¤å—åˆ°å›¾å½¢é¡¹çš„æ˜ å°„ï¼Œå“åº”æ–‡æ¡£ä¿¡å·è¿›è¡Œå¢é‡æ›´æ–°ã€‚
    
-   æä¾›æ›´æ–°å…‰æ ‡å’Œé€‰åŒºçš„æ–¹æ³•ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_cursorItem` | `CursorItem*` | å…‰æ ‡å›¾å½¢é¡¹ã€‚ |
| `m_selectionItem` | `SelectionItem*` | é€‰åŒºå›¾å½¢é¡¹ã€‚ |
| `m_blockItems` | `QHash<Block*, BaseBlockItem*>` | å—åˆ°å›¾å½¢é¡¹çš„æ˜ å°„ã€‚ |
| `m_currentDocument` | `Document*` | å½“å‰æ˜¾ç¤ºçš„æ–‡æ¡£ï¼ˆä»…ç”¨äºè¿æ¥ä¿¡å·ï¼Œä¸æ‹¥æœ‰ï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `DocumentScene` | \- | `QObject* parent = nullptr` | æ„é€ ï¼Œåˆ›å»ºå…‰æ ‡é¡¹å’Œé€‰åŒºé¡¹ã€‚ |
| `~DocumentScene` | \- | \- | ææ„ã€‚ |
| `void setDocument(Document* doc)` | `void` | `Document*` | è®¾ç½®æ–‡æ¡£ï¼Œæ–­å¼€æ—§æ–‡æ¡£ä¿¡å·ï¼Œè¿æ¥æ–°æ–‡æ¡£ä¿¡å·ï¼Œå¹¶é‡å»ºåœºæ™¯ã€‚ |
| `void rebuildFromDocument()` | `void` | \- | å…¨é‡é‡å»ºåœºæ™¯ï¼ˆæ¸…é™¤ç°æœ‰é¡¹ï¼Œæ ¹æ®æ–‡æ¡£åˆ›å»ºé¡µé¢å’Œå—é¡¹ï¼‰ã€‚ |
| `void updateCursor(const QPointF& pos, qreal height)` | `void` | `const QPointF&, qreal` | æ›´æ–°å…‰æ ‡ä½ç½®ã€‚ |
| `void updateSelection(const QList<QRectF>& rects)` | `void` | `const QList<QRectF>&` | æ›´æ–°é€‰åŒºçŸ©å½¢ã€‚ |
| `void clearSelection()` | `void` | \- | æ¸…ç©ºé€‰åŒºã€‚ |
| `CursorItem* cursorItem() const` | `CursorItem*` | \- | è·å–å…‰æ ‡é¡¹ã€‚ |
| `SelectionItem* selectionItem() const` | `SelectionItem*` | \- | è·å–é€‰åŒºé¡¹ã€‚ |

**ç§æœ‰æ§½**

| åç§° | å‚æ•° | æè¿° |
| --- | --- | --- |
| `onBlockAdded(int index)` | `int` | å½“æ–‡æ¡£æ·»åŠ å—æ—¶ï¼Œæ‰¾åˆ°å¯¹åº”çš„é¡µé¢å¹¶åˆ›å»ºå—é¡¹ã€‚ |
| `onBlockRemoved(int index)` | `int` | ç§»é™¤å—é¡¹ã€‚ |
| `onLayoutChanged()` | \- | å¸ƒå±€å˜åŒ–æ—¶ï¼Œæ›´æ–°æ‰€æœ‰å—é¡¹çš„ä½ç½®å’Œå¤§å°ã€‚ |

**å®ç°è¦ç‚¹**

-   åœ¨ `rebuildFromDocument` ä¸­ï¼Œéå†èŠ‚å’Œé¡µé¢ï¼Œåˆ›å»º `PageItem`ï¼Œå¹¶é€šè¿‡ `BlockItemFactory` åˆ›å»ºå—é¡¹ä½œä¸º `PageItem` çš„å­é¡¹ã€‚
    
-   å°†æ¯ä¸ªå—é¡¹æ’å…¥ `m_blockItems` æ˜ å°„ã€‚
    
-   åœ¨å¢é‡æ›´æ–°æ§½ä¸­ï¼Œåªæ›´æ–°å—å½±å“çš„å—é¡¹æˆ–é¡µé¢ã€‚
    

---

### 4.2 view å­æ¨¡å—

#### `DocumentView` ç±»

**ç»§æ‰¿å…³ç³»**  
`QGraphicsView`

**èŒè´£**

-   è´Ÿè´£æ–‡æ¡£çš„ç¼©æ”¾ã€æ»šåŠ¨ã€äº‹ä»¶è½¬å‘ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_scene` | `DocumentScene*` | åœºæ™¯ã€‚ |
| `m_zoom` | `qreal` | å½“å‰ç¼©æ”¾æ¯”ä¾‹ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `DocumentView` | \- | `QWidget* parent = nullptr` | æ„é€ ã€‚ |
| `void setDocumentScene(DocumentScene* scene)` | `void` | `DocumentScene*` | è®¾ç½®åœºæ™¯ã€‚ |
| `DocumentScene* documentScene() const` | `DocumentScene*` | \- | è·å–åœºæ™¯ã€‚ |
| `void setZoom(qreal zoom)` | `void` | `qreal` | è®¾ç½®ç¼©æ”¾æ¯”ä¾‹ï¼Œé™åˆ¶åœ¨ `ZOOM_MIN` å’Œ `ZOOM_MAX` ä¹‹é—´ã€‚ |
| `qreal zoom() const` | `qreal` | \- | è·å–ç¼©æ”¾æ¯”ä¾‹ã€‚ |
| `void zoomIn()` | `void` | \- | æ”¾å¤§ã€‚ |
| `void zoomOut()` | `void` | \- | ç¼©å°ã€‚ |
| `void zoomToFit()` | `void` | \- | ç¼©æ”¾åˆ°é€‚åº”çª—å£ã€‚ |
| `void centerOnCursor()` | `void` | \- | å°†è§†å›¾ä¸­å¿ƒç§»åˆ°å…‰æ ‡ä½ç½®ã€‚ |

**ä¿¡å·**

| åç§° | å‚æ•° | æè¿° |
| --- | --- | --- |
| `keyPressed(QKeyEvent*)` | `QKeyEvent*` | æŒ‰é”®æŒ‰ä¸‹æ—¶å‘å°„ã€‚ |
| `mousePressed(QMouseEvent*)` | `QMouseEvent*` | é¼ æ ‡æŒ‰ä¸‹ã€‚ |
| `mouseMoved(QMouseEvent*)` | `QMouseEvent*` | é¼ æ ‡ç§»åŠ¨ã€‚ |
| `mouseReleased(QMouseEvent*)` | `QMouseEvent*` | é¼ æ ‡é‡Šæ”¾ã€‚ |
| `inputMethodReceived(QInputMethodEvent*)` | `QInputMethodEvent*` | è¾“å…¥æ³•äº‹ä»¶ã€‚ |

**é‡å†™çš„äº‹ä»¶**

-   `wheelEvent`ï¼šè‹¥æŒ‰ Ctrl åˆ™ç¼©æ”¾ï¼Œå¦åˆ™æ»šåŠ¨ã€‚
    
-   `keyPressEvent`ï¼šå‘å°„ä¿¡å·åè°ƒç”¨åŸºç±»ã€‚
    
-   `mousePressEvent`ï¼šå‘å°„ä¿¡å·åè°ƒç”¨åŸºç±»ã€‚
    
-   `mouseMoveEvent`ï¼šåŒä¸Šã€‚
    
-   `mouseReleaseEvent`ï¼šåŒä¸Šã€‚
    
-   `inputMethodEvent`ï¼šå‘å°„ä¿¡å·åè°ƒç”¨åŸºç±»ã€‚
    

---

### 4.3 items å­æ¨¡å—

#### `BaseBlockItem` æŠ½è±¡ç±»

**ç»§æ‰¿å…³ç³»**  
`QGraphicsRectItem`

**èŒè´£**

-   æ‰€æœ‰å—å›¾å½¢é¡¹çš„åŸºç±»ï¼ŒæŒæœ‰å¯¹åº”çš„ Block æŒ‡é’ˆã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_block` | `Block*` | å…³è”çš„å—ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `BaseBlockItem` | \- | `Block* block, QGraphicsItem* parent = nullptr` | æ„é€ ã€‚ |
| `virtual ~BaseBlockItem` | \- | \- | ææ„ã€‚ |
| `Block* block() const` | `Block*` | \- | è·å–å—ã€‚ |
| `virtual void updateBlock() = 0` | `void` | \- | æ ¹æ®å—æ•°æ®æ›´æ–°å›¾å½¢é¡¹ï¼ˆä½ç½®ã€å¤§å°ã€å†…å®¹ï¼‰ã€‚ |

---

#### `TextBlockItem` ç±»

**ç»§æ‰¿å…³ç³»**  
`BaseBlockItem`

**èŒè´£**

-   ç»˜åˆ¶æ–‡æœ¬æ®µè½å—ï¼Œå†…éƒ¨ä½¿ç”¨ `QGraphicsTextItem`ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_textItem` | `QGraphicsTextItem*` | ç”¨äºæ˜¾ç¤ºæ–‡æœ¬çš„é¡¹ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `TextBlockItem` | \- | `ParagraphBlock* block, QGraphicsItem* parent = nullptr` | æ„é€ ã€‚ |
| `void updateBlock() override` | `void` | \- | ä» block è¯»å–æ–‡æœ¬å’Œæ ·å¼ï¼Œè®¾ç½®åˆ° m\_textItemï¼Œå¹¶è°ƒæ•´ä½ç½®ã€‚ |
| `void paint(QPainter* painter, const QStyleOptionGraphicsItem* option, QWidget* widget) override` | `void` | ... | å¯é€‰æ‹©ç»˜åˆ¶èƒŒæ™¯è¾¹æ¡†ã€‚ |

**å®ç°è¦ç‚¹**

-   `updateBlock` ä¸­ï¼Œæ ¹æ® block çš„ boundingRect è®¾ç½®æœ¬é¡¹çš„ä½ç½®å’ŒçŸ©å½¢ï¼ˆç”¨äºé¼ æ ‡äº‹ä»¶ï¼‰ï¼Œä½†å®é™…æ–‡æœ¬ç”± m\_textItem ç»˜åˆ¶ã€‚
    
-   ä½¿ç”¨ `QGraphicsTextItem` çš„ `setHtml` æˆ– `setDocument` å¯è®¾ç½®å¯Œæ–‡æœ¬ã€‚
    
-   å°† m\_textItem çš„ä½ç½®è®¾ç½®åœ¨çŸ©å½¢å†…éƒ¨ï¼ˆå¦‚ `PAGE_MARGIN` åç§»ï¼‰ã€‚
    

---

#### `ImageBlockItem` ç±»

**ç»§æ‰¿å…³ç³»**  
`BaseBlockItem`

**èŒè´£**

-   ç»˜åˆ¶å›¾ç‰‡å—ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_pixmapItem` | `QGraphicsPixmapItem*` | ç”¨äºæ˜¾ç¤ºå›¾ç‰‡çš„é¡¹ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `ImageBlockItem` | \- | `ImageBlock* block, QGraphicsItem* parent = nullptr` | æ„é€ ã€‚ |
| `void updateBlock() override` | `void` | \- | ä» block è·å–å›¾ç‰‡ï¼Œç¼©æ”¾åè®¾ç½®åˆ° pixmapItemã€‚ |

---

#### `PageItem` ç±»

**ç»§æ‰¿å…³ç³»**  
`QGraphicsRectItem`

**èŒè´£**

-   ç»˜åˆ¶é¡µé¢èƒŒæ™¯ï¼ˆç™½è‰²ã€é˜´å½±ã€è¾¹æ¡†ï¼‰ï¼Œå¹¶ä½œä¸ºé¡µå†…å—é¡¹çš„å®¹å™¨ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_page` | `Page*` | å…³è”çš„é¡µé¢æ•°æ®ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `PageItem` | \- | `Page* page, QGraphicsItem* parent = nullptr` | æ„é€ ï¼Œè®¾ç½®çŸ©å½¢ä¸º page->pageRect()ã€‚ |
| `void updatePage()` | `void` | \- | åˆ é™¤æ‰€æœ‰å­é¡¹ï¼Œå¹¶æ ¹æ®é¡µé¢æ•°æ®é‡æ–°åˆ›å»ºå—é¡¹ï¼ˆé€šè¿‡å·¥å‚ï¼‰ã€‚ |
| `void paint(QPainter* painter, const QStyleOptionGraphicsItem* option, QWidget* widget) override` | `void` | ... | ç»˜åˆ¶é¡µé¢èƒŒæ™¯ã€‚ |

**å®ç°è¦ç‚¹**

-   å—é¡¹ä½œä¸º PageItem çš„å­é¡¹ï¼Œç”±å·¥å‚åˆ›å»ºå¹¶æ·»åŠ ã€‚
    
-   é¡µé¢èƒŒæ™¯åŒ…æ‹¬ç™½è‰²å¡«å……ã€ç°è‰²é˜´å½±ã€è¾¹æ¡†ç­‰ã€‚
    

---

#### `CursorItem` ç±»

**ç»§æ‰¿å…³ç³»**  
`QGraphicsLineItem`

**èŒè´£**

-   ç»˜åˆ¶é—ªçƒçš„å…‰æ ‡ï¼ˆç«–çº¿ï¼‰ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_blinkTimer` | `QTimer` | é—ªçƒå®šæ—¶å™¨ã€‚ |
| `m_visible` | `bool` | å½“å‰æ˜¯å¦å¯è§ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `CursorItem` | \- | `QGraphicsItem* parent = nullptr` | æ„é€ ï¼Œè®¾ç½®ç”»ç¬”é¢œè‰²å’Œå®½åº¦ã€‚ |
| `void setPosition(const QPointF& pos, qreal height)` | `void` | `const QPointF&, qreal` | è®¾ç½®çº¿æ¡èµ·ç‚¹å’Œé•¿åº¦ã€‚ |
| `void startBlink()` | `void` | \- | å¯åŠ¨é—ªçƒã€‚ |
| `void stopBlink()` | `void` | \- | åœæ­¢é—ªçƒå¹¶ä¿æŒå¯è§ã€‚ |
| `void setBlinkInterval(int ms)` | `void` | `int` | è®¾ç½®é—ªçƒé—´éš”ã€‚ |

**ç§æœ‰æ§½**

-   `void toggleBlink()`ï¼šåˆ‡æ¢å¯è§æ€§ã€‚
    

---

#### `SelectionItem` ç±»

**ç»§æ‰¿å…³ç³»**  
`QGraphicsItem`

**èŒè´£**

-   ç»˜åˆ¶é€‰åŒºï¼ˆå¤šä¸ªçŸ©å½¢ï¼‰ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_rects` | `QList<QRectF>` | é€‰åŒºçŸ©å½¢åˆ—è¡¨ï¼ˆåœºæ™¯åæ ‡ï¼‰ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `SelectionItem` | \- | `QGraphicsItem* parent = nullptr` | æ„é€ ï¼Œè®¾ç½®ç”»ç¬”ä¸ºæ— ï¼Œç”»åˆ·ä¸ºåŠé€æ˜è‰²ã€‚ |
| `void setRects(const QList<QRectF>& rects)` | `void` | `const QList<QRectF>&` | è®¾ç½®çŸ©å½¢åˆ—è¡¨ã€‚ |
| `void clear()` | `void` | \- | æ¸…ç©ºã€‚ |
| `QRectF boundingRect() const override` | `QRectF` | \- | è¿”å›æ‰€æœ‰çŸ©å½¢çš„å¹¶é›†ã€‚ |
| `void paint(QPainter* painter, const QStyleOptionGraphicsItem* option, QWidget* widget) override` | `void` | ... | ç»˜åˆ¶æ‰€æœ‰çŸ©å½¢ã€‚ |

---

### 4.4 factory å­æ¨¡å—

#### `BlockItemFactory` ç±»ï¼ˆé™æ€ï¼‰

**èŒè´£**

-   æ ¹æ®å—ç±»å‹åˆ›å»ºå¯¹åº”çš„å›¾å½¢é¡¹ã€‚
    

**é™æ€æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `BaseBlockItem* createItem(Block* block, QGraphicsItem* parent = nullptr)` | `BaseBlockItem*` | `Block*, QGraphicsItem*` | æ ¹æ® block çš„å®é™…ç±»å‹ï¼ˆdynamic\_castï¼‰åˆ›å»ºç›¸åº”é¡¹ã€‚ |

**å®ç°ç¤ºä¾‹**

```

BaseBlockItem* BlockItemFactory::createItem(Block* block, QGraphicsItem* parent) {
    if (auto* p = dynamic_cast<ParagraphBlock*>(block)) {
        return new TextBlockItem(p, parent);
    } else if (auto* img = dynamic_cast<ImageBlock*>(block)) {
        return new ImageBlockItem(img, parent);
    } else if (auto* tbl = dynamic_cast<TableBlock*>(block)) {
        return new TableBlockItem(tbl, parent);
    }
    return nullptr;
}

```

---

## 5\. io æ¨¡å—

### 5.1 serializers å­æ¨¡å—

#### `XmlSerializer` ç±»

**èŒè´£**

-   å°† Document å¯¹è±¡åºåˆ—åŒ–ä¸ºè‡ªå®šä¹‰ XML æ ¼å¼ï¼ˆ.qtdocï¼‰ï¼Œå¹¶ä» XML ååºåˆ—åŒ–ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_lastError` | `QString` | æœ€åä¸€æ¬¡é”™è¯¯ä¿¡æ¯ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `XmlSerializer` | \- | \- | æ„é€ ã€‚ |
| `bool serialize(Document* doc, const QString& filePath)` | `bool` | `Document*, const QString&` | åºåˆ—åŒ–åˆ°æ–‡ä»¶ã€‚ |
| `Document* deserialize(const QString& filePath)` | `Document*` | `const QString&` | ä»æ–‡ä»¶ååºåˆ—åŒ–ï¼Œè¿”å›æ–° Documentï¼ˆè°ƒç”¨è€…è´Ÿè´£åˆ é™¤ï¼‰ã€‚ |
| `QString lastError() const` | `QString` | \- | è·å–é”™è¯¯ä¿¡æ¯ã€‚ |

**ç§æœ‰æ–¹æ³•**

-   `QDomDocument createDomDocument(Document* doc)`ï¼šåˆ›å»º XML æ–‡æ¡£ã€‚
    
-   `Document* parseDomDocument(const QDomDocument& doc)`ï¼šè§£æ DOMã€‚
    

**XML æ ¼å¼ç¤ºä¾‹**ï¼ˆè§å‰æ–‡ï¼‰ã€‚

---

### 5.2 exporters å­æ¨¡å—

#### `PdfExporter` ç±»

**èŒè´£**

-   å°†æ–‡æ¡£å¯¼å‡ºä¸º PDF æ–‡ä»¶ã€‚
    

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `static bool exportToPdf(Document* doc, const QString& filePath, QString* error = nullptr)` | `bool` | `Document*, const QString&, QString*` | å¯¼å‡º PDFã€‚ |

**å®ç°è¦ç‚¹**

-   ä½¿ç”¨ QPrinter è®¾ç½®è¾“å‡ºæ–‡ä»¶ï¼Œé¡µé¢å¤§å°ä¸æ–‡æ¡£ä¸€è‡´ã€‚
    
-   é€šè¿‡ QPainter å°†æ¯ä¸€é¡µç»˜åˆ¶åˆ° QPrinterã€‚
    
-   å¯åˆ©ç”¨å·²æœ‰çš„å¸ƒå±€å¼•æ“è·å–é¡µé¢å¸ƒå±€ã€‚
    

---

### 5.3 importers å­æ¨¡å—

#### `DocxImporter` ç±»ï¼ˆæ¦‚è¦ï¼‰

**èŒè´£**

-   è§£æ .docx æ–‡ä»¶ï¼Œè½¬æ¢ä¸º Document å¯¹è±¡ã€‚
    

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `static Document* importFromDocx(const QString& filePath, QString* error = nullptr)` | `Document*` | `const QString&, QString*` | å¯¼å…¥ã€‚ |

**å®ç°è¦ç‚¹**

-   ä½¿ç”¨ QZipReader è§£å‹æ–‡ä»¶ã€‚
    
-   è§£æ `word/document.xml`ï¼Œæå–æ®µè½ã€æ–‡æœ¬ã€æ ·å¼ç­‰ã€‚
    
-   æ˜ å°„åˆ°æœ¬åœ°æ ·å¼ã€‚
    

---

## 6\. ui æ¨¡å—

### 6.1 mainwindow å­æ¨¡å—

#### `MainWindow` ç±»

**ç»§æ‰¿å…³ç³»**  
`QMainWindow`

**èŒè´£**

-   ä¸»çª—å£ï¼Œé›†æˆèœå•ã€å·¥å…·æ ã€çŠ¶æ€æ å’Œä¸­å¤®è§†å›¾ã€‚
    
-   ç®¡ç†æ–‡æ¡£ã€è§†å›¾ã€æ§åˆ¶å™¨ï¼Œå“åº”ç”¨æˆ·æ“ä½œã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_document` | `Document*` | å½“å‰æ–‡æ¡£ã€‚ |
| `m_scene` | `DocumentScene*` | åœºæ™¯ã€‚ |
| `m_view` | `DocumentView*` | è§†å›¾ã€‚ |
| `m_cursor` | `Cursor*` | å…‰æ ‡ã€‚ |
| `m_selection` | `Selection*` | é€‰åŒºã€‚ |
| `m_editEventHandler` | `EditEventHandler*` | äº‹ä»¶å¤„ç†å™¨ã€‚ |
| `m_formatController` | `FormatController*` | æ ¼å¼æ§åˆ¶å™¨ã€‚ |
| `m_formatToolBar` | `FormatToolBar*` | æ ¼å¼å·¥å…·æ ã€‚ |
| `m_currentFile` | `QString` | å½“å‰æ–‡ä»¶è·¯å¾„ã€‚ |
| `m_isModified` | `bool` | æ–‡æ¡£æ˜¯å¦è¢«ä¿®æ”¹ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `MainWindow` | \- | `QWidget* parent = nullptr` | æ„é€ ï¼Œè®¾ç½® UIã€‚ |
| `~MainWindow` | \- | \- | ææ„ã€‚ |
| `void newDocument()` | `void` | \- | æ–°å»ºæ–‡æ¡£ã€‚ |
| `void openDocument()` | `void` | \- | æ‰“å¼€æ–‡æ¡£ã€‚ |
| `void saveDocument()` | `void` | \- | ä¿å­˜æ–‡æ¡£ã€‚ |
| `void saveAsDocument()` | `void` | \- | å¦å­˜ä¸ºã€‚ |
| `void undo()` | `void` | \- | æ’¤é”€ã€‚ |
| `void redo()` | `void` | \- | é‡åšã€‚ |
| `void cut()` | `void` | \- | å‰ªåˆ‡ã€‚ |
| `void copy()` | `void` | \- | å¤åˆ¶ã€‚ |
| `void paste()` | `void` | \- | ç²˜è´´ã€‚ |
| `void zoomIn()` | `void` | \- | æ”¾å¤§ã€‚ |
| `void zoomOut()` | `void` | \- | ç¼©å°ã€‚ |
| `void zoomToFit()` | `void` | \- | é€‚åº”çª—å£ã€‚ |
| `void about()` | `void` | \- | å…³äºå¯¹è¯æ¡†ã€‚ |

**ç§æœ‰æ–¹æ³•**

-   `void createActions()`ï¼šåˆ›å»ºæ‰€æœ‰ QActionã€‚
    
-   `void setupMenuBar()`ï¼šè®¾ç½®èœå•æ ã€‚
    
-   `void setupToolBar()`ï¼šè®¾ç½®å·¥å…·æ ã€‚
    
-   `void setupStatusBar()`ï¼šè®¾ç½®çŠ¶æ€æ ã€‚
    
-   `void setupConnections()`ï¼šè¿æ¥ä¿¡å·æ§½ã€‚
    
-   `void setCurrentFile(const QString& filePath)`ï¼šè®¾ç½®å½“å‰æ–‡ä»¶ï¼Œæ›´æ–°çª—å£æ ‡é¢˜ã€‚
    
-   `bool maybeSave()`ï¼šè¯¢é—®æ˜¯å¦ä¿å­˜ä¿®æ”¹ã€‚
    

**äº‹ä»¶å¤„ç†**

-   `void closeEvent(QCloseEvent* event)`ï¼šå…³é—­å‰æ£€æŸ¥ä¿å­˜ã€‚
    

**ä¿¡å·è¿æ¥**

-   è¿æ¥è§†å›¾çš„äº‹ä»¶ä¿¡å·åˆ° `m_editEventHandler`ã€‚
    
-   è¿æ¥æ–‡æ¡£çš„ `documentChanged` åˆ° `setWindowModified` å’Œæ›´æ–°æ ‡é¢˜ã€‚
    
-   è¿æ¥å…‰æ ‡å’Œé€‰åŒºä¿¡å·åˆ°æ›´æ–° UIï¼ˆå¦‚çŠ¶æ€æ ã€å·¥å…·æ æ ·å¼æ˜¾ç¤ºï¼‰ã€‚
    

---

### 6.2 ribbon å­æ¨¡å—ï¼ˆå¯é€‰ï¼‰

#### `RibbonBar` ç±»

**ç»§æ‰¿å…³ç³»**  
`QTabWidget`

**èŒè´£**

-   å®ç°ç±»ä¼¼ Office çš„åŠŸèƒ½åŒºã€‚
    

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `RibbonBar` | \- | `QWidget* parent = nullptr` | æ„é€ ã€‚ |
| `void addTab(const QString& title)` | `void` | `const QString&` | æ·»åŠ é€‰é¡¹å¡ã€‚ |
| `void addGroup(const QString& groupName)` | `void` | `const QString&` | åœ¨å½“å‰é€‰é¡¹å¡æ·»åŠ ç»„ã€‚ |
| `void addAction(QAction* action)` | `void` | `QAction*` | å°†åŠ¨ä½œæ·»åŠ åˆ°å½“å‰ç»„ã€‚ |

---

### 6.3 dialogs å­æ¨¡å—

#### `FontDialog` ç±»ï¼ˆé™æ€ï¼‰

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `static CharacterStyle getStyle(const CharacterStyle& initial, QWidget* parent, bool* ok = nullptr)` | `CharacterStyle` | `const CharacterStyle&, QWidget*, bool*` | æ˜¾ç¤ºå­—ä½“å¯¹è¯æ¡†ï¼Œè¿”å›ç”¨æˆ·é€‰æ‹©çš„æ ·å¼ã€‚ |

**å®ç°**

-   ä½¿ç”¨ QFontDialog é€‰æ‹©å­—ä½“ï¼ŒQColorDialog é€‰æ‹©é¢œè‰²ï¼Œç»„åˆæˆ CharacterStyleã€‚
    

---

#### `ParagraphDialog` ç±»

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `static ParagraphStyle getStyle(const ParagraphStyle& initial, QWidget* parent, bool* ok = nullptr)` | `ParagraphStyle` | `const ParagraphStyle&, QWidget*, bool*` | æ˜¾ç¤ºæ®µè½å¯¹è¯æ¡†ï¼Œè®¾ç½®ç¼©è¿›ã€é—´è·ã€å¯¹é½ç­‰ã€‚ |

---

### 6.4 widgets å­æ¨¡å—

#### `FormatToolBar` ç±»

**ç»§æ‰¿å…³ç³»**  
`QToolBar`

**èŒè´£**

-   æä¾›æ ¼å¼è®¾ç½®çš„å·¥å…·æ ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_fontComboBox` | `QFontComboBox*` | å­—ä½“é€‰æ‹©ã€‚ |
| `m_fontSizeSpinBox` | `QSpinBox*` | å­—å·ã€‚ |
| `m_letterSpacingSpinBox` | `QDoubleSpinBox*` | å­—é—´è·ã€‚ |
| `m_boldAction` | `QAction*` | ç²—ä½“ã€‚ |
| `m_italicAction` | `QAction*` | æ–œä½“ã€‚ |
| `m_underlineAction` | `QAction*` | ä¸‹åˆ’çº¿ã€‚ |
| `m_alignLeftAction` | `QAction*` | å·¦å¯¹é½ã€‚ |
| `m_alignCenterAction` | `QAction*` | å±…ä¸­ã€‚ |
| `m_alignRightAction` | `QAction*` | å³å¯¹é½ã€‚ |
| `m_alignJustifyAction` | `QAction*` | ä¸¤ç«¯å¯¹é½ã€‚ |

**æ–¹æ³•**

| åç§° | è¿”å›ç±»å‹ | å‚æ•° | æè¿° |
| --- | --- | --- | --- |
| `FormatToolBar` | \- | `QWidget* parent = nullptr` | æ„é€ ï¼Œåˆ›å»ºæ§ä»¶ã€‚ |
| `void updateFromCurrentStyle(const CharacterStyle& charStyle, const ParagraphStyle& paraStyle)` | `void` | `const CharacterStyle&, const ParagraphStyle&` | æ ¹æ®å½“å‰æ ·å¼æ›´æ–°æ§ä»¶çŠ¶æ€ã€‚ |
| `QFontComboBox* fontComboBox() const` | `QFontComboBox*` | \- | è·å–å­—ä½“ç»„åˆæ¡†ã€‚ |
| ... å…¶ä»– getterã€‚ |  |  |  |

**ä¿¡å·**

-   æ§ä»¶å€¼å˜åŒ–æ—¶å¯ç›´æ¥è¿æ¥å¤–éƒ¨æ§½ã€‚
    

---

#### `Ruler` ç±»ï¼ˆæ¦‚è¦ï¼‰

**ç»§æ‰¿å…³ç³»**  
`QWidget`

**èŒè´£**

-   æ˜¾ç¤ºæ°´å¹³æ ‡å°ºï¼Œæ”¯æŒæ‹–åŠ¨ç¼©è¿›æ ‡è®°ã€‚
    

**å±æ€§**

| åç§° | ç±»å‹ | æè¿° |
| --- | --- | --- |
| `m_view` | `DocumentView*` | å…³è”çš„è§†å›¾ã€‚ |
| `m_leftMargin` | `qreal` | å·¦é¡µè¾¹è·ã€‚ |
| `m_rightMargin` | `qreal` | å³é¡µè¾¹è·ã€‚ |
| `m_firstLineIndent` | `qreal` | é¦–è¡Œç¼©è¿›ã€‚ |
| `m_leftIndent` | `qreal` | å·¦ç¼©è¿›ã€‚ |
| `m_tabStops` | `QList<qreal>` | åˆ¶è¡¨ä½ä½ç½®ã€‚ |

**æ–¹æ³•**

-   `paintEvent`ï¼šç»˜åˆ¶æ ‡å°ºåˆ»åº¦ã€ç¼©è¿›æ ‡è®°ã€åˆ¶è¡¨ä½ã€‚
    
-   `mousePressEvent`ï¼šæ£€æµ‹ç‚¹å‡»ä½ç½®ï¼Œæ·»åŠ /åˆ é™¤åˆ¶è¡¨ä½ã€‚
    
-   `mouseMoveEvent`ï¼šæ‹–åŠ¨ç¼©è¿›æ ‡è®°ã€‚
    

---

## 7\. èµ„æºä¸é…ç½®

### èµ„æºæ–‡ä»¶

-   **icons.qrc**ï¼šåŒ…å«æ‰€æœ‰å›¾æ ‡ï¼ˆæ–°å»ºã€æ‰“å¼€ã€ä¿å­˜ã€å‰ªåˆ‡ã€å¤åˆ¶ã€ç²˜è´´ã€æ ¼å¼ç­‰ï¼‰ã€‚
    
-   **styles/default.qss**ï¼šé»˜è®¤æ ·å¼è¡¨ï¼Œå®šä¹‰æ§ä»¶å¤–è§‚ã€‚
    
-   **translations/**ï¼šå­˜æ”¾ç¿»è¯‘æ–‡ä»¶ï¼ˆ.ts/.qmï¼‰ã€‚
    

### å…¨å±€é…ç½®

-   ä½¿ç”¨ `QSettings` åœ¨ `Application` ä¸­ä¿å­˜å’ŒåŠ è½½ï¼š
    
    -   `MainWindow/geometry`
        
    -   `MainWindow/state`
        
    -   `recentFiles`
        
    -   `editor/defaultFont`
        
    -   `editor/defaultZoom`
        
    -   ...
        

---

## 8\. æµ‹è¯•ä¸æ’ä»¶

### å•å…ƒæµ‹è¯•

-   ä½¿ç”¨ Google Test æ¡†æ¶ã€‚
    
-   æµ‹è¯• core æ¨¡å—çš„å…³é”®ç±»ï¼šDocumentã€ParagraphBlockã€Spanã€CharacterStyleã€å„ç§å‘½ä»¤ã€‚
    
-   æµ‹è¯•å¸ƒå±€å¼•æ“çš„ç®€å•åœºæ™¯ã€‚
    

### æ’ä»¶ç³»ç»Ÿï¼ˆå¯é€‰ï¼‰

-   å®šä¹‰æ’ä»¶æ¥å£ï¼ˆå¦‚ `BlockPlugin` æä¾›æ–°å—ç±»å‹ï¼Œ`ImporterPlugin` æä¾›æ–°å¯¼å…¥æ ¼å¼ï¼‰ã€‚
    
-   ä½¿ç”¨ `QPluginLoader` åœ¨è¿è¡Œæ—¶åŠ è½½æ’ä»¶ã€‚
    
-   æ’ä»¶å¯å‘åº”ç”¨ç¨‹åºæ³¨å†Œè‡ªå·±ã€‚
    

---

## 9\. æ ¸å¿ƒæµç¨‹è®¾è®¡

### 9.1 æ–‡æ¡£åŠ è½½æµç¨‹

1.  ç”¨æˆ·é€‰æ‹©â€œæ‰“å¼€â€æ–‡ä»¶ã€‚
    
2.  MainWindow è°ƒç”¨ `DocumentIO::load`ã€‚
    
3.  DocumentIO æ ¹æ®æ–‡ä»¶æ‰©å±•åé€‰æ‹©åˆé€‚çš„å¯¼å…¥å™¨ï¼ˆå¦‚ `DocxImporter`ï¼‰ã€‚
    
4.  å¯¼å…¥å™¨è§£ææ–‡ä»¶ï¼Œæ„å»º `Document` å¯¹è±¡ã€‚
    
5.  MainWindow è°ƒç”¨ `setDocument`ï¼Œè®¾ç½®åœºæ™¯çš„æ–‡æ¡£ï¼Œè§¦å‘ `DocumentScene::rebuildFromDocument`ã€‚
    
6.  å¸ƒå±€å¼•æ“æ‰§è¡Œå¸ƒå±€ï¼ˆå¯åœ¨è®¾ç½®æ–‡æ¡£åæ‰‹åŠ¨è°ƒç”¨ `layoutEngine->layout()`ï¼‰ã€‚
    
7.  æ›´æ–° UIï¼ˆçª—å£æ ‡é¢˜ã€æœ€è¿‘æ–‡ä»¶åˆ—è¡¨ï¼‰ã€‚
    

### 9.2 ç¼–è¾‘æµç¨‹ï¼ˆé”®å…¥å­—ç¬¦ï¼‰

1.  ç”¨æˆ·åœ¨è§†å›¾ä¸­æŒ‰é”®ï¼Œ`DocumentView` å‘å°„ `keyPressed` ä¿¡å·ã€‚
    
2.  MainWindow å°†ä¿¡å·è½¬å‘ç»™ `EditEventHandler::handleKeyPress`ã€‚
    
3.  äº‹ä»¶å¤„ç†å™¨åˆ¤æ–­ä¸ºå¯æ‰“å°å­—ç¬¦ï¼Œè·å–å½“å‰å…‰æ ‡æ ·å¼ï¼Œè°ƒç”¨ `m_cursor->insertText(text, style)`ã€‚
    
4.  `Cursor::insertText` åˆ›å»º `InsertTextCommand` å¹¶æ¨å…¥æ–‡æ¡£çš„æ’¤é”€æ ˆã€‚
    
5.  å‘½ä»¤æ‰§è¡Œï¼šä¿®æ”¹æ–‡æ¡£çš„ `ParagraphBlock`ï¼Œå‘å‡º `blockChanged` ä¿¡å·ï¼ˆæˆ–æ›´ç»†ç²’åº¦çš„ä¿¡å·ï¼‰ã€‚
    
6.  `DocumentScene` ç›‘å¬åˆ°å—å˜åŒ–ï¼Œé€šè¿‡æ˜ å°„æ‰¾åˆ°å¯¹åº”çš„ `TextBlockItem`ï¼Œè°ƒç”¨å…¶ `updateBlock()` æ›´æ–°æ˜¾ç¤ºã€‚
    
7.  å…‰æ ‡ä½ç½®å˜åŒ–åï¼Œ`Cursor` å‘å‡º `positionChanged`ï¼ŒMainWindow è¿æ¥æ­¤ä¿¡å·ï¼Œè®¡ç®—æ–°å…‰æ ‡å±å¹•ä½ç½®ï¼Œè°ƒç”¨ `m_scene->updateCursor(pos, height)`ã€‚
    
8.  åœºæ™¯æ›´æ–°å…‰æ ‡é¡¹ï¼Œè§†å›¾è‡ªåŠ¨é‡ç»˜ã€‚
    

### 9.3 é€‰åŒºæ›´æ–°æµç¨‹

1.  ç”¨æˆ·åœ¨è§†å›¾ä¸­æ‹–åŠ¨é¼ æ ‡ï¼Œ`DocumentView` å‘å°„ `mouseMoved`ã€‚
    
2.  äº‹ä»¶å¤„ç†å™¨æ›´æ–°é€‰åŒºï¼ˆè°ƒç”¨ `m_selection->extend`ï¼‰ã€‚
    
3.  é€‰åŒºå˜åŒ–å‘å‡º `selectionChanged`ã€‚
    
4.  MainWindow è¿æ¥æ­¤ä¿¡å·ï¼Œè®¡ç®—é€‰åŒºçŸ©å½¢åˆ—è¡¨ï¼ˆé€šè¿‡å¸ƒå±€ä¿¡æ¯ï¼‰ï¼Œè°ƒç”¨ `m_scene->updateSelection(rects)`ã€‚
    
5.  åœºæ™¯æ›´æ–°é€‰åŒºé¡¹ã€‚
    

### 9.4 æ’¤é”€/é‡åš

1.  ç”¨æˆ·ç‚¹å‡»â€œæ’¤é”€â€ï¼Œ`MainWindow::undo()` è°ƒç”¨ `m_document->undoStack()->undo()`ã€‚
    
2.  æ’¤é”€æ ˆæ‰§è¡Œæ ˆé¡¶å‘½ä»¤çš„ `undo()`ï¼Œæ¢å¤æ–‡æ¡£åˆ°ä¹‹å‰çŠ¶æ€ã€‚
    
3.  æ–‡æ¡£å‘å‡ºç›¸åº”ä¿¡å·ï¼Œåœºæ™¯æ›´æ–°ã€‚
    
4.  æ›´æ–°æ’¤é”€/é‡åšèœå•çŠ¶æ€ã€‚
    

---

## 10\. é™„å½•ï¼šç±»å›¾ä¸åºåˆ—å›¾

ï¼ˆæ­¤å¤„å¯æ’å…¥ UML ç±»å›¾å’Œåºåˆ—å›¾ï¼Œç”±äºæ–‡æœ¬é™åˆ¶ï¼Œä»…æè¿°ï¼‰

### ç±»å›¾æ¦‚è¿°

```

Document 1 --- * Section
Section 1 --- * Block (abstract)
Block <|--- ParagraphBlock
Block <|--- ImageBlock
Block <|--- TableBlock
ParagraphBlock 1 --- * Span
Span 1 --- 1 CharacterStyle
ParagraphBlock 1 --- 1 ParagraphStyle

DocumentScene 1 --- 1 DocumentView
DocumentScene 1 --- * PageItem
PageItem 1 --- * BaseBlockItem
BaseBlockItem <|--- TextBlockItem
BaseBlockItem <|--- ImageBlockItem
BaseBlockItem <|--- TableBlockItem

Cursor, Selection, EditEventHandler, FormatController ä¸ Document å…³è”ã€‚

QUndoStack ä¸ Document å…³è”ï¼Œç®¡ç† EditCommand æ´¾ç”Ÿç±»ã€‚

```

### åºåˆ—å›¾ï¼ˆæ’å…¥æ–‡æœ¬ï¼‰

```

ç”¨æˆ· -> DocumentView: keyPress
DocumentView -> MainWindow: keyPressed
MainWindow -> EditEventHandler: handleKeyPress
EditEventHandler -> Cursor: insertText
Cursor -> InsertTextCommand: åˆ›å»ºå‘½ä»¤
Cursor -> Document: undoStack()->push(command)
command -> ParagraphBlock: insert()
ParagraphBlock -> Document: å‘å‡º blockChanged
DocumentScene -> TextBlockItem: updateBlock()
TextBlockItem -> QGraphicsTextItem: setHtml()
Cursor -> å‘å‡º positionChanged
MainWindow -> DocumentScene: updateCursor()
DocumentScene -> CursorItem: setPosition()

```

---

ä»¥ä¸Šä¸º Qt Word æ–‡å­—å¤„ç†å™¨çš„è¯¦ç»†è®¾è®¡æ–‡æ¡£ï¼Œæ¶µç›–äº†æ‰€æœ‰æ ¸å¿ƒæ¨¡å—çš„ç±»å®šä¹‰ã€æ–¹æ³•ã€å±æ€§ä»¥åŠå…³é”®æµç¨‹ã€‚å¼€å‘è€…å¯æ ¹æ®æ­¤æ–‡æ¡£è¿›è¡Œç¼–ç å®ç°ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•ã€‚

---


*ç”± [NousSave Ai Chat Exporter](https://www.noussave.com) ç”Ÿæˆ | deepseek | 2026/2/17*
