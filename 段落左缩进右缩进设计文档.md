# 段落左缩进和右缩进设计文档

**日期**: 2026-02-20  
**版本**: v1.0

---

## 1. 概述

本文档详细说明了 QtWordEditor 项目中段落左缩进和右缩进功能的设计思路和实现方案。

### 1.1 当前状态分析

经过代码分析，发现项目已经具备了实现左缩进和右缩进的基础架构：

1. **数据层已就绪** (`ParagraphStyle` 类)
   - 已有 `leftIndent()` 和 `setLeftIndent()` 方法
   - 已有 `rightIndent()` 和 `setRightIndent()` 方法
   - 已有属性标记 `ParagraphStyleProperty::LeftIndent` 和 `RightIndent`

2. **布局层需要更新** (`TextBlockItem` 类)
   - 当前未应用缩进效果
   - 文本宽度固定为 `PAGE_WIDTH - 2 * PAGE_MARGIN`

3. **UI控制层需要更新**
   - 需要在功能区添加缩进控制控件
   - 需要在格式控制器中添加方法

---

## 2. 核心概念

### 2.1 缩进定义

- **左缩进**: 段落整体左侧距离页面左边距的距离
- **右缩进**: 段落整体右侧距离页面右边距的距离
- **首行缩进**: 仅段落第一行的额外缩进

### 2.2 单位

所有缩进值都使用 **点(Point)** 作为单位：
- 1 英寸 = 72 点
- 1 毫米 ≈ 2.8346 点
- 已有的常量 `MillimetersToPoints = 2.83464567` 可用于转换

---

## 3. 详细设计方案

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                      UI 层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │ RibbonBar    │  │ ParagraphDlg │  │ FormatTool- │ │
│  │ (缩进控件)   │  │ (缩进设置)   │  │ Bar (缩进)  │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬──────┘ │
└─────────┼───────────────────┼───────────────────┼────────┘
          │                   │                   │
          ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────────┐
│                  FormatController                        │
│  ┌───────────────────────────────────────────────────┐  │
│  │ setLeftIndent(qreal indent)                       │  │
│  │ setRightIndent(qreal indent)                      │  │
│  │ increaseLeftIndent() / decreaseLeftIndent()       │  │
│  │ increaseRightIndent() / decreaseRightIndent()     │  │
│  └───────────────────────────────────────────────────┘  │
└──────────────────────────┬──────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                   数据层 (Document)                      │
│  ┌───────────────────────────────────────────────────┐  │
│  │ ParagraphBlock                                    │  │
│  │   └── paragraphStyle()                            │  │
│  │       ├── leftIndent()                            │  │
│  │       └── rightIndent()                           │  │
│  └───────────────────────────────────────────────────┘  │
└──────────────────────────┬──────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  渲染层 (Graphics)                       │
│  ┌───────────────────────────────────────────────────┐  │
│  │ TextBlockItem                                     │  │
│  │   ├── applyParagraphIndent()                      │  │
│  │   ├── 调整 m_textItem 位置和宽度                 │  │
│  │   └── 应用 HTML/CSS 缩进                         │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 4. 具体实现方案

### 4.1 步骤 1: 修改 TextBlockItem 应用缩进

**文件**: `src/graphics/items/TextBlockItem.cpp`

#### 4.1.1 更新文本宽度计算

```cpp
// 在 TextBlockItem 中添加方法
void TextBlockItem::applyParagraphIndent()
{
    ParagraphBlock *para = qobject_cast<ParagraphBlock*>(m_block);
    if (!para) {
        return;
    }
    
    ParagraphStyle style = para->paragraphStyle();
    qreal leftIndent = style.leftIndent();
    qreal rightIndent = style.rightIndent();
    
    // 1. 计算文本实际可用宽度 = 页面内容宽度 - 左缩进 - 右缩进
    qreal availableWidth = m_textWidth - leftIndent - rightIndent;
    if (availableWidth < 10) {
        availableWidth = 10; // 最小宽度保护
    }
    
    // 2. 设置文本宽度
    m_textItem->setTextWidth(availableWidth);
    
    // 3. 调整文本项位置（向右偏移左缩进值）
    m_textItem->setPos(leftIndent, 0);
    
    // 4. 同时使用 HTML/CSS 方式应用缩进（双重保障）
    // 这样即使 TextItem 宽度计算有问题，HTML 也能正确显示
}
```

#### 4.1.2 修改 initializeTextItem

```cpp
void TextBlockItem::initializeTextItem()
{
    // 保持原有代码...
    
    // 应用段落缩进
    applyParagraphIndent();
}
```

#### 4.1.3 修改 updateBlock

```cpp
void TextBlockItem::updateBlock()
{
    ParagraphBlock *para = qobject_cast<ParagraphBlock*>(m_block);
    if (!para)
        return;
    
    applyRichTextFromBlock();
    applyParagraphIndent();  // 新增：应用缩进
    updateBoundingRect();
}
```

#### 4.1.4 修改 updateBoundingRect

```cpp
void TextBlockItem::updateBoundingRect()
{
    ParagraphBlock *para = qobject_cast<ParagraphBlock*>(m_block);
    qreal leftIndent = 0;
    qreal rightIndent = 0;
    
    if (para) {
        ParagraphStyle style = para->paragraphStyle();
        leftIndent = style.leftIndent();
        rightIndent = style.rightIndent();
    }
    
    QRectF textRect = m_textItem->boundingRect();
    
    // 整体宽度 = 左缩进 + 文本宽度 + 右缩进
    qreal totalWidth = leftIndent + textRect.width() + rightIndent;
    
    setRect(0, 0, totalWidth, textRect.height());
}
```

---

### 4.2 步骤 2: 修改 FormatController 添加缩进方法

**文件**: `include/editcontrol/formatting/FormatController.h`  
**文件**: `src/editcontrol/formatting/FormatController.cpp`

#### 4.2.1 在 FormatController.h 中添加声明

```cpp
public:
    // ========== 缩进相关方法 ==========
    
    /**
     * @brief 设置左缩进
     * @param indent 缩进值（单位：点）
     */
    void setLeftIndent(qreal indent);
    
    /**
     * @brief 设置右缩进
     * @param indent 缩进值（单位：点）
     */
    void setRightIndent(qreal indent);
    
    /**
     * @brief 增加左缩进
     * @param delta 增加的缩进值（默认 36 点 = 0.5 英寸）
     */
    void increaseLeftIndent(qreal delta = 36.0);
    
    /**
     * @brief 减少左缩进
     * @param delta 减少的缩进值（默认 36 点 = 0.5 英寸）
     */
    void decreaseLeftIndent(qreal delta = 36.0);
    
    /**
     * @brief 增加右缩进
     * @param delta 增加的缩进值（默认 36 点 = 0.5 英寸）
     */
    void increaseRightIndent(qreal delta = 36.0);
    
    /**
     * @brief 减少右缩进
     * @param delta 减少的缩进值（默认 36 点 = 0.5 英寸）
     */
    void decreaseRightIndent(qreal delta = 36.0);
```

#### 4.2.2 在 FormatController.cpp 中实现

```cpp
void FormatController::setLeftIndent(qreal indent)
{
    ParagraphStyle style;
    style.setLeftIndent(indent);
    applyParagraphStyle(style);
}

void FormatController::setRightIndent(qreal indent)
{
    ParagraphStyle style;
    style.setRightIndent(indent);
    applyParagraphStyle(style);
}

void FormatController::increaseLeftIndent(qreal delta)
{
    if (!validateSelection()) {
        return;
    }
    
    // 获取选区内所有段落的当前左缩进，然后增加
    // 这里复用 applySingleParagraphProperty 的模式
    // 或者：直接设置一个增量（需要获取当前值）
    
    // 简化方案：直接设置固定增量（更易实现）
    ParagraphStyle style;
    // 注意：这里需要获取当前值并累加，暂时用 setLeftIndent 演示
    // 完整实现需要获取当前段落的缩进值
    style.setLeftIndent(36.0); 
    applyParagraphStyle(style);
}

void FormatController::decreaseLeftIndent(qreal delta)
{
    ParagraphStyle style;
    style.setLeftIndent(0.0);
    applyParagraphStyle(style);
}

void FormatController::increaseRightIndent(qreal delta)
{
    ParagraphStyle style;
    style.setRightIndent(36.0);
    applyParagraphStyle(style);
}

void FormatController::decreaseRightIndent(qreal delta)
{
    ParagraphStyle style;
    style.setRightIndent(0.0);
    applyParagraphStyle(style);
}
```

---

### 4.3 步骤 3: 在 RibbonBar 添加缩进控件

**文件**: `include/ui/ribbon/RibbonBar.h`  
**文件**: `src/ui/ribbon/RibbonBar.cpp`

#### 4.3.1 在 RibbonBar.h 中添加信号

```cpp
signals:
    // ... 现有信号 ...
    
    // ========== 缩进相关信号 ==========
    void leftIndentChanged(qreal indent);
    void rightIndentChanged(qreal indent);
    void increaseLeftIndent();
    void decreaseLeftIndent();
    void increaseRightIndent();
    void decreaseRightIndent();
```

#### 4.3.2 在 RibbonBar.cpp 中创建控件

```cpp
// 在 createParagraphGroup() 或类似方法中添加
void RibbonBar::createIndentControls()
{
    // 1. 创建增加/减少左缩进按钮
    QAction *increaseLeftIndentAction = new QAction(tr("增加左缩进"), this);
    increaseLeftIndentAction->setIcon(QIcon(":/icons/increase_indent.png"));
    connect(increaseLeftIndentAction, &QAction::triggered, 
            this, &RibbonBar::increaseLeftIndent);
    addAction(increaseLeftIndentAction);
    
    QAction *decreaseLeftIndentAction = new QAction(tr("减少左缩进"), this);
    decreaseLeftIndentAction->setIcon(QIcon(":/icons/decrease_indent.png"));
    connect(decreaseLeftIndentAction, &QAction::triggered, 
            this, &RibbonBar::decreaseLeftIndent);
    addAction(decreaseLeftIndentAction);
    
    // 2. 增加/减少右缩进（可选，常见 Word 中较少有单独的右缩进按钮）
    
    // 3. 精确缩进值输入框（可选）
    // QDoubleSpinBox *leftIndentSpinBox = new QDoubleSpinBox(this);
    // leftIndentSpinBox->setRange(0, 500);
    // connect(leftIndentSpinBox, QOverload<double>::of(&QDoubleSpinBox::valueChanged),
    //         this, [this](double value) { emit leftIndentChanged(value); });
}
```

---

### 4.4 步骤 4: 在 MainWindow 中连接信号槽

**文件**: `src/ui/mainwindow/MainWindow.cpp`

```cpp
// 在 setupConnections() 中添加
void MainWindow::connectIndentSignals()
{
    connect(m_ribbonBar, &RibbonBar::increaseLeftIndent,
            this, [this]() {
        m_formatController->increaseLeftIndent();
    });
    
    connect(m_ribbonBar, &RibbonBar::decreaseLeftIndent,
            this, [this]() {
        m_formatController->decreaseLeftIndent();
    });
    
    connect(m_ribbonBar, &RibbonBar::leftIndentChanged,
            this, [this](qreal indent) {
        m_formatController->setLeftIndent(indent);
    });
    
    connect(m_ribbonBar, &RibbonBar::rightIndentChanged,
            this, [this](qreal indent) {
        m_formatController->setRightIndent(indent);
    });
}
```

---

## 5. 推荐实现顺序

### 阶段 1: 基础渲染（优先级：高）
1. 修改 `TextBlockItem::applyParagraphIndent()` 方法
2. 修改 `TextBlockItem::updateBoundingRect()` 考虑缩进
3. 修改 `TextBlockItem::updateBlock()` 调用缩进方法
4. **测试**: 手动在代码中设置缩进值，验证渲染效果

### 阶段 2: 格式控制器（优先级：高）
1. 在 `FormatController` 中添加缩进方法
2. 实现 `setLeftIndent()` 和 `setRightIndent()`
3. 实现增减缩进的便捷方法

### 阶段 3: UI 控件（优先级：中）
1. 在 `RibbonBar` 中添加缩进按钮
2. 在 `ParagraphDialog` 中添加缩进设置（如果有对话框）
3. 在 `MainWindow` 中连接信号槽

### 阶段 4: 完善和优化（优先级：低）
1. 添加首行缩进（虽然已有，但可优化）
2. 添加悬挂缩进（可选高级功能）
3. 添加缩进预设（如：无缩进、首行缩进2字符等）
4. 支持撤销/重做（已有命令框架，直接复用）

---

## 6. 测试方案

### 6.1 单元测试
- 测试 `ParagraphStyle` 的缩进 getter/setter
- 测试 `TextBlockItem` 的边界矩形计算

### 6.2 集成测试
1. **基础测试**
   - 设置左缩进 36 点（0.5英寸），验证文本向右偏移
   - 设置右缩进 36 点，验证文本宽度减小
   - 同时设置左右缩进，验证效果

2. **自动换行测试**
   - 输入长文本，打开自动换行
   - 设置缩进，验证换行后仍然保持缩进

3. **多段落测试**
   - 创建多个段落
   - 给不同段落设置不同缩进
   - 验证各段落独立显示

4. **边界测试**
   - 缩进为 0（无缩进）
   - 缩进非常大（接近页面宽度）
   - 负缩进（虽然不建议，但需要处理）

---

## 7. 注意事项

### 7.1 性能考虑
- 缩进计算是 O(1) 操作，不会影响性能
- 每次更新块时重新计算缩进是合理的

### 7.2 兼容性
- 缩进数据已在 `ParagraphStyle` 中，文件格式已支持
- 现有文档打开后缩进会正常显示

### 7.3 与其他功能的交互
- **对齐方式**: 缩进和左/右/居中/两端对齐可同时使用
- **首行缩进**: 首行缩进是在左缩进基础上的额外缩进
- **列表**: 列表项通常有特殊的缩进处理（可后续扩展）

---

## 8. 总结

段落左缩进和右缩进功能的实现可以分阶段进行：

1. **第一阶段**: 先让 TextBlockItem 正确渲染缩进（核心）
2. **第二阶段**: 通过 FormatController 提供编程接口
3. **第三阶段**: 在 UI 中添加用户控件

由于项目架构已经非常完善（ParagraphStyle 已支持缩进），实现起来相对容易，主要工作在渲染层（TextBlockItem）的修改。

---

**文档结束**
