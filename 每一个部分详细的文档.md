---

message_count: 2
---

# 可否对每一个部分详细的文档 (2 消息)



# Qt Word 文字处理器详细设计文档

## 目录

1.  app 模块
    
2.  core 模块
    
    -   2.1 document 子模块
        
    -   2.2 commands 子模块
        
    -   2.3 layout 子模块
        
    -   2.4 styles 子模块
        
    -   2.5 utils 子模块
    
3.  editcontrol 模块
    
    -   3.1 cursor 子模块
        
    -   3.2 selection 子模块
        
    -   3.3 handlers 子模块
        
    -   3.4 formatting 子模块
    
4.  graphics 模块
    
    -   4.1 scene 子模块
        
    -   4.2 view 子模块
        
    -   4.3 items 子模块
        
    -   4.4 factory 子模块
    
5.  io 模块
    
    -   5.1 serializers 子模块
        
    -   5.2 exporters 子模块
        
    -   5.3 importers 子模块
    
6.  ui 模块
    
    -   6.1 mainwindow 子模块
        
    -   6.2 ribbon 子模块
        
    -   6.3 dialogs 子模块
        
    -   6.4 widgets 子模块
    
7.  资源与配置
    
8.  测试与插件
    

---

## 1\. app 模块

### 概述

app 模块包含应用程序的入口点、全局对象初始化以及一些全局配置。它负责创建 QApplication 子类（如 Application），设置应用程序元信息（组织名、应用名、版本），并处理主事件循环。

### 核心类

#### `Application` (继承 QApplication)

**职责**

-   初始化应用程序，设置组织名称、应用名称、应用版本等。
    
-   加载和保存全局设置（如最近打开的文件列表、窗口几何状态）。
    
-   处理可能出现的异常，确保程序稳定。
    

**主要方法**

-   `Application(int &argc, char **argv)`：构造函数，调用基类构造函数，设置元信息。
    
-   `bool init()`：初始化应用程序，加载设置，检查许可证（若有）。
    
-   `void loadSettings()`：从 QSettings 加载全局设置。
    
-   `void saveSettings()`：保存全局设置到 QSettings。
    

**设计要点**

-   采用单例模式（通过 QApplication 实例化）。
    
-   全局异常捕获在 main 函数中，而非 Application 内部。
    
-   设置文件格式使用 INI 或系统原生格式。
    

---

## 2\. core 模块

core 模块是文字处理器的核心业务逻辑，包含文档模型、编辑命令、布局引擎、样式管理等。

### 2.1 document 子模块

#### 类图

```

Document (1) ——— (n) Section
Section (1) ——— (n) Block (abstract)
Block ——— ParagraphBlock
Block ——— TableBlock
Block ——— ImageBlock
ParagraphBlock ——— (n) Span
Span ——— (1) CharacterStyle
ParagraphBlock ——— (1) ParagraphStyle
Section ——— (n) Page (运行时生成)

```

#### `Document`

**职责**

-   文档的根容器，包含一个或多个节（Section）。
    
-   管理文档元数据：标题、作者、创建时间、修改时间等。
    
-   持有 QUndoStack，管理所有编辑命令。
    
-   提供信号：`documentChanged()`, `blockAdded(int)`, `blockRemoved(int)`, `layoutChanged()` 等。
    

**属性**

-   `int documentId`：文档标识（可选）。
    
-   `QString title`：文档标题。
    
-   `QString author`：作者。
    
-   `QDateTime created`：创建时间。
    
-   `QDateTime modified`：最后修改时间。
    
-   `QList<Section*> sections`：节列表。
    
-   `QUndoStack* undoStack`：撤销栈。
    

**主要方法**

-   `void setTitle(const QString&)`：设置标题，若变化发出 `documentChanged()`。
    
-   `void addSection(Section*)`：添加节。
    
-   `void insertSection(int index, Section*)`：插入节。
    
-   `void removeSection(int index)`：移除节。
    
-   `int blockCount() const`：所有节的块总数（可缓存）。
    
-   `TextBlock* block(int index)`：按全局索引获取块。
    
-   `QUndoStack* undoStack() const`：获取撤销栈。
    
-   `QString plainText() const`：导出纯文本（用于测试或导出）。
    

**设计要点**

-   使用 QSharedData 实现隐式共享，但 Document 作为根对象通常不复制，因此可以不使用。
    
-   节和块的生命周期由 Document 管理（`QObject` 父子关系）。
    
-   信号应细粒度，以便视图只更新变化部分。
    

#### `Section`

**职责**

-   代表文档中的一个逻辑节（如一章）。
    
-   包含该节内的所有块（Block），以及布局生成的页面（Page）。
    
-   提供分页相关的信息（如起始页码）。
    

**属性**

-   `int sectionNumber`：节编号。
    
-   `QString header`：页眉内容（可选）。
    
-   `QString footer`：页脚内容（可选）。
    
-   `QList<Block*> blocks`：块列表。
    
-   `QList<Page*> pages`：布局后生成的页面列表。
    

**主要方法**

-   `void addBlock(Block*)`：添加块。
    
-   `void insertBlock(int index, Block*)`：插入块。
    
-   `void removeBlock(int index)`：移除块。
    
-   `int pageCount() const`：页面数量。
    
-   `Page* page(int index)`：获取页面。
    
-   `void clearPages()`：清除页面（布局前调用）。
    

**设计要点**

-   页面由布局引擎在布局时动态创建，不持久化。
    
-   节可以有自己的样式（如页眉页脚）。
    

#### `Block` (抽象基类)

**职责**

-   所有内容块的基类。
    
-   定义块的基本属性和接口。
    

**属性**

-   `int blockId`：块标识（可选）。
    
-   `QRectF boundingRect`：块在文档中的边界矩形（布局后设置）。
    
-   `qreal height`：块高度（布局后设置）。
    
-   `int positionInDocument`：块在文档中的全局索引（用于快速定位）。
    

**主要方法**

-   `virtual QRectF boundingRect() const`：获取边界。
    
-   `virtual void setBoundingRect(const QRectF&)`：设置边界。
    
-   `virtual qreal height() const`：获取高度。
    
-   `virtual void setHeight(qreal)`：设置高度。
    
-   `virtual int length() const`：返回块长度（对于文本块为字符数+1；对于其他块为1）。
    
-   `virtual bool isEmpty() const`：是否为空。
    

**派生类**

-   **`ParagraphBlock`**：文本段落。
    
-   **`ImageBlock`**：图片。
    
-   **`TableBlock`**：表格。
    

#### `ParagraphBlock`

**职责**

-   表示一个文本段落，包含多个 Span（文本片段）。
    
-   持有段落样式。
    

**属性**

-   `QList<Span> spans`：文本片段列表。
    
-   `ParagraphStyle paragraphStyle`：段落样式。
    

**主要方法**

-   `int length() const`：返回总字符数（包括段落结束符？一般不包括）。
    
-   `QString text() const`：拼接所有 span 文本。
    
-   `void setText(const QString&)`：用单个 span 设置文本（清空原有 span）。
    
-   `void insert(int position, const QString& text, const CharacterStyle& style)`：插入文本。
    
-   `void remove(int position, int length)`：删除文本。
    
-   `Span span(int index) const`：获取指定索引的 span。
    
-   `int spanCount() const`：span 数量。
    
-   `void addSpan(const Span&)`：添加 span。
    
-   `void setParagraphStyle(const ParagraphStyle&)`：设置段落样式。
    

**设计要点**

-   插入/删除操作会自动合并/拆分 span 以保持样式一致。
    
-   提供高效的文本操作，避免频繁复制。
    

#### `Span`

**职责**

-   表示一段具有相同字符样式的文本。
    

**属性**

-   `QString text`：文本内容。
    
-   `CharacterStyle style`：字符样式。
    

**主要方法**

-   `Span()`：默认构造。
    
-   `Span(const QString& text)`：使用默认样式。
    
-   `Span(const QString& text, const CharacterStyle& style)`：指定样式。
    
-   `int length() const`：返回文本长度。
    
-   `Span split(int position)`：在 position 处分割，返回后半部分，当前对象变为前半部分。
    
-   `void append(const QString& text)`：追加文本。
    
-   `void insert(int position, const QString& text)`：插入文本。
    
-   `void remove(int position, int length)`：删除文本。
    

**设计要点**

-   split 方法用于插入时需保持样式一致。
    

#### `CharacterStyle`

**职责**

-   封装字符级别的样式属性。
    

**属性**

-   `QFont font`：字体。
    
-   `QColor textColor`：文字颜色。
    
-   `QColor backgroundColor`：背景颜色。
    
-   `qreal letterSpacing`：字间距。
    

**主要方法**

-   各种 setter/getter。
    
-   `bool operator==(const CharacterStyle&) const`：比较是否相等。
    

**设计要点**

-   使用 QFont 统一管理字体属性，可通过 `QFont::bold()` 等访问。
    
-   使用隐式共享优化复制。
    

#### `ParagraphStyle`

**职责**

-   封装段落级别的样式属性。
    

**属性**

-   `ParagraphAlignment alignment`：对齐方式（左、中、右、两端）。
    
-   `int lineHeight`：行高（百分比）。
    
-   `qreal firstLineIndent`：首行缩进。
    
-   `qreal leftIndent`：左缩进。
    
-   `qreal rightIndent`：右缩进。
    
-   `qreal spaceBefore`：段前间距。
    
-   `qreal spaceAfter`：段后间距。
    

**主要方法**

-   各种 setter/getter。
    
-   `bool operator==(const ParagraphStyle&) const`。
    

#### `ImageBlock`

**职责**

-   表示一个图片块。
    

**属性**

-   `QImage image`：图片数据。
    
-   `QSizeF size`：显示尺寸（可以缩放）。
    
-   `QString caption`：图片标题。
    

**主要方法**

-   `void setImage(const QImage&)`：设置图片。
    
-   `void setSize(const QSizeF&)`：设置显示尺寸。
    
-   `void setCaption(const QString&)`：设置标题。
    

**设计要点**

-   图片数据直接存储在块中，也可存储文件路径（需处理相对/绝对路径）。
    

#### `TableBlock`

**职责**

-   表示一个表格块。
    

**属性**

-   `int rows`：行数。
    
-   `int columns`：列数。
    
-   `QVector<QVector<Cell>> cells`：单元格矩阵。
    
-   `qreal rowHeight`：默认行高。
    
-   `qreal colWidth`：默认列宽。
    

**内部类 Cell**

-   内容可为 ParagraphBlock 或 ImageBlock 等。
    
-   合并单元格信息。
    

**主要方法**

-   `void setCell(int row, int col, Block* content)`：设置单元格内容。
    
-   `Block* cellContent(int row, int col)`：获取单元格内容。
    
-   `void mergeCells(int row, int col, int rowSpan, int colSpan)`：合并单元格。
    

**设计要点**

-   表格布局较为复杂，需考虑合并单元格、边框样式等。
    

#### `Page` (运行时生成)

**职责**

-   代表一个物理页面，由布局引擎创建。
    
-   包含页面上的块列表（这些块实际属于 Section）。
    

**属性**

-   `int pageNumber`：页码。
    
-   `QRectF pageRect`：页面矩形（通常为 A4 尺寸）。
    
-   `QRectF contentRect`：内容区域（除去页边距）。
    
-   `QList<Block*> blocks`：该页上的块列表（引用，非拥有）。
    

**主要方法**

-   `void addBlock(Block*)`：添加块。
    
-   `void clearBlocks()`：清空块。
    
-   `bool isEmpty() const`：是否为空页。
    

**设计要点**

-   Page 不拥有块，仅用于视图显示。块的生命周期由 Section 管理。
    
-   布局引擎填充 Page 中的块列表，并设置每个块的 boundingRect（相对于页面原点）。
    

### 2.2 commands 子模块

#### 概述

commands 模块基于 Qt 的 QUndoCommand 框架，实现所有可撤销的编辑操作。

#### `EditCommand` (抽象基类，继承 QUndoCommand)

**职责**

-   所有编辑命令的基类，持有文档指针。
    

**属性**

-   `Document* m_document`：操作的文档。
    

**主要方法**

-   `explicit EditCommand(Document* document, const QString& text = QString())`：构造函数。
    
-   `Document* document() const`：获取文档指针。
    
-   `virtual void undo() override`：撤销操作。
    
-   `virtual void redo() override`：重做操作。
    

#### `InsertTextCommand`

**职责**

-   在指定块的指定位置插入文本。
    

**属性**

-   `int m_blockIndex`：块索引。
    
-   `int m_position`：插入位置。
    
-   `QString m_text`：插入的文本。
    
-   `CharacterStyle m_style`：使用的字符样式。
    

**实现**

-   `redo()`：调用 `ParagraphBlock::insert`。
    
-   `undo()`：调用 `ParagraphBlock::remove`。
    

#### `RemoveTextCommand`

**职责**

-   删除指定块的指定范围内的文本。
    

**属性**

-   `int m_blockIndex`：块索引。
    
-   `int m_position`：删除起始位置。
    
-   `int m_length`：删除长度。
    
-   `QString m_removedText`：被删除的文本（用于撤销）。
    
-   `QList<Span> m_removedSpans`：被删除的完整 span 结构（用于精确撤销）。
    

**实现**

-   `redo()`：记录被删除的完整 span 结构和文本，然后删除。
    
-   `undo()`：重新插入被删除的 span 结构。
    

**注意**  
为了正确撤销，需要保存被删除部分的完整 span 结构，而不仅仅是文本。

#### `InsertBlockCommand`

**职责**

-   在文档中插入新块。
    

**属性**

-   `int m_index`：插入位置（-1 表示追加）。
    
-   `Block* m_block`：要插入的块（命令拥有所有权）。
    

**实现**

-   `redo()`：调用 `Document::insertBlock`。
    
-   `undo()`：调用 `Document::removeBlock`，并回收 m\_block（但 m\_block 仍保留以便重做）。
    

#### `RemoveBlockCommand`

**职责**

-   删除指定块。
    

**属性**

-   `int m_index`。
    
-   `Block* m_removedBlock`：保存被删除的块（用于撤销）。
    

**实现**

-   `redo()`：从文档移除块，保存指针。
    
-   `undo()`：重新插入块。
    

#### `SetCharacterStyleCommand`

**职责**

-   对选定区域设置字符样式。
    

**属性**

-   `SelectionRange m_range`：选区范围。
    
-   `CharacterStyle m_newStyle`：新样式。
    
-   `QList<Span> m_oldSpans`：旧样式（用于撤销，需保存每个受影响块的原始 spans）。
    

**实现**

-   可能需要处理跨块选区，需在 redo 前保存所有受影响块的原始 spans。
    

#### `SetParagraphStyleCommand`

**职责**

-   对选定段落设置段落样式。
    

**属性**

-   `QList<int> m_blockIndices`：受影响的块索引。
    
-   `ParagraphStyle m_newStyle`。
    
-   `QList<ParagraphStyle> m_oldStyles`：旧样式列表。
    

**实现**

-   类似字符样式命令。
    

### 2.3 layout 子模块

#### `LayoutEngine`

**职责**

-   负责将文档内容分页，计算每个块的位置和大小。
    
-   响应文档变化，执行增量布局。
    

**属性**

-   `Document* m_document`：待布局的文档。
    
-   `QHash<Block*, qreal> m_cachedHeights`：块高度缓存（可选）。
    

**主要方法**

-   `void setDocument(Document* document)`：设置要布局的文档。
    
-   `Document* document() const`：获取当前文档。
    
-   `void layout()`：全量布局。
    
-   `void layoutFrom(int blockIndex)`：从指定块开始增量布局。
    
-   `qreal calculateBlockHeight(Block* block, qreal maxWidth)`：测量块高度。
    

**布局算法**

1.  确定页面尺寸和边距。
    
2.  遍历节和块：
    
    -   对于段落块，根据最大宽度、字体、行距等计算所需高度。
        
    -   尝试将块放入当前页面，若放不下则新建页面。
        
    -   记录每个块在页面中的位置（相对于页面原点）。
    
3.  布局完成后，更新每个块的 boundingRect，并发出 `layoutChanged()` 信号。
    

**设计要点**

-   高度计算需考虑字体度量、行高、段间距等。
    
-   支持分页时断块（如段落跨页），需将段落拆分为多个部分？在 Word 中，段落可以跨页，但块作为整体通常不拆分。如果需要精确跨页断行，可能需要更复杂的文本布局，此时可使用 QTextDocument 进行段落内断行。
    
-   增量布局：当插入/删除文本时，只需重新布局从该块开始到页末或节末的块。
    

#### `PageBuilder`

**职责**

-   辅助类，用于在布局过程中将块分配到页面，管理当前页的剩余空间。
    

**属性**

-   `qreal pageWidth, pageHeight`：页面尺寸。
    
-   `qreal margin`：页边距。
    
-   `qreal contentWidth, contentHeight`：内容区域。
    
-   `qreal currentY`：当前页已用高度。
    
-   `QList<Block*> currentPageBlocks`：当前页的块列表。
    

**主要方法**

-   `bool tryAddBlock(Block* block)`：尝试将块加入当前页，若成功返回 true，否则 false。
    
-   `Page* finishPage()`：完成当前页，返回 Page 对象。
    
-   `void reset()`：重置为新建页。
    

**设计要点**

-   与 LayoutEngine 协作，简化布局逻辑。
    

### 2.4 styles 子模块

#### `StyleManager`

**职责**

-   管理文档中的命名样式（类似于 Word 的样式库）。
    
-   提供样式的创建、修改、删除、应用。
    

**属性**

-   `QHash<QString, CharacterStyle> m_characterStyles`：字符样式字典。
    
-   `QHash<QString, ParagraphStyle> m_paragraphStyles`：段落样式字典。
    
-   `Document* m_document`：所属文档（可选）。
    

**主要方法**

-   `void addCharacterStyle(const QString& name, const CharacterStyle& style)`。
    
-   `CharacterStyle characterStyle(const QString& name) const`。
    
-   `void applyCharacterStyle(SelectionRange range, const QString& styleName)`：应用字符样式到选区。
    
-   `void applyParagraphStyle(const QList<int>& blockIndices, const QString& styleName)`。
    

**设计要点**

-   样式可基于其他样式继承（实现样式继承需要额外设计）。
    
-   样式变化时，所有应用该样式的区域应更新。
    

### 2.5 utils 子模块

#### 工具类

-   **`FontUtils`**：字体相关工具，如 pt 与 px 转换，字体度量计算。
    
-   **`UnitConversion`**：单位转换（英寸、厘米、点、像素）。
    
-   **`TextUtils`**：文本处理，如 HTML 转义/反转义、自动检测编码。
    
-   **`Constants`**：全局常量（默认字体大小、页面尺寸、缩放范围等）。
    

---

## 3\. editcontrol 模块

### 3.1 cursor 子模块

#### `CursorPosition` (结构体)

**职责**

-   表示光标在文档中的位置。
    

**属性**

-   `int blockIndex`：块索引。
    
-   `int offset`：块内字符偏移（0 到块长度之间，不包括换行符）。
    

**主要方法**

-   `bool operator==(const CursorPosition& other) const`：比较两个位置是否相等。
    
-   `bool operator!=(const CursorPosition& other) const`：比较两个位置是否不等。
    

#### `Cursor` (继承 QObject)

**职责**

-   管理光标位置，提供移动、插入、删除等操作（实际调用命令）。
    
-   发出 `positionChanged()` 信号。
    

**属性**

-   `CursorPosition m_position`：当前光标位置。
    
-   `Document* m_document`：关联的文档。
    

**主要方法**

-   `CursorPosition position() const`：获取当前位置。
    
-   `void setPosition(int blockIndex, int offset)`：设置位置到指定块和偏移。
    
-   `void setPosition(const CursorPosition& pos)`：设置位置。
    
-   `void moveLeft()`，`moveRight()`，`moveUp()`，`moveDown()`：移动光标（需考虑跨块）。
    
-   `void moveToStartOfLine()`，`moveToEndOfLine()`：移动到行首/行尾。
    
-   `void moveToStartOfDocument()`，`moveToEndOfDocument()`：移动到文档首/尾。
    
-   `void insertText(const QString& text, const CharacterStyle& style)`：在当前光标位置插入文本（创建命令并推入栈）。
    
-   `void deletePreviousChar()`：删除光标前一个字符。
    
-   `void deleteNextChar()`：删除光标后一个字符。
    

**设计要点**

-   移动操作不修改文档，只修改位置。
    
-   插入/删除操作通过命令实现，确保可撤销。
    

### 3.2 selection 子模块

#### `SelectionRange` (结构体)

**职责**

-   表示一个连续的选区。
    

**属性**

-   `int startBlock, startOffset`：起始位置。
    
-   `int endBlock, endOffset`：结束位置。
    

**方法**

-   `bool isEmpty() const`：起始等于结束。
    
-   `void normalize()`：确保 start 小于等于 end。
    

#### `Selection` (继承 QObject)

**职责**

-   管理选区，支持单段和多段选区。
    
-   发出 `selectionChanged()` 信号。
    

**属性**

-   `QList<SelectionRange> m_ranges`：选区列表（支持多段）。
    
-   `Document* m_document`。
    

**主要方法**

-   `void setRange(const SelectionRange& range)`：设为单段选区。
    
-   `void addRange(const SelectionRange& range)`：添加一段（需处理重叠）。
    
-   `void clear()`：清空。
    
-   `void extend(int block, int offset)`：扩展当前选区到指定位置（类似 Shift+点击）。
    
-   `QList<SelectionRange> ranges() const`。
    
-   `QString selectedText() const`：获取选中的纯文本。
    
-   `QList<Span> selectedSpans() const`：获取带样式的 span 列表。
    

**设计要点**

-   支持多段选区需要 UI 能够绘制多个矩形。
    
-   选区操作需考虑块边界。
    

### 3.3 handlers 子模块

#### `EditEventHandler`

**职责**

-   接收来自视图的输入事件（键盘、鼠标、输入法），根据当前光标和选区状态，调用相应的编辑操作。
    
-   不直接修改视图，只修改模型或更新光标/选区。
    

**属性**

-   `Document* m_document`。
    
-   `Cursor* m_cursor`。
    
-   `Selection* m_selection`。
    
-   `QGraphicsView* m_view`（仅用于坐标转换，可选）。
    

**主要方法**

-   `bool handleKeyPress(QKeyEvent* event)`：处理按键。
    
-   `bool handleMousePress(QMouseEvent* event)`：处理鼠标按下。
    
-   `bool handleMouseMove(QMouseEvent* event)`：处理鼠标移动（用于扩展选区）。
    
-   `bool handleMouseRelease(QMouseEvent* event)`。
    
-   `bool handleInputMethod(QInputMethodEvent* event)`：处理输入法。
    

**处理逻辑示例**

-   键入字符：在光标位置插入文本。
    
-   Backspace：删除光标前一个字符。
    
-   Enter：在光标处分割段落（或插入新块）。
    
-   鼠标点击：移动光标（若未按 Shift）或扩展选区（若按 Shift）。
    
-   鼠标拖动：更新选区。
    

### 3.4 formatting 子模块

#### `FormatController`

**职责**

-   提供应用字符样式和段落样式的高级接口。
    
-   内部创建样式命令并推入撤销栈。
    

**属性**

-   `Document* m_document`。
    
-   `Selection* m_selection`（可选，若未提供则应用于整个文档或当前块）。
    

**主要方法**

-   `void applyCharacterStyle(const CharacterStyle& style)`：应用到当前选区（若无选区，则设置当前光标处的字符样式）。
    
-   `void applyParagraphStyle(const ParagraphStyle& style)`：应用到当前光标所在的段落或选区覆盖的段落。
    
-   `void setFont(const QFont& font)`，`setFontSize(int)`，`setBold(bool)` 等便捷方法。
    

**设计要点**

-   若选区为空，设置字符样式应影响后续输入的字符（即当前光标处的样式）。
    
-   可能需要与 `StyleManager` 协作，应用命名样式。
    

---

## 4\. graphics 模块

### 4.1 scene 子模块

#### `DocumentScene` (继承 QGraphicsScene)

**职责**

-   管理所有图形项，根据文档数据构建场景。
    
-   维护从 Block 到 BaseBlockItem 的映射，响应文档信号进行增量更新。
    
-   提供更新光标和选区的方法。
    

**属性**

-   `CursorItem* m_cursorItem`：光标图形项。
    
-   `SelectionItem* m_selectionItem`：选区图形项。
    
-   `QHash<Block*, BaseBlockItem*> m_blockItems`：块到图形项的映射。
    
-   `Document* m_document`：当前文档（仅用于监听信号，不拥有）。
    

**主要方法**

-   `void setDocument(Document* document)`：设置当前文档。
    
-   `Document* document() const`：获取当前文档。
    
-   `void rebuildFromDocument()`：全量重建场景。
    
-   `void updateCursor(const QPointF& pos, qreal height)`：更新光标位置。
    
-   `void updateSelection(const QList<QRectF>& rects)`：更新选区矩形列表。
    
-   `void clearSelection()`：清除选区。
    
-   槽函数：`onBlockAdded(int globalIndex)`, `onBlockRemoved(int globalIndex)`, `onLayoutChanged()`。
    

**设计要点**

-   通过信号槽监听文档变化，实现增量更新。
    
-   创建 PageItem 时，使用 BlockItemFactory 创建块项。
    
-   页面和块的父子关系自动管理内存。
    

### 4.2 view 子模块

#### `DocumentView` (继承 QGraphicsView)

**职责**

-   负责文档的缩放、滚动、事件转发。
    
-   将用户输入事件通过信号转发给业务层。
    

**属性**

-   `DocumentScene* m_scene`。
    
-   `qreal m_zoom`。
    

**主要方法**

-   `void setZoom(qreal zoom)`：设置缩放比例。
    
-   `void zoomIn()`, `zoomOut()`, `zoomToFit()`。
    
-   信号：`keyPressed(QKeyEvent*)`, `mousePressed(QMouseEvent*)`, `mouseMoved(QMouseEvent*)`, `mouseReleased(QMouseEvent*)`, `inputMethodReceived(QInputMethodEvent*)`。
    
-   重写事件处理函数，先发射信号再调用基类。
    

**设计要点**

-   不处理任何业务逻辑，仅负责视图变换和事件传递。
    
-   缩放时使用 `scale()` 实现。
    

### 4.3 items 子模块

#### `BaseBlockItem` (继承 QGraphicsRectItem)

**职责**

-   所有块图形项的基类。
    
-   持有对应的 Block 指针，提供纯虚函数 `updateBlock()`。
    

**属性**

-   `Block* m_block`。
    

**主要方法**

-   `virtual void updateBlock() = 0`。
    

#### `TextBlockItem` (继承 BaseBlockItem)

**职责**

-   绘制文本段落块，内部使用 `QGraphicsTextItem` 实现富文本渲染。
    

**属性**

-   `QGraphicsTextItem* m_textItem`。
    

**主要方法**

-   `void updateBlock()` override：从 Block 读取样式和文本，设置到 QGraphicsTextItem 中，并调整位置。
    
-   重写 `paint` 可选择绘制背景边框。
    

**设计要点**

-   使用 `QGraphicsTextItem::setTextWidth` 实现自动换行。
    
-   将文本位置设置在块内边距处。
    

#### `ImageBlockItem` (继承 BaseBlockItem)

**职责**

-   绘制图片块，使用 `QGraphicsPixmapItem`。
    

**属性**

-   `QGraphicsPixmapItem* m_pixmapItem`。
    

**主要方法**

-   `void updateBlock()`：加载图片，缩放至合适大小。
    

#### `TableBlockItem` (继承 BaseBlockItem)

**职责**

-   绘制表格，可使用 `QGraphicsGridLayout` 或手动绘制线条。
    

**设计要点**

-   较复杂，可能需要组合多个子项（单元格、边框）。
    

#### `PageItem` (继承 QGraphicsRectItem)

**职责**

-   绘制页面背景（白色、阴影、边框）。
    
-   作为页面内所有块项的父项。
    

**属性**

-   `Page* m_page`（引用页面数据，但页面内块由 BlockItemFactory 创建）。
    

**主要方法**

-   `void updatePage()`：当页面布局变化时，删除所有子项并重建。
    
-   重写 `paint` 绘制页面背景。
    

**设计要点**

-   不直接管理块项，通过 Qt 父子关系自动管理。
    
-   页面内块项的位置相对于页面原点。
    

#### `CursorItem` (继承 QGraphicsLineItem)

**职责**

-   绘制闪烁的光标（竖线）。
    
-   提供闪烁控制。
    

**属性**

-   `QTimer m_blinkTimer`。
    
-   `bool m_visible`。
    

**主要方法**

-   `void setPosition(const QPointF& pos, qreal height)`：设置线条起点和长度。
    
-   `void startBlink()`, `stopBlink()`。
    
-   `void toggleBlink()` 槽。
    

#### `SelectionItem` (继承 QGraphicsItem)

**职责**

-   绘制选区（多个矩形）。
    

**属性**

-   `QList<QRectF> m_rects`。
    

**主要方法**

-   `void setRects(const QList<QRectF>& rects)`。
    
-   `void clear()`。
    
-   `QRectF boundingRect() const override`。
    
-   `void paint(...) override`：绘制所有矩形。
    

### 4.4 factory 子模块

#### `BlockItemFactory`

**职责**

-   根据块类型创建对应的图形项。
    

**静态方法**

-   `static BaseBlockItem* createItem(Block* block, QGraphicsItem* parent = nullptr)`。
    

**实现**

-   使用 dynamic_cast 或枚举判断块类型，返回相应 Item 实例。
    

**设计要点**

-   新增块类型只需在此添加分支，无需修改其他代码。
    

---

## 5\. io 模块

### 5.1 serializers 子模块

#### `XmlSerializer`

**职责**

-   将 Document 对象序列化为自定义 XML 格式（.qtdoc），并从 XML 反序列化。
    

**主要方法**

-   `bool serialize(Document* doc, const QString& filePath)`。
    
-   `Document* deserialize(const QString& filePath)`。
    
-   `QString lastError() const`。
    

**XML 结构示例**

```
<Document version="1.0" title="..." author="...">
  <Section number="0">
    <TextBlock id="0">
      <ParagraphStyle alignment="0" lineHeight="150" .../>
      <Span text="Hello ">
        <CharacterStyle font="..." color="#000000"/>
      </Span>
      <Span text="world">
        <CharacterStyle font="..." bold="true"/>
      </Span>
    </TextBlock>
    <ImageBlock id="1">
      <ImageData>...base64...</ImageData>
      <Size width="100" height="100"/>
    </ImageBlock>
  </Section>
</Document>
```

**设计要点**

-   使用 QDomDocument 处理 XML。
    
-   对于图片等二进制数据，可使用 Base64 编码。
    

#### `BinarySerializer` (可选)

**职责**

-   提供紧凑的二进制格式，加快读写速度。
    

**设计要点**

-   自定义二进制协议，需考虑版本兼容性。
    

### 5.2 exporters 子模块

#### `PdfExporter`

**职责**

-   将文档导出为 PDF 文件。
    

**主要方法**

-   `bool exportToPdf(Document* doc, const QString& filePath)`。
    

**实现**

-   使用 QPrinter 和 QPainter，将文档渲染到 PDF。
    
-   可通过 QTextDocument 或直接使用 QPainter 绘制页面。
    

**设计要点**

-   需考虑分页、页眉页脚。
    
-   可利用已有的布局引擎计算页面布局。
    

#### `HtmlExporter`

**职责**

-   将文档导出为 HTML 文件，保留基本格式。
    

**主要方法**

-   `bool exportToHtml(Document* doc, const QString& filePath)`。
    

**实现**

-   遍历文档，生成 HTML 标签（`<p>`、`<span style="...">`、`<img>`、`<table>`）。
    
-   将字符样式转换为 CSS。
    

#### `PlainTextExporter`

**职责**

-   导出纯文本，忽略样式。
    

**主要方法**

-   `bool exportToPlainText(Document* doc, const QString& filePath)`。
    

**实现**

-   调用 `Document::plainText()` 写入文件。
    

### 5.3 importers 子模块

#### `DocxImporter`

**职责**

-   解析 Microsoft Word 的 .docx 格式，转换为 Document 对象。
    

**实现**

-   .docx 实质是 ZIP 包，需解压并解析其中的 XML 文件（document.xml, styles.xml 等）。
    
-   使用 QZipReader 或 libzip。
    
-   将 Office 样式映射到本地样式。
    

#### `TxtImporter`

**职责**

-   导入纯文本文件，自动检测编码。
    

**主要方法**

-   `Document* importFromTxt(const QString& filePath)`。
    

**实现**

-   使用 QTextStream 读取，尝试不同编码。
    
-   将每行作为单独的段落块（或根据换行符）。
    

---

## 5\. io 模块

### 5.1 serializers 子模块

#### `XmlSerializer`

**职责**

-   将 Document 对象序列化为自定义 XML 格式（.qtdoc），并从 XML 反序列化。
    

**主要方法**

-   `bool serialize(Document* doc, const QString& filePath)`。
    
-   `Document* deserialize(const QString& filePath)`。
    
-   `QString lastError() const`。
    

**XML 结构示例**

```

<Document version="1.0" title="..." author="...">
  <Section number="0">
    <TextBlock id="0">
      <ParagraphStyle alignment="0" lineHeight="150" .../>
      <Span text="Hello ">
        <CharacterStyle font="..." color="#000000"/>
      </Span>
      <Span text="world">
        <CharacterStyle font="..." bold="true"/>
      </Span>
    </TextBlock>
    <ImageBlock id="1">
      <ImageData>...base64...</ImageData>
      <Size width="100" height="100"/>
    </ImageBlock>
  </Section>
</Document>

```

**设计要点**

-   使用 QDomDocument 处理 XML。
    
-   对于图片等二进制数据，可使用 Base64 编码。
    

#### `BinarySerializer` (可选)

**职责**

-   提供紧凑的二进制格式，加快读写速度。
    

**设计要点**

-   自定义二进制协议，需考虑版本兼容性。
    

### 5.2 exporters 子模块

#### `PdfExporter`

**职责**

-   将文档导出为 PDF 文件。
    

**主要方法**

-   `bool exportToPdf(Document* doc, const QString& filePath)`。
    

**实现**

-   使用 QPrinter 和 QPainter，将文档渲染到 PDF。
    
-   可通过 QTextDocument 或直接使用 QPainter 绘制页面。
    

**设计要点**

-   需考虑分页、页眉页脚。
    
-   可利用已有的布局引擎计算页面布局。
    

#### `HtmlExporter`

**职责**

-   将文档导出为 HTML 文件，保留基本格式。
    

**主要方法**

-   `bool exportToHtml(Document* doc, const QString& filePath)`。
    

**实现**

-   遍历文档，生成 HTML 标签（`<p>`、`<span style="...">`、`<img>`、`<table>`）。
    
-   将字符样式转换为 CSS。
    

#### `PlainTextExporter`

**职责**

-   导出纯文本，忽略样式。
    

**主要方法**

-   `bool exportToPlainText(Document* doc, const QString& filePath)`。
    

**实现**

-   调用 `Document::plainText()` 写入文件。
    

### 5.3 importers 子模块

#### `DocxImporter`

**职责**

-   解析 Microsoft Word 的 .docx 格式，转换为 Document 对象。
    

**实现**

-   .docx 实质是 ZIP 包，需解压并解析其中的 XML 文件（document.xml, styles.xml 等）。
    
-   使用 QZipReader 或 libzip。
    
-   将 Office 样式映射到本地样式。
    

#### `TxtImporter`

**职责**

-   导入纯文本文件，自动检测编码。
    

**主要方法**

-   `Document* importFromTxt(const QString& filePath)`。
    

**实现**

-   使用 QTextStream 读取，尝试不同编码。
    
-   将每行作为单独的段落块（或根据换行符）。
    

---

## 7\. ui 模块

### 7.1 mainwindow 子模块

#### `MainWindow` (继承 QMainWindow)

**职责**

-   应用程序主窗口，集成菜单、工具栏、状态栏和中央视图。
    
-   管理文档对象、视图场景、编辑控制器。
    
-   响应用户操作（新建、打开、保存、编辑命令等）。
    

**属性**

-   `Document* m_document`：当前文档。
    
-   `DocumentView* m_view`。
    
-   `DocumentScene* m_scene`。
    
-   `Cursor* m_cursor`。
    
-   `Selection* m_selection`。
    
-   `EditEventHandler* m_editEventHandler`。
    
-   `FormatToolBar* m_formatToolBar`。
    
-   `QString m_currentFile`。
    
-   `bool m_isModified`。
    

**主要方法**

-   `void setupUi()`：创建菜单、工具栏、状态栏。
    
-   `void createActions()`：创建 QAction。
    
-   `void newDocument()`, `openDocument()`, `saveDocument()`, `saveAsDocument()`。
    
-   `void undo()`, `redo()`, `cut()`, `copy()`, `paste()`。
    
-   `void zoomIn()`, `zoomOut()`, `zoomToFit()`。
    
-   `void about()`。
    
-   `void closeEvent(QCloseEvent* event)`：检查是否需要保存。
    
-   `bool maybeSave()`：询问保存。
    

**设计要点**

-   监听文档的 undoStack 的 canUndo/canRedo 变化，更新菜单项状态。
    
-   光标/选区变化时，更新状态栏显示（如行号、列号）。
    

### 7.2 ribbon 子模块

#### `RibbonBar` (继承 QTabWidget) 或使用第三方库

**职责**

-   提供类似 Microsoft Office 的 Ribbon 界面，包含多个选项卡和组。
    

**主要方法**

-   `void addTab(const QString& title)`：添加选项卡。
    
-   `void addGroup(const QString& groupName)`：在当前选项卡添加组。
    
-   `void addAction(QAction* action)`：将动作添加到组。
    

**设计要点**

-   可考虑使用 QtitanRibbon 等商业控件，或自行实现简单的类似界面。
    

### 7.3 dialogs 子模块

#### `FontDialog`

**职责**

-   设置字符样式，封装 QFontDialog，并添加颜色选择等。
    

**方法**

-   `static CharacterStyle getStyle(CharacterStyle initial, QWidget* parent)`。
    

#### `ParagraphDialog`

**职责**

-   设置段落样式（缩进、间距、对齐）。
    

**方法**

-   `static ParagraphStyle getStyle(ParagraphStyle initial, QWidget* parent)`。
    

#### `PageSetupDialog`

**职责**

-   设置页面尺寸、边距、方向。
    

**方法**

-   `static PageSetup getPageSetup(PageSetup initial, QWidget* parent)`。
    

#### `InsertImageDialog`

**职责**

-   选择图片文件，并可设置缩放选项。
    

**方法**

-   `static QString getImagePath(QWidget* parent)`。
    

### 7.4 widgets 子模块

#### `FormatToolBar` (继承 QToolBar)

**职责**

-   提供格式设置的工具栏（字体、字号、粗体、斜体、下划线、对齐等）。
    
-   包含 QFontComboBox、QSpinBox 和动作按钮。
    

**属性**

-   `QFontComboBox* m_fontComboBox`。
    
-   `QSpinBox* m_fontSizeSpinBox`。
    
-   `QDoubleSpinBox* m_letterSpacingSpinBox`。
    
-   `QAction* m_boldAction`, `m_italicAction`, `m_underlineAction`。
    
-   `QAction* m_alignLeftAction`, `m_alignCenterAction`, `m_alignRightAction`, `m_alignJustifyAction`。
    

**主要方法**

-   `void updateFromCurrentStyle()`：根据光标处的样式更新控件状态。
    

#### `Ruler` (继承 QWidget)

**职责**

-   显示水平标尺，标记页边距、段落缩进、制表位。
    
-   支持拖动缩进标记和制表位。
    

**属性**

-   `DocumentView* m_view`（用于坐标转换）。
    
-   `qreal m_leftMargin`, `m_rightMargin`。
    
-   `qreal m_firstLineIndent`, `m_leftIndent`。
    
-   `QList<qreal> m_tabStops`。
    

**主要方法**

-   `void paintEvent()`：绘制标尺。
    
-   `void mousePressEvent()`：处理点击，添加/删除制表位。
    
-   `void mouseMoveEvent()`：拖动缩进标记。
    

---

## 7\. 资源与配置

### 资源文件

-   **icons.qrc**：包含工具栏图标、菜单图标等。
    
-   **styles.qss**：Qt 样式表，定义应用程序外观（可支持多套主题）。
    
-   **translations**：多语言翻译文件（.ts/.qm）。
    

### 全局配置

-   使用 `QSettings` 存储用户配置（最近打开文件、窗口位置、默认字体等）。
    
-   在 `Application::loadSettings()` 和 `saveSettings()` 中处理。
    

---

## 8\. 测试与插件

### 单元测试

-   使用 Google Test 框架，对 core 模块的关键类进行单元测试。
    
-   测试命令的正确性、撤销/重做功能、布局引擎的准确性。
    

### 插件系统（可选）

-   定义插件接口（如 `BlockPlugin`、`ImporterPlugin`）。
    
-   使用 `QPluginLoader` 动态加载插件。
    
-   插件可注册新的块类型、导入器、导出器。
    

---

以上是 Qt Word 文字处理器每个模块的详细设计文档。该文档为开发团队提供了清晰的指导，涵盖了所有核心类的职责、属性和方法，以及模块间的协作关系。开发过程中可根据实际需求调整，但应保持整体架构的一致性。

---


*由 [NousSave Ai Chat Exporter](https://www.noussave.com) 生成 | deepseek | 2026/2/17*
